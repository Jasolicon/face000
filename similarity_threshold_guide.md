# 相似度阈值设置指南

## 什么是相似度阈值？

相似度阈值用于判断两个人脸特征是否匹配。只有相似度分数**大于等于**阈值的匹配才会被接受。

## 相似度计算方式

系统使用**余弦相似度**计算特征向量的相似性：
- 相似度范围：**0.0 - 1.0**
- **0.0** = 完全不相似
- **1.0** = 完全相同
- 值越大，表示两个人脸越相似

## 阈值设置建议

### 1. 宽松阈值 (0.5 - 0.6)
**适用场景：**
- 测试和调试阶段
- 图像质量较差（模糊、光照不足）
- 需要更高的召回率（不漏识别）

**特点：**
- ✅ 容易匹配到人脸
- ⚠️ 可能产生误识别（将不同人识别为同一人）

**推荐值：** `0.55` 或 `0.6`

### 2. 中等阈值 (0.6 - 0.7) ⭐ **推荐**
**适用场景：**
- 一般的人脸识别应用
- 标准质量的图像
- 平衡准确率和召回率

**特点：**
- ✅ 准确率和召回率平衡
- ✅ 适合大多数应用场景

**推荐值：** `0.65` 或 `0.7`

### 3. 严格阈值 (0.7 - 0.8)
**适用场景：**
- 高精度要求
- 图像质量很好（清晰、光照充足）
- 需要减少误识别

**特点：**
- ✅ 准确率高，误识别少
- ⚠️ 可能漏识别（将同一人识别为不同人）

**推荐值：** `0.75` 或 `0.8`

### 4. 非常严格阈值 (0.8+)
**适用场景：**
- 极高精度要求
- 高质量图像
- 可以接受较高的漏识别率

**特点：**
- ✅ 几乎不会误识别
- ⚠️ 漏识别率较高

**推荐值：** `0.85` 或 `0.9`

## 如何设置阈值

### 方法1: 在代码中设置

在 `test_file2.py` 的 `main()` 函数中：

```python
# 相似度阈值设置
similarity_threshold = 0.65  # 根据需求调整

annotated_image, results = process_video_frame(
    video_path=video_path,
    features_dir=features_dir,
    output_path=output_path,
    similarity_threshold=similarity_threshold  # 传入阈值
)
```

### 方法2: 在函数调用时设置

```python
# 直接调用函数时指定阈值
results = process_video_frame(
    video_path='video.mp4',
    similarity_threshold=0.7  # 设置阈值
)
```

### 方法3: 在 FaceMatcher 初始化时设置

```python
from feature_matcher import FaceMatcher
from feature_manager import FeatureManager

feature_manager = FeatureManager(storage_dir='features')
face_matcher = FaceMatcher(
    feature_manager=feature_manager,
    similarity_threshold=0.7  # 设置阈值
)
```

## 阈值调优建议

### 1. 从推荐值开始
- 建议从 `0.65` 或 `0.7` 开始测试

### 2. 观察识别结果
- **误识别多** → 提高阈值（如 0.75）
- **漏识别多** → 降低阈值（如 0.55）

### 3. 根据图像质量调整
- **高质量图像** → 可以使用较高阈值（0.7-0.8）
- **低质量图像** → 使用较低阈值（0.5-0.6）

### 4. 根据应用场景调整
- **考勤系统** → 严格阈值（0.75+），减少误识别
- **监控系统** → 中等阈值（0.6-0.7），平衡准确率和召回率
- **测试调试** → 宽松阈值（0.5-0.6），观察所有可能的匹配

## 实际测试示例

```python
# 测试不同阈值的效果
thresholds = [0.5, 0.6, 0.7, 0.8]

for threshold in thresholds:
    print(f"\n测试阈值: {threshold}")
    results = process_video_frame(
        video_path='test.mp4',
        similarity_threshold=threshold
    )
    print(f"匹配数量: {len(results)}")
```

## 注意事项

1. **阈值不是越高越好**
   - 过高的阈值会导致漏识别
   - 需要根据实际需求平衡

2. **不同特征提取器的影响**
   - DINO 和 FaceNet 的特征分布可能不同
   - 建议针对不同模型分别调优阈值

3. **数据集影响**
   - 如果特征库中的人脸质量很好，可以使用较高阈值
   - 如果特征库质量参差不齐，建议使用中等阈值

4. **动态调整**
   - 可以根据识别结果动态调整阈值
   - 建议记录不同阈值下的识别效果

## 总结

- **默认推荐值：** `0.65` 或 `0.7`
- **宽松场景：** `0.5 - 0.6`
- **严格场景：** `0.75 - 0.8`
- **根据实际效果调整，找到最适合您应用的阈值**

