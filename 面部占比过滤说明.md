# 面部占比过滤功能说明

## 功能概述

在人脸检测函数中添加了**面部占比检测**功能，可以自动过滤掉面部占比过小的人脸检测结果。这对于过滤掉包含过多头发或背景的检测框非常有用。

## 工作原理

### 1. 面部占比计算

使用启发式方法估算面部区域：
- **假设面部区域**：检测框的下 75% 部分
- **假设头发区域**：检测框的上 25% 部分
- **面部占比** = 面部区域面积 / 检测框总面积 = 75%
- **头发占比** = 头发区域面积 / 检测框总面积 = 25%

这是一个简化的模型，适用于大多数正面人脸。

### 2. 过滤机制

- 如果检测到的人脸的面部占比 < 最小阈值（默认 0.5），则过滤掉该人脸
- 默认阈值：`min_face_ratio=0.5`（50%）
- 可以通过初始化参数调整阈值

## 使用方法

### 基本使用

```python
from face_detector import FaceDetector

# 使用默认阈值（50%）
face_detector = FaceDetector()

# 检测人脸（默认启用过滤）
faces, boxes, probs = face_detector.detect_faces(image_path)

# 禁用过滤
faces, boxes, probs = face_detector.detect_faces(image_path, filter_by_face_ratio=False)
```

### 自定义阈值

```python
# 设置最小面部占比为 60%
face_detector = FaceDetector(min_face_ratio=0.6)

# 检测人脸
faces, boxes, probs = face_detector.detect_faces(image_path)
```

### 阈值建议

- **0.4-0.5**：宽松阈值，适合包含较多头发的人脸
- **0.5-0.6**：中等阈值，推荐用于一般场景（默认）
- **0.6-0.7**：严格阈值，只保留面部占比很高的人脸
- **0.7以上**：非常严格，可能过滤掉很多有效人脸

## 输出信息

当检测到面部占比过小的人脸时，会输出过滤信息：

```
过滤人脸 1: 面部占比 35.00% < 阈值 50.00% (头发占比: 25.00%)
```

## 代码示例

### 示例 1：基本使用

```python
from face_detector import FaceDetector
from PIL import Image

# 初始化检测器（默认阈值 50%）
detector = FaceDetector()

# 检测人脸
image = Image.open('test.jpg')
faces, boxes, probs = detector.detect_faces(image)

print(f"检测到 {len(faces)} 个人脸（已过滤面部占比过小的）")
```

### 示例 2：自定义阈值

```python
# 设置更严格的阈值（60%）
detector = FaceDetector(min_face_ratio=0.6)

faces, boxes, probs = detector.detect_faces(image)
print(f"检测到 {len(faces)} 个人脸（面部占比 >= 60%）")
```

### 示例 3：查看面部占比

```python
detector = FaceDetector()

# 检测人脸
faces, boxes, probs = detector.detect_faces(image)

# 查看每个人脸的面部占比
for i, box in enumerate(boxes):
    face_ratio, hair_ratio = detector.calculate_face_ratio(
        box, image.width, image.height
    )
    print(f"人脸 {i+1}: 面部占比 {face_ratio:.2%}, 头发占比 {hair_ratio:.2%}")
```

## 技术细节

### 计算方法

```python
# 检测框尺寸
box_width = x2 - x1
box_height = y2 - y1
box_area = box_width * box_height

# 面部区域（下75%）
face_area = box_width * (box_height * 0.75)

# 头发区域（上25%）
hair_area = box_width * (box_height * 0.25)

# 占比
face_ratio = face_area / box_area  # 75%
hair_ratio = hair_area / box_area  # 25%
```

### 适用场景

- ✅ **正面人脸**：效果最好
- ✅ **侧面人脸**：可能略有偏差，但通常仍有效
- ⚠️ **极端角度**：可能不准确
- ⚠️ **遮挡严重**：可能不准确

## 注意事项

1. **启发式方法**：这是一个简化的估算方法，不是精确的面部分割
2. **阈值调整**：根据实际场景调整阈值，找到最佳平衡点
3. **性能影响**：过滤功能对性能影响很小，几乎可以忽略
4. **兼容性**：与现有代码完全兼容，默认启用过滤

## 未来改进

可以考虑的改进方向：
1. 使用面部关键点检测（如 MTCNN 的关键点）来更精确地计算面部区域
2. 使用深度学习模型进行面部分割
3. 根据人脸角度动态调整面部区域估算

