# 特征和关键点预提取说明

## 概述

为了提升训练效率并避免在训练过程中因模型提取不到特征而影响训练，现在支持预先提取 DINOv2 特征和关键点，并保存到 JSON 文件中。Dataset 可以直接从 JSON 读取特征和关键点，无需再读取图片。

## 主要改进

### 1. 预提取特征和关键点

- **DINOv2 特征**：预先提取所有图片的 DINOv2 特征，避免训练时重复提取
- **关键点信息**：预先检测并保存关键点（2D、3D坐标、边界框）
- **球面角**：预先计算球面角，作为位置编码

### 2. 使用相对路径

- 所有路径保存为相对路径（相对于基础目录）
- 统一使用正斜杠（`/`），避免 Windows/Linux 路径问题
- 支持跨平台使用

### 3. 数据格式

JSON 文件包含以下信息：

```json
{
  "人名": {
    "face_image_path": "相对路径/正面图.jpg",
    "face_features": [768维特征向量],
    "face_landmarks_2d": [[5, 2]],
    "face_landmarks_3d": [[5, 3]],
    "face_box": [x1, y1, x2, y2],
    "video_data": [
      {
        "image_path": "相对路径/视频帧.jpg",
        "features": [768维特征向量],
        "landmarks_2d": [[5, 2]],
        "landmarks_3d": [[5, 3]],
        "box": [x1, y1, x2, y2],
        "spherical_angles": [5维角度],
        "avg_angle": 平均角度
      }
    ],
    "feature_dim": 768,
    "dinov2_model": "dinov2_vitb14"
  }
}
```

## 使用方法

### 1. 生成预提取数据

运行 `filter_valid_images.py` 生成包含特征和关键点的 JSON 文件：

```bash
python train_transformer/filter_valid_images.py \
    --video_dir /root/face000/train/datas/video \
    --face_dir /root/face000/train/datas/face \
    --output_file train_transformer/valid_images.json \
    --base_dir /root/face000 \
    --dinov2_model dinov2_vitb14
```

**参数说明**：
- `--video_dir`: 视频帧图片目录
- `--face_dir`: 正面图片目录
- `--output_file`: 输出 JSON 文件路径
- `--base_dir`: 基础目录，用于计算相对路径（默认使用 output_file 的父目录）
- `--dinov2_model`: DINOv2 模型名称（`dinov2_vits14`, `dinov2_vitb14`, `dinov2_vitl14`, `dinov2_vitg14`）
- `--use_cpu`: 使用 CPU（默认使用 GPU）

### 2. 使用预提取数据训练

在训练时，dataset 会自动检测 JSON 文件格式：

- **新格式**（包含特征）：直接使用预提取的特征和关键点，无需读取图片
- **旧格式**（只包含路径）：向后兼容，实时提取特征

```bash
python train_transformer/train.py \
    --features_224_dir /root/face000/features_224 \
    --video_dir /root/face000/train/datas/video \
    --face_dir /root/face000/train/datas/face \
    --valid_images_file train_transformer/valid_images.json \
    --batch_size 128
```

## 优势

### 1. 训练速度提升

- **无需读取图片**：直接从 JSON 读取特征，避免 I/O 瓶颈
- **无需实时提取特征**：避免训练时重复运行 DINOv2 模型
- **无需实时检测关键点**：避免训练时重复运行 InsightFace

### 2. 稳定性提升

- **筛选有效数据**：只保留能成功提取特征和关键点的图片
- **避免训练中断**：训练时不会因为提取不到特征而失败
- **数据一致性**：所有特征使用相同的模型和参数提取

### 3. 跨平台兼容

- **相对路径**：使用相对路径，避免 Windows/Linux 路径差异
- **统一格式**：统一使用正斜杠，兼容所有操作系统

## 数据格式说明

### 新格式（推荐）

包含预提取的特征和关键点：

```json
{
  "人名": {
    "face_image_path": "train/datas/face/人名.jpg",
    "face_features": [...],
    "face_landmarks_2d": [[...], [...]],
    "face_landmarks_3d": [[...], [...]],
    "face_box": [x1, y1, x2, y2],
    "video_data": [...],
    "feature_dim": 768,
    "dinov2_model": "dinov2_vitb14"
  }
}
```

### 旧格式（向后兼容）

只包含路径，需要实时提取：

```json
{
  "人名": {
    "face_image_path": "train/datas/face/人名.jpg",
    "video_images": ["path1", "path2", ...]
  }
}
```

## 注意事项

### 1. 特征维度一致性

- 确保所有特征使用相同的 DINOv2 模型提取
- 不同模型的特征维度不同：
  - `dinov2_vits14`: 384 维
  - `dinov2_vitb14`: 768 维（推荐）
  - `dinov2_vitl14`: 1024 维
  - `dinov2_vitg14`: 1536 维

### 2. 基础目录设置

- `base_dir` 用于计算相对路径
- 如果未指定，默认使用 `output_file` 的父目录
- 确保 `base_dir` 是数据目录的公共父目录

### 3. 路径解析

- Dataset 会自动解析相对路径为绝对路径
- 如果路径是绝对路径，直接使用
- 如果路径是相对路径，基于 JSON 文件所在目录解析

## 性能对比

### 使用预提取数据（新格式）

- **数据加载速度**：~10x 提升（无需读取图片和提取特征）
- **训练速度**：~2-3x 提升（减少 I/O 和计算开销）
- **显存使用**：减少（无需加载图片到内存）

### 使用实时提取（旧格式）

- **数据加载速度**：正常（需要读取图片和提取特征）
- **训练速度**：正常（每次迭代都需要提取特征）
- **显存使用**：正常（需要加载图片到内存）

## 故障排除

### Q1: 特征维度不匹配

**问题**：训练时出现特征维度错误

**解决方案**：
1. 检查 JSON 文件中的 `feature_dim` 和 `dinov2_model`
2. 确保训练时使用的模型与提取时一致
3. 重新运行 `filter_valid_images.py` 生成新数据

### Q2: 路径解析失败

**问题**：无法找到图片路径

**解决方案**：
1. 检查 `base_dir` 设置是否正确
2. 确保相对路径基于正确的基准目录
3. 检查 JSON 文件中的路径格式（应使用正斜杠）

### Q3: 数据格式不兼容

**问题**：Dataset 无法读取 JSON 文件

**解决方案**：
1. 检查 JSON 文件格式是否正确
2. 确保包含必要的字段（`face_features`, `video_data` 等）
3. 如果使用旧格式，确保包含 `video_images` 字段

## 总结

通过预提取特征和关键点，可以显著提升训练效率和稳定性。建议：

1. ✅ **使用新格式**：生成包含预提取特征的 JSON 文件
2. ✅ **使用相对路径**：确保跨平台兼容性
3. ✅ **统一模型**：确保提取和训练使用相同的 DINOv2 模型
4. ✅ **定期更新**：当数据或模型变化时，重新生成 JSON 文件

