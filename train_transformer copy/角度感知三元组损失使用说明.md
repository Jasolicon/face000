# 角度感知三元组损失使用说明

## 概述

角度感知三元组损失（Angle-Aware Triplet Loss）是一种专门为人脸角度转换任务设计的损失函数，核心思想是：

- **拉近同一身份不同角度的特征**：强制模型将不同角度的同一人映射到相似的特征空间
- **推开同一角度不同身份的特征**：强制模型区分相同角度的不同人

## 核心组件

### 1. AngleAwareTripletSampler（采样器）

智能地构建困难且有教学意义的训练三元组：

- **正样本选择**：同身份、角度差异最大的样本（跨角度聚合）
- **负样本选择**：不同身份、角度相似的样本（同角度分离）

### 2. AngleAwareTripletLoss（损失函数）

为不同类型的三元组分配不同的权重：

- **alpha (α)**：跨角度正样本对的权重因子（默认2.0）
- **beta (β)**：同角度负样本对的权重因子（默认1.5）
- **margin**：三元组损失的基础边界值（默认0.2）

## 使用方法

### 基本使用

```bash
python train_transformer/train.py \
    --loss_type angle_aware_triplet \
    --model_type decoder_only \
    --batch_size 128 \
    --epochs 50
```

### 参数说明

损失函数参数（在 `angle_aware_loss.py` 中可调整）：

- `margin=0.2`：三元组边界值
- `alpha=2.0`：跨角度权重（拉近不同角度的同一身份）
- `beta=1.5`：同角度权重（推开相同角度的不同身份）
- `angle_threshold=30.0`：角度差异阈值（度）

## 工作原理

### 1. 三元组采样策略

```
对于每个样本（anchor）：
1. 正样本（positive）：同身份、角度差异最大
   - 目标：拉近不同角度的同一人
   
2. 负样本（negative）：不同身份、角度相似
   - 目标：推开相同角度的不同人
```

### 2. 动态权重计算

```python
权重 = 1.0

# 如果正样本角度差异 > 45度（跨角度）
if pos_angle_diff > 45.0:
    权重 *= alpha  # 增加权重，强调跨角度聚合

# 如果负样本角度差异 < 15度（同角度）
if neg_angle_diff < 15.0:
    权重 *= beta   # 增加权重，强调同角度分离
```

### 3. 损失计算

```python
基础损失 = max(0, d(anchor, positive) - d(anchor, negative) + margin)
加权损失 = 权重 × 基础损失
总损失 = 平均(加权损失) + 0.1 × 重建损失
```

## 与现有损失函数的对比

| 损失函数 | 特点 | 适用场景 |
|---------|------|---------|
| `residual_and_final` | 同时优化残差和最终特征 | 标准训练（默认） |
| `angle_aware_triplet` | 强调身份-角度解耦 | 需要强化身份识别能力 |
| `combined` | 余弦+MSE组合 | 平衡特征相似度和距离 |
| `cosine` | 只优化余弦相似度 | 快速训练 |

## 训练监控

使用角度感知三元组损失时，会输出以下指标：

- `triplet_loss`：三元组损失值
- `reconstruction_loss`：重建损失（可选）
- `num_triplets`：有效三元组数量
- `avg_weight`：平均权重
- `avg_pos_dist`：平均正样本距离
- `avg_neg_dist`：平均负样本距离

## 注意事项

1. **需要身份标签**：损失函数需要 `person_names` 来构建三元组
2. **batch大小**：建议使用较大的batch size（≥64）以确保有足够的同身份样本
3. **参数调整**：根据数据集特性调整 `alpha`、`beta` 和 `angle_threshold`
4. **与decoder_only模型配合**：特别适合与 `TransformerDecoderOnly` 模型一起使用

## 示例输出

```
使用角度感知三元组损失：margin=0.2, alpha=2.0, beta=1.5
Epoch 1, Batch 0/100, Loss: 0.3245, LR: 0.000200, Triplets: 12
Epoch 1, Batch 10/100, Loss: 0.2987, LR: 0.000200, Triplets: 15
...
```

## 调优建议

1. **如果身份识别效果不佳**：
   - 增加 `alpha`（跨角度权重）
   - 增加 `beta`（同角度权重）

2. **如果训练不稳定**：
   - 减小 `margin`
   - 减小 `alpha` 和 `beta`

3. **如果三元组数量太少**：
   - 增加 `batch_size`
   - 减小 `angle_threshold`

## 参考文献

- Domain-aware triplet loss in domain generalization
- 核心思想：通过角度感知的采样和加权，强化模型对身份的聚焦能力

