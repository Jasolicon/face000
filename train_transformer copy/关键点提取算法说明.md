# 关键点提取算法说明

## 当前使用的算法

### InsightFace (buffalo_l 模型)

项目使用 **InsightFace** 库进行人脸检测和关键点提取，具体使用的是 **buffalo_l** 模型。

## 详细信息

### 1. 算法来源

- **库名**: InsightFace
- **模型**: buffalo_l (Large版本)
- **官方仓库**: https://github.com/deepinsight/insightface
- **特点**: 
  - 高精度的人脸检测和关键点定位
  - 支持多种人脸分析任务（检测、识别、对齐等）
  - 基于深度学习（CNN）

### 2. 关键点格式

InsightFace 检测 **5个关键点**，格式为 `[5, 2]`：

```python
landmarks = [
    [x_left_eye, y_left_eye],      # 左眼中心
    [x_right_eye, y_right_eye],    # 右眼中心
    [x_nose, y_nose],               # 鼻尖
    [x_left_mouth, y_left_mouth],  # 左嘴角
    [x_right_mouth, y_right_mouth] # 右嘴角
]
```

### 3. 代码实现

#### 初始化检测器

```python
from insightface.app import FaceAnalysis

# 创建检测器
detector = FaceAnalysis(name='buffalo_l')

# 准备检测器（GPU或CPU）
if use_cpu:
    detector.prepare(ctx_id=-1, det_size=(640, 640))  # CPU
else:
    detector.prepare(ctx_id=0, det_size=(640, 640))    # GPU
```

#### 检测关键点

```python
# 读取图像
img = cv2.imread(image_path)

# 检测人脸和关键点
faces = detector.get(img)

if len(faces) > 0:
    face = faces[0]
    landmarks = face.kps      # [5, 2] 关键点坐标
    box = face.bbox           # [x1, y1, x2, y2] 边界框
```

### 4. 算法特点

#### 优点

- **高精度**: 基于深度学习，关键点定位准确
- **鲁棒性**: 对光照、角度、遮挡有一定鲁棒性
- **速度快**: 支持GPU加速，处理速度快
- **多功能**: 同时提供人脸检测、关键点定位、特征提取等功能

#### 限制

- **关键点数量**: 只检测5个关键点（不是68点或更多）
- **遮挡处理**: 严重遮挡时可能检测失败
- **角度限制**: 极端角度（如90°侧面）可能检测不到
- **模型大小**: buffalo_l 模型较大（约几百MB）

### 5. 模型信息

#### buffalo_l 模型组成

1. **人脸检测模型** (detection)
   - 用于检测人脸位置和边界框
   - 输入: 图像
   - 输出: 人脸边界框

2. **关键点定位模型** (landmark)
   - 用于定位5个关键点
   - 输入: 人脸区域
   - 输出: 关键点坐标 [5, 2]

3. **特征提取模型** (recognition, 可选)
   - 用于提取人脸特征向量
   - 输入: 对齐后的人脸
   - 输出: 512维特征向量

#### 模型下载

模型会自动从 HuggingFace 下载，默认位置：
- Linux/Mac: `~/.insightface/models/buffalo_l/`
- Windows: `C:\Users\<username>\.insightface\models\buffalo_l\`

可以通过环境变量设置：
```bash
export INSIGHTFACE_ROOT=/path/to/models
```

### 6. 检测流程

```
输入图像
    ↓
InsightFace 检测器
    ↓
人脸检测 (detection)
    ↓
关键点定位 (landmark)
    ↓
输出: landmarks [5, 2], box [x1, y1, x2, y2]
```

### 7. 与其他算法的对比

| 算法 | 关键点数量 | 精度 | 速度 | 特点 |
|------|-----------|------|------|------|
| **InsightFace (buffalo_l)** | 5 | 高 | 快 | 当前使用 |
| MediaPipe Face Mesh | 468 | 中 | 快 | 关键点多，但精度一般 |
| Dlib | 68 | 中 | 中 | 传统方法，需要预训练模型 |
| OpenCV Haar | 0 | 低 | 快 | 只能检测，不提供关键点 |
| MTCNN | 5 | 中 | 慢 | 较老的方法 |

### 8. 使用示例

```python
from utils import get_insightface_detector, get_insightface_landmarks

# 初始化检测器（单例模式）
detector = get_insightface_detector(use_cpu=False)

# 检测关键点
landmarks, box = get_insightface_landmarks(detector, 'image.jpg')

if landmarks is not None:
    print(f"检测到 {len(landmarks)} 个关键点")
    print(f"左眼: {landmarks[0]}")
    print(f"右眼: {landmarks[1]}")
    print(f"鼻尖: {landmarks[2]}")
    print(f"左嘴角: {landmarks[3]}")
    print(f"右嘴角: {landmarks[4]}")
```

### 9. 注意事项

1. **模型下载**: 首次使用需要下载模型（约几百MB）
2. **GPU支持**: 建议使用GPU加速，CPU模式较慢
3. **中文路径**: 代码已处理中文路径问题（使用PIL读取）
4. **多张人脸**: 如果图像中有多张人脸，默认使用第一张
5. **检测失败**: 如果检测不到人脸，返回 `None, None`

### 10. 相关文件

- `utils.py`: 包含 `get_insightface_detector()` 和 `get_insightface_landmarks()` 函数
- `train_transformer/filter_valid_images.py`: 使用InsightFace提取关键点并保存到JSON
- `insightfacealign.py`: 使用InsightFace进行人脸对齐

### 11. 参考资料

- InsightFace 官方文档: https://github.com/deepinsight/insightface
- buffalo_l 模型: https://github.com/deepinsight/insightface/tree/master/python-package
- 模型下载: 自动从 HuggingFace 下载
