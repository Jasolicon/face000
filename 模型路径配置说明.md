# 模型路径配置说明

## 问题

之前模型会重复下载，即使已经下载过。现在支持从指定路径加载模型，避免重复下载。

## 解决方案

### 方法1：使用环境变量（推荐）

设置环境变量 `DINOV2_MODEL_DIR` 指定模型目录：

```bash
# Linux/Mac
export DINOV2_MODEL_DIR=/root/face000/models/dinov2

# Windows
set DINOV2_MODEL_DIR=D:\Code\face000\models\dinov2
```

然后运行训练或特征提取，模型会自动从该目录加载：

```bash
python train_transformer/train.py ...
```

### 方法2：先下载模型到指定路径

```bash
# 下载模型到指定路径
python download_dinov2.py --model dinov2_vitb14 --save_dir /root/face000/models/dinov2

# 设置环境变量
export DINOV2_MODEL_DIR=/root/face000/models/dinov2

# 运行训练（不会重新下载）
python train_transformer/train.py ...
```

### 方法3：在代码中直接指定（高级）

如果需要在代码中直接指定，可以修改相关文件，在 `DINOv2FeatureExtractor` 初始化时传入 `model_dir` 参数。

## 工作流程

1. **首次使用**：
   - 设置 `DINOV2_MODEL_DIR` 环境变量
   - 运行训练脚本
   - 模型会下载到指定目录并保存

2. **后续使用**：
   - 模型已存在于指定目录
   - 自动从本地加载，**不会重新下载**

## 目录结构

下载后的目录结构：

```
/root/face000/models/dinov2/
├── dinov2_vits14.pth    # 小模型（384维）
├── dinov2_vitb14.pth    # 中等模型（768维，推荐）
├── dinov2_vitl14.pth    # 大模型（1024维）
└── dinov2_vitg14.pth    # 超大模型（1536维）
```

## 完整示例

### Linux/Mac

```bash
# 1. 创建模型目录
mkdir -p /root/face000/models/dinov2

# 2. 下载模型（可选，如果已下载可跳过）
python download_dinov2.py --model dinov2_vitb14 --save_dir /root/face000/models/dinov2

# 3. 设置环境变量
export DINOV2_MODEL_DIR=/root/face000/models/dinov2

# 4. 运行训练（不会重新下载）
python train_transformer/train.py \
    --model_type transformer \
    --batch_size 128 \
    --epochs 150
```

### Windows

```powershell
# 1. 创建模型目录
mkdir D:\Code\face000\models\dinov2

# 2. 下载模型（可选）
python download_dinov2.py --model dinov2_vitb14 --save_dir D:\Code\face000\models\dinov2

# 3. 设置环境变量
set DINOV2_MODEL_DIR=D:\Code\face000\models\dinov2

# 4. 运行训练
python train_transformer/train.py --model_type transformer --batch_size 128
```

## 永久设置环境变量

### Linux/Mac

添加到 `~/.bashrc` 或 `~/.zshrc`：

```bash
echo 'export DINOV2_MODEL_DIR=/root/face000/models/dinov2' >> ~/.bashrc
source ~/.bashrc
```

### Windows

1. 右键"此电脑" → "属性"
2. "高级系统设置" → "环境变量"
3. 添加系统变量：
   - 变量名：`DINOV2_MODEL_DIR`
   - 变量值：`D:\Code\face000\models\dinov2`

## 验证

运行训练时，如果看到以下信息，说明从本地加载成功：

```
初始化DINOv2特征提取器（模型: dinov2_vitb14）...
  使用模型目录: /root/face000/models/dinov2
  从本地路径加载 DINOv2 dinov2_vitb14: /root/face000/models/dinov2/dinov2_vitb14.pth
  ✓ 成功从本地路径加载 DINOv2 dinov2_vitb14 模型
```

如果没有设置环境变量，会看到：

```
  尝试从 torch.hub 加载 DINOv2 dinov2_vitb14...
  ✓ 成功加载 DINOv2 dinov2_vitb14 模型
  模型缓存位置: ~/.cache/torch/hub/checkpoints/
```

## 优势

1. ✅ **避免重复下载**：模型只下载一次
2. ✅ **指定路径**：模型保存在指定位置，不在缓存目录
3. ✅ **易于管理**：所有模型文件集中管理
4. ✅ **跨环境共享**：可以在不同环境间共享模型文件
5. ✅ **版本控制**：可以手动管理模型版本

## 注意事项

1. 确保模型目录有写入权限
2. 确保有足够的磁盘空间（每个模型约 100-500MB）
3. 如果模型文件损坏，删除后会自动重新下载
4. 环境变量只在当前会话有效，需要永久设置请参考上面的方法

