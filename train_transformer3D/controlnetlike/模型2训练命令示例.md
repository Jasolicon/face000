# 模型2（ImageControlNet）训练命令示例

## 📋 模型2简介

**ImageControlNet**：从图片生成目标角度的图片，受姿势控制

- **输入**：源图像 + 目标姿势
- **输出**：目标角度的图像
- **特点**：使用InsightFace预训练backbone（或ImageNet预训练ResNet50）提取图像特征

---

## 🚀 基础训练命令

### 1. 最小配置训练

```bash
python train_transformer3D/controlnetlike/train_image_controlnet.py data_dir train/datas/file epochs 100 batch_size 16 lr 1e-4
```

### 2. 完整配置训练

```bash
python train_transformer3D/controlnetlike/train_image_controlnet.py \
    --data_dir train/datas/file \
    --image_dir train/datas/file \
    --batch_size 16 \
    --num_workers 4 \
    --image_size 112 \
    --feature_dim 512 \
    --pose_dim 3 \
    --num_control_layers 3 \
    --epochs 100 \
    --lr 1e-4 \
    --weight_decay 1e-5 \
    --pose_loss_weight 0.1 \
    --loss_type mse \
    --use_amp \
    --gradient_accumulation_steps 1 \
    --save_dir train_transformer3D/controlnetlike/checkpoints_image \
    --log_dir train_transformer3D/controlnetlike/logs_image \
    --save_interval 10
```

---

## 🎯 不同场景的训练命令

### 场景1：冻结图像生成器（两阶段训练）

**第一阶段**：只训练控制分支和图像编码器

```bash
python train_transformer3D/controlnetlike/train_image_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 16 \
    --epochs 50 \
    --lr 1e-4 \
    --freeze_generator \
    --save_dir train_transformer3D/controlnetlike/checkpoints_image_stage1
```

**第二阶段**：解冻所有参数，微调整个模型

```bash
python train_transformer3D/controlnetlike/train_image_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 16 \
    --epochs 50 \
    --lr 5e-5 \
    --resume train_transformer3D/controlnetlike/checkpoints_image_stage1/best_model.pth \
    --save_dir train_transformer3D/controlnetlike/checkpoints_image_stage2
```

### 场景2：使用混合精度训练（节省显存）

```bash
python train_transformer3D/controlnetlike/train_image_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 100 \
    --lr 1e-4 \
    --use_amp \
    --save_dir train_transformer3D/controlnetlike/checkpoints_image_amp
```

### 场景3：使用梯度累积（模拟更大batch size）

```bash
python train_transformer3D/controlnetlike/train_image_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 8 \
    --epochs 100 \
    --lr 1e-4 \
    --gradient_accumulation_steps 4 \
    --save_dir train_transformer3D/controlnetlike/checkpoints_image_accum
```

**说明**：实际batch size = 8 × 4 = 32

### 场景4：使用不同的损失函数

**MSE损失**（默认）：
```bash
python train_transformer3D/controlnetlike/train_image_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 16 \
    --epochs 100 \
    --loss_type mse
```

**L1损失**：
```bash
python train_transformer3D/controlnetlike/train_image_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 16 \
    --epochs 100 \
    --loss_type l1
```

**组合损失**（MSE + L1）：
```bash
python train_transformer3D/controlnetlike/train_image_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 16 \
    --epochs 100 \
    --loss_type combined
```

### 场景5：调整姿势损失权重

**更重视姿势预测**：
```bash
python train_transformer3D/controlnetlike/train_image_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 16 \
    --epochs 100 \
    --pose_loss_weight 0.5
```

**更重视图像生成**：
```bash
python train_transformer3D/controlnetlike/train_image_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 16 \
    --epochs 100 \
    --pose_loss_weight 0.01
```

### 场景6：从检查点恢复训练

```bash
python train_transformer3D/controlnetlike/train_image_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 16 \
    --epochs 100 \
    --resume train_transformer3D/controlnetlike/checkpoints_image/checkpoint_epoch_50.pth \
    --save_dir train_transformer3D/controlnetlike/checkpoints_image_resume
```

### 场景7：显存受限（小batch size + 梯度累积）

```bash
python train_transformer3D/controlnetlike/train_image_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 4 \
    --num_workers 2 \
    --epochs 100 \
    --lr 1e-4 \
    --gradient_accumulation_steps 8 \
    --use_amp \
    --save_dir train_transformer3D/controlnetlike/checkpoints_image_small
```

**说明**：实际batch size = 4 × 8 = 32，但显存占用更小

### 场景8：快速测试（少量epoch）

```bash
python train_transformer3D/controlnetlike/train_image_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 16 \
    --epochs 10 \
    --save_interval 5 \
    --save_dir train_transformer3D/controlnetlike/checkpoints_image_test
```

---

## 📊 参数说明

### 数据参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--data_dir` | str | **必需** | 数据目录路径（包含metadata和keypoints） |
| `--image_dir` | str | None | 图片目录（如果与data_dir不同） |
| `--batch_size` | int | 16 | 批次大小（图像生成需要更多内存） |
| `--num_workers` | int | 4 | 数据加载器工作进程数 |
| `--image_size` | int | 112 | 图像尺寸 |

### 模型参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--feature_dim` | int | 512 | 特征维度 |
| `--pose_dim` | int | 3 | 姿势维度（欧拉角） |
| `--num_control_layers` | int | 3 | 控制分支层数 |
| `--freeze_generator` | flag | False | 是否冻结图像生成器 |

### 训练参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--epochs` | int | 100 | 训练轮数 |
| `--lr` | float | 1e-4 | 学习率 |
| `--weight_decay` | float | 1e-5 | 权重衰减（L2正则化） |
| `--pose_loss_weight` | float | 0.1 | 姿势预测损失权重 |

### 损失函数参数

| 参数 | 类型 | 默认值 | 选项 | 说明 |
|------|------|--------|------|------|
| `--loss_type` | str | mse | mse, l1, combined | 损失函数类型 |

### 其他参数

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `--use_amp` | flag | False | 使用混合精度训练（节省显存） |
| `--gradient_accumulation_steps` | int | 1 | 梯度累积步数 |
| `--resume` | str | None | 恢复训练的检查点路径 |
| `--save_dir` | str | checkpoints_image | 模型保存目录 |
| `--log_dir` | str | logs_image | TensorBoard日志目录 |
| `--save_interval` | int | 10 | 保存模型的间隔（epoch） |

---

## 📁 数据目录结构

模型2需要以下数据文件：

```
train/datas/file/
├── front_metadata.json      # 正面图元数据
├── front_keypoints.npy      # 正面图关键点
├── video_metadata.json      # 视频帧元数据
├── video_keypoints.npy      # 视频帧关键点
└── [图片文件]                # 原始图片（如果使用image_dir）
```

**注意**：模型2需要原始图片文件，用于训练图像生成器。

---

## 🔍 训练监控

### TensorBoard

训练过程中，可以使用TensorBoard监控训练进度：

```bash
tensorboard --logdir train_transformer3D/controlnetlike/logs_image
```

**监控指标**：
- `Epoch/TrainLoss`：训练总损失
- `Epoch/TrainImageLoss`：训练图像损失
- `Epoch/TrainPoseLoss`：训练姿势损失
- `Epoch/ValLoss`：验证总损失
- `Epoch/ValImageLoss`：验证图像损失
- `Epoch/ValPSNR`：验证PSNR（图像质量）
- `Images/Comparison`：图像对比（每10个epoch）
- `Images/Sample_*`：单个样本可视化
- `Pose/Target`、`Pose/Source`、`Pose/Difference`：姿势分布

### 训练曲线图

训练脚本会自动生成训练曲线图：
- `training_curves_epoch_*.png`：每个保存间隔的曲线
- `final_training_curves.png`：最终训练曲线

---

## 💡 训练建议

### 1. 学习率调整

- **初始学习率**：1e-4（推荐）
- **微调阶段**：5e-5 或 1e-5
- **如果损失不下降**：尝试降低学习率到 5e-5

### 2. Batch Size选择

- **显存充足（>16GB）**：batch_size=16-32
- **显存中等（8-16GB）**：batch_size=8-16 + 梯度累积
- **显存较小（<8GB）**：batch_size=4-8 + 梯度累积 + 混合精度

### 3. 两阶段训练策略

1. **第一阶段**：冻结生成器，只训练控制分支（50 epochs）
2. **第二阶段**：解冻所有参数，微调整个模型（50 epochs）

### 4. 损失函数选择

- **MSE**：适合大多数情况，训练稳定
- **L1**：对异常值更鲁棒
- **Combined**：结合两者优点，但需要调整权重

### 5. 姿势损失权重

- **默认**：0.1（更重视图像生成）
- **如果姿势预测不准确**：增加到 0.3-0.5
- **如果图像质量差**：降低到 0.01-0.05

---

## 🐛 常见问题

### 1. 显存不足

**解决方案**：
- 减小batch_size
- 使用梯度累积
- 启用混合精度训练（`--use_amp`）

### 2. 训练速度慢

**解决方案**：
- 增加`num_workers`（但不要超过CPU核心数）
- 使用混合精度训练
- 检查数据加载是否成为瓶颈

### 3. 图像质量差

**解决方案**：
- 检查数据质量
- 调整损失函数类型
- 增加训练轮数
- 调整学习率

### 4. 姿势预测不准确

**解决方案**：
- 增加`pose_loss_weight`
- 检查关键点数据质量
- 调整控制分支层数

---

## 📝 完整训练示例

### 推荐配置（平衡性能和显存）

```bash
python train_transformer3D/controlnetlike/train_image_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 16 \
    --num_workers 4 \
    --image_size 112 \
    --feature_dim 512 \
    --pose_dim 3 \
    --num_control_layers 3 \
    --epochs 100 \
    --lr 1e-4 \
    --weight_decay 1e-5 \
    --pose_loss_weight 0.1 \
    --loss_type mse \
    --use_amp \
    --gradient_accumulation_steps 1 \
    --save_dir train_transformer3D/controlnetlike/checkpoints_image \
    --log_dir train_transformer3D/controlnetlike/logs_image \
    --save_interval 10
```

---

生成时间: 2024-12-16

