# æ¨¡å‹1è®­ç»ƒå‘½ä»¤ç¤ºä¾‹

## ğŸ“‹ åŸºç¡€è®­ç»ƒå‘½ä»¤

### æœ€å°é…ç½®ï¼ˆå¿«é€Ÿæµ‹è¯•ï¼‰

```bash
python train_transformer3D/controlnetlike/train_feature_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 16 \
    --epochs 10 \
    --lr 1e-4
```

---

## ğŸš€ å®Œæ•´è®­ç»ƒå‘½ä»¤

### æ ‡å‡†é…ç½®ï¼ˆæ¨èï¼‰

```bash
python train_transformer3D/controlnetlike/train_feature_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 100 \
    --lr 1e-4 \
    --weight_decay 1e-5 \
    --identity_loss_weight 0.3 \
    --loss_type combined \
    --mse_weight 0.5 \
    --cosine_weight 0.5 \
    --num_workers 4 \
    --use_amp \
    --save_dir train_transformer3D/controlnetlike/checkpoints_feature \
    --log_dir train_transformer3D/controlnetlike/logs_feature \
    --save_interval 10
```

---

## âš™ï¸ ä¸åŒåœºæ™¯çš„è®­ç»ƒå‘½ä»¤

### åœºæ™¯1ï¼šå†»ç»“ä¸»ç½‘ç»œï¼Œåªè®­ç»ƒæ§åˆ¶åˆ†æ”¯ï¼ˆå¿«é€Ÿæ”¶æ•›ï¼‰

```bash
python train_transformer3D/controlnetlike/train_feature_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 50 \
    --lr 1e-3 \
    --weight_decay 1e-5 \
    --identity_loss_weight 0.3 \
    --freeze_main \
    --loss_type mse \
    --use_amp \
    --save_dir train_transformer3D/controlnetlike/checkpoints_feature_frozen \
    --log_dir train_transformer3D/controlnetlike/logs_feature_frozen
```

**ç‰¹ç‚¹**ï¼š
- âœ… è®­ç»ƒé€Ÿåº¦å¿«ï¼ˆåªè®­ç»ƒæ§åˆ¶åˆ†æ”¯ï¼‰
- âœ… ä¿æŠ¤é¢„è®­ç»ƒçš„ä¸»ç½‘ç»œèƒ½åŠ›
- âœ… é€‚åˆå¿«é€ŸåŸå‹å’Œå®éªŒ

### åœºæ™¯2ï¼šç«¯åˆ°ç«¯è®­ç»ƒï¼ˆå®Œæ•´è®­ç»ƒï¼‰

```bash
python train_transformer3D/controlnetlike/train_feature_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 100 \
    --lr 1e-4 \
    --weight_decay 1e-5 \
    --identity_loss_weight 0.3 \
    --loss_type combined \
    --mse_weight 0.5 \
    --cosine_weight 0.5 \
    --num_workers 4 \
    --use_amp \
    --gradient_accumulation_steps 2 \
    --save_dir train_transformer3D/controlnetlike/checkpoints_feature_full \
    --log_dir train_transformer3D/controlnetlike/logs_feature_full \
    --save_interval 10
```

**ç‰¹ç‚¹**ï¼š
- âœ… è®­ç»ƒæ‰€æœ‰å‚æ•°
- âœ… æ€§èƒ½æœ€ä¼˜
- âœ… é€‚åˆæœ€ç»ˆéƒ¨ç½²

### åœºæ™¯3ï¼šä¸¤é˜¶æ®µè®­ç»ƒ

**ç¬¬ä¸€é˜¶æ®µï¼šå†»ç»“ä¸»ç½‘ç»œ**
```bash
python train_transformer3D/controlnetlike/train_feature_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 30 \
    --lr 1e-3 \
    --weight_decay 1e-5 \
    --identity_loss_weight 0.3 \
    --freeze_main \
    --loss_type mse \
    --use_amp \
    --save_dir train_transformer3D/controlnetlike/checkpoints_feature_stage1 \
    --log_dir train_transformer3D/controlnetlike/logs_feature_stage1
```

**ç¬¬äºŒé˜¶æ®µï¼šç«¯åˆ°ç«¯å¾®è°ƒ**
```bash
python train_transformer3D/controlnetlike/train_feature_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 70 \
    --lr 1e-4 \
    --weight_decay 1e-5 \
    --identity_loss_weight 0.3 \
    --loss_type combined \
    --mse_weight 0.5 \
    --cosine_weight 0.5 \
    --resume train_transformer3D/controlnetlike/checkpoints_feature_stage1/best_model.pth \
    --use_amp \
    --save_dir train_transformer3D/controlnetlike/checkpoints_feature_stage2 \
    --log_dir train_transformer3D/controlnetlike/logs_feature_stage2
```

**ç‰¹ç‚¹**ï¼š
- âœ… å¿«é€Ÿæ”¶æ•›ï¼ˆç¬¬ä¸€é˜¶æ®µï¼‰
- âœ… ç²¾ç»†ä¼˜åŒ–ï¼ˆç¬¬äºŒé˜¶æ®µï¼‰
- âœ… æ¨èç”¨äºç”Ÿäº§ç¯å¢ƒ

### åœºæ™¯4ï¼šå¤§batchè®­ç»ƒï¼ˆéœ€è¦æ›´å¤šGPUå†…å­˜ï¼‰

```bash
python train_transformer3D/controlnetlike/train_feature_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 64 \
    --epochs 100 \
    --lr 2e-4 \
    --weight_decay 1e-5 \
    --identity_loss_weight 0.3 \
    --loss_type combined \
    --mse_weight 0.5 \
    --cosine_weight 0.5 \
    --num_workers 8 \
    --use_amp \
    --gradient_accumulation_steps 1 \
    --save_dir train_transformer3D/controlnetlike/checkpoints_feature_large \
    --log_dir train_transformer3D/controlnetlike/logs_feature_large
```

**ç‰¹ç‚¹**ï¼š
- âœ… è®­ç»ƒæ›´ç¨³å®š
- âœ… éœ€è¦æ›´å¤šGPUå†…å­˜
- âœ… é€‚åˆå¤šGPUè®­ç»ƒ

### åœºæ™¯5ï¼šå°batchè®­ç»ƒï¼ˆGPUå†…å­˜æœ‰é™ï¼‰

```bash
python train_transformer3D/controlnetlike/train_feature_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 8 \
    --epochs 100 \
    --lr 1e-4 \
    --weight_decay 1e-5 \
    --identity_loss_weight 0.3 \
    --loss_type mse \
    --num_workers 2 \
    --gradient_accumulation_steps 4 \
    --save_dir train_transformer3D/controlnetlike/checkpoints_feature_small \
    --log_dir train_transformer3D/controlnetlike/logs_feature_small
```

**ç‰¹ç‚¹**ï¼š
- âœ… å†…å­˜å ç”¨å°
- âœ… ä½¿ç”¨æ¢¯åº¦ç´¯ç§¯æ¨¡æ‹Ÿå¤§batch
- âœ… é€‚åˆGPUå†…å­˜æœ‰é™çš„æƒ…å†µ

---

## ğŸ”§ å‚æ•°è¯´æ˜

### æ•°æ®å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--data_dir` | å¿…éœ€ | æ•°æ®ç›®å½•è·¯å¾„ï¼ˆåŒ…å«front_*.npyå’Œvideo_*.npyï¼‰ |
| `--batch_size` | 32 | æ‰¹æ¬¡å¤§å° |
| `--num_workers` | 4 | æ•°æ®åŠ è½½å™¨å·¥ä½œè¿›ç¨‹æ•° |

### æ¨¡å‹å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--feature_dim` | 512 | ç‰¹å¾ç»´åº¦ |
| `--pose_dim` | 3 | å§¿åŠ¿ç»´åº¦ï¼ˆæ¬§æ‹‰è§’ï¼‰ |
| `--hidden_dim` | 512 | éšè—å±‚ç»´åº¦ |
| `--num_main_layers` | 3 | ä¸»ç½‘ç»œå±‚æ•° |
| `--num_control_layers` | 3 | æ§åˆ¶åˆ†æ”¯å±‚æ•° |
| `--freeze_main` | False | æ˜¯å¦å†»ç»“ä¸»ç½‘ç»œ |

### è®­ç»ƒå‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--epochs` | 100 | è®­ç»ƒè½®æ•° |
| `--lr` | 1e-4 | å­¦ä¹ ç‡ |
| `--weight_decay` | 1e-5 | æƒé‡è¡°å‡ |
| `--identity_loss_weight` | 0.3 | èº«ä»½ä¸€è‡´æ€§æŸå¤±æƒé‡ |

### æŸå¤±å‡½æ•°å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--loss_type` | mse | æŸå¤±å‡½æ•°ç±»å‹ï¼ˆmse/cosine/combinedï¼‰ |
| `--mse_weight` | 0.5 | MSEæŸå¤±æƒé‡ï¼ˆcombinedæ¨¡å¼ï¼‰ |
| `--cosine_weight` | 0.5 | ä½™å¼¦æŸå¤±æƒé‡ï¼ˆcombinedæ¨¡å¼ï¼‰ |

### å…¶ä»–å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--use_amp` | False | ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒ |
| `--gradient_accumulation_steps` | 1 | æ¢¯åº¦ç´¯ç§¯æ­¥æ•° |
| `--resume` | None | æ¢å¤è®­ç»ƒçš„æ£€æŸ¥ç‚¹è·¯å¾„ |
| `--save_dir` | checkpoints_feature | æ¨¡å‹ä¿å­˜ç›®å½• |
| `--log_dir` | logs_feature | TensorBoardæ—¥å¿—ç›®å½• |
| `--save_interval` | 10 | ä¿å­˜æ¨¡å‹çš„é—´éš”ï¼ˆepochï¼‰ |

---

## ğŸ“Š è®­ç»ƒç›‘æ§

### å¯åŠ¨TensorBoard

```bash
# æŸ¥çœ‹è®­ç»ƒæ—¥å¿—
tensorboard --logdir train_transformer3D/controlnetlike/logs_feature

# æŒ‡å®šç«¯å£
tensorboard --logdir train_transformer3D/controlnetlike/logs_feature --port 6006
```

### åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`http://localhost:6006`

---

## ğŸ”„ æ¢å¤è®­ç»ƒ

### ä»æ£€æŸ¥ç‚¹æ¢å¤

```bash
python train_transformer3D/controlnetlike/train_feature_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 100 \
    --lr 1e-4 \
    --resume train_transformer3D/controlnetlike/checkpoints_feature/checkpoint_epoch_50.pth \
    --use_amp \
    --save_dir train_transformer3D/controlnetlike/checkpoints_feature \
    --log_dir train_transformer3D/controlnetlike/logs_feature
```

---

## ğŸ¯ æ¨èé…ç½®æ€»ç»“

### å¿«é€Ÿæµ‹è¯•
```bash
python train_transformer3D/controlnetlike/train_feature_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 16 \
    --epochs 10
```

### æ ‡å‡†è®­ç»ƒ
```bash
python train_transformer3D/controlnetlike/train_feature_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 100 \
    --lr 1e-4 \
    --identity_loss_weight 0.3 \
    --loss_type combined \
    --use_amp
```

### ç”Ÿäº§ç¯å¢ƒï¼ˆä¸¤é˜¶æ®µè®­ç»ƒï¼‰
```bash
# é˜¶æ®µ1ï¼šå†»ç»“ä¸»ç½‘ç»œ
python train_transformer3D/controlnetlike/train_feature_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 30 \
    --lr 1e-3 \
    --freeze_main \
    --use_amp

# é˜¶æ®µ2ï¼šç«¯åˆ°ç«¯å¾®è°ƒ
python train_transformer3D/controlnetlike/train_feature_controlnet.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 70 \
    --lr 1e-4 \
    --resume checkpoints_feature_stage1/best_model.pth \
    --use_amp
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®è·¯å¾„**ï¼šç¡®ä¿ `--data_dir` æŒ‡å‘æ­£ç¡®çš„æ•°æ®ç›®å½•
2. **GPUå†…å­˜**ï¼šæ ¹æ®GPUå†…å­˜è°ƒæ•´ `--batch_size`
3. **æ··åˆç²¾åº¦**ï¼šå»ºè®®å¯ç”¨ `--use_amp` åŠ é€Ÿè®­ç»ƒ
4. **æ¢¯åº¦ç´¯ç§¯**ï¼šå¦‚æœbatch_sizeè¾ƒå°ï¼Œä½¿ç”¨ `--gradient_accumulation_steps` æ¨¡æ‹Ÿå¤§batch
5. **ä¿å­˜ç›®å½•**ï¼šç¡®ä¿ä¿å­˜ç›®å½•æœ‰å†™å…¥æƒé™

---

ç”Ÿæˆæ—¶é—´: 2024-12-16

