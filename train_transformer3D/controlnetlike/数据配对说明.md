# ControlNetæ•°æ®é›†é…å¯¹è¯´æ˜

## ğŸ“‹ æ•°æ®é…å¯¹ç­–ç•¥

ControlNetæ•°æ®é›†ä½¿ç”¨**æŒ‰äººå‘˜èº«ä»½é…å¯¹**çš„ç­–ç•¥ï¼Œç¡®ä¿è®­ç»ƒæ ·æœ¬çš„èº«ä»½ä¸€è‡´æ€§ã€‚

---

## ğŸ”„ é…å¯¹æµç¨‹

### æ­¥éª¤1ï¼šæŒ‰äººå‘˜èº«ä»½ç»„ç»‡æ•°æ®

é¦–å…ˆï¼Œå°†æ‰€æœ‰æ•°æ®æŒ‰ `person_name` åˆ†ç»„ï¼š

```python
# æ­£é¢å›¾æ•°æ®åˆ†ç»„
front_by_person = {
    'person_A': [
        {'index': 0, 'feature': ..., 'keypoints': ..., 'metadata': ...},
        {'index': 1, 'feature': ..., 'keypoints': ..., 'metadata': ...},
        ...
    ],
    'person_B': [...],
    ...
}

# è§†é¢‘å¸§æ•°æ®åˆ†ç»„
video_by_person = {
    'person_A': [
        {'index': 10, 'feature': ..., 'keypoints': ..., 'metadata': ...},
        {'index': 11, 'feature': ..., 'keypoints': ..., 'metadata': ...},
        ...
    ],
    'person_B': [...],
    ...
}
```

### æ­¥éª¤2ï¼šä¸ºæ¯ä¸ªäººæ„å»ºæ ·æœ¬å¯¹

å¯¹äºæ¯ä¸ªæœ‰æ­£é¢å›¾å’Œè§†é¢‘å¸§çš„äººå‘˜ï¼š

```python
for person_name in front_by_person.keys():
    if person_name not in video_by_person:
        continue  # è·³è¿‡æ²¡æœ‰è§†é¢‘å¸§çš„äººå‘˜
    
    front_samples = front_by_person[person_name]  # è¯¥äººçš„æ‰€æœ‰æ­£é¢å›¾
    video_samples = video_by_person[person_name]   # è¯¥äººçš„æ‰€æœ‰è§†é¢‘å¸§
```

### æ­¥éª¤3ï¼šåˆ›å»ºæ‰€æœ‰å¯èƒ½çš„é…å¯¹

**æ¨¡å‹1ï¼ˆç‰¹å¾è½¬æ¢ControlNetï¼‰**ï¼š
```python
# ä¸ºæ¯ä¸ªæ­£é¢å›¾æ‰¾åˆ°åŒ¹é…çš„è§†é¢‘å¸§
for front_sample in front_samples:
    front_feature = front_sample['feature']      # æºç‰¹å¾
    front_pose = extract_pose(front_sample['keypoints'])  # æºå§¿åŠ¿
    
    for video_sample in video_samples:
        video_feature = video_sample['feature']  # ç›®æ ‡ç‰¹å¾
        video_pose = extract_pose(video_sample['keypoints'])  # ç›®æ ‡è§’åº¦ï¼ˆæ§åˆ¶è§’åº¦ï¼‰
        
        # è®¡ç®—è§’åº¦å·®å¼‚
        angle_diff = calculate_angle_diff(front_pose, video_pose)
        
        # ç­›é€‰æœ‰æ•ˆæ ·æœ¬ï¼ˆè§’åº¦å·®å¼‚åœ¨åˆç†èŒƒå›´å†…ï¼‰
        if min_angle_diff <= angle_diff <= max_angle_diff:
            samples.append({
                'source_features': front_feature,      # æºç‰¹å¾
                'source_pose': front_pose,              # æºå§¿åŠ¿
                'target_angle': video_pose,            # æ§åˆ¶è§’åº¦
                'target_features': video_feature,       # ç›®æ ‡ç‰¹å¾ï¼ˆground truthï¼‰
                'person_name': person_name
            })
```

**æ¨¡å‹2ï¼ˆå›¾åƒç”ŸæˆControlNetï¼‰**ï¼š
```python
# ä¸ºæ¯ä¸ªæ­£é¢å›¾æ‰¾åˆ°åŒ¹é…çš„è§†é¢‘å¸§
for front_sample in front_samples:
    front_image_path = front_sample['image_path']  # æºå›¾åƒè·¯å¾„
    front_pose = extract_pose(front_sample['keypoints'])
    
    for video_sample in video_samples:
        video_image_path = video_sample['image_path']  # ç›®æ ‡å›¾åƒè·¯å¾„
        video_pose = extract_pose(video_sample['keypoints'])
        
        # è®¡ç®—è§’åº¦å·®å¼‚
        angle_diff = calculate_angle_diff(front_pose, video_pose)
        
        # ç­›é€‰æœ‰æ•ˆæ ·æœ¬
        if min_angle_diff <= angle_diff <= max_angle_diff:
            samples.append({
                'source_image_path': front_image_path,  # æºå›¾åƒ
                'target_image_path': video_image_path,  # ç›®æ ‡å›¾åƒï¼ˆground truthï¼‰
                'target_pose': video_pose,              # æ§åˆ¶å§¿åŠ¿
                'person_name': person_name
            })
```

---

## ğŸ¯ é…å¯¹ç‰¹ç‚¹

### 1. **èº«ä»½ä¸€è‡´æ€§ä¿è¯**

- âœ… æ‰€æœ‰é…å¯¹éƒ½æ¥è‡ª**åŒä¸€ä¸ªäºº**ï¼ˆ`person_name` ç›¸åŒï¼‰
- âœ… ç¡®ä¿æ¨¡å‹å­¦ä¹ çš„æ˜¯**è§’åº¦è½¬æ¢**ï¼Œè€Œä¸æ˜¯**èº«ä»½è½¬æ¢**

### 2. **å…¨é…å¯¹ç­–ç•¥**

- æ¯ä¸ªæ­£é¢å›¾ä¸**è¯¥äººçš„æ‰€æœ‰è§†é¢‘å¸§**é…å¯¹
- å¦‚æœä¸€ä¸ªäººæœ‰ `N` ä¸ªæ­£é¢å›¾å’Œ `M` ä¸ªè§†é¢‘å¸§ï¼Œä¼šäº§ç”Ÿ `N Ã— M` ä¸ªæ ·æœ¬å¯¹

**ç¤ºä¾‹**ï¼š
```
person_A:
  - æ­£é¢å›¾: 2å¼ 
  - è§†é¢‘å¸§: 10å¼ 
  - é…å¯¹æ•°é‡: 2 Ã— 10 = 20ä¸ªæ ·æœ¬å¯¹
```

### 3. **è§’åº¦å·®å¼‚ç­›é€‰**

- åªä¿ç•™è§’åº¦å·®å¼‚åœ¨åˆç†èŒƒå›´å†…çš„é…å¯¹
- é»˜è®¤èŒƒå›´ï¼š`min_angle_diff = 5.0Â°` åˆ° `max_angle_diff = 90.0Â°`
- è¿‡æ»¤æ‰è§’åº¦å·®å¼‚å¤ªå°ï¼ˆå‡ ä¹ç›¸åŒï¼‰æˆ–å¤ªå¤§ï¼ˆä¸ç›¸å…³ï¼‰çš„é…å¯¹

**è§’åº¦å·®å¼‚è®¡ç®—**ï¼š
```python
def _calculate_angle_diff(pose1, pose2):
    """è®¡ç®—ä¸¤ä¸ªå§¿åŠ¿çš„è§’åº¦å·®å¼‚ï¼ˆåº¦ï¼‰"""
    diff = pose1 - pose2  # [yaw, pitch, roll]
    angle_diff = np.linalg.norm(diff)  # æ¬§å‡ é‡Œå¾—è·ç¦»
    return angle_diff
```

---

## ğŸ“Š é…å¯¹ç¤ºä¾‹

å‡è®¾æœ‰ä»¥ä¸‹æ•°æ®ï¼š

### æ­£é¢å›¾æ•°æ®
```
person_A:
  - front_0: ç‰¹å¾[512], å§¿åŠ¿[0Â°, 0Â°, 0Â°]  (æ­£é¢)
  - front_1: ç‰¹å¾[512], å§¿åŠ¿[0Â°, 5Â°, 0Â°]  (è½»å¾®æŠ¬å¤´)

person_B:
  - front_2: ç‰¹å¾[512], å§¿åŠ¿[0Â°, 0Â°, 0Â°]  (æ­£é¢)
```

### è§†é¢‘å¸§æ•°æ®
```
person_A:
  - video_0: ç‰¹å¾[512], å§¿åŠ¿[30Â°, 0Â°, 0Â°]  (å³è½¬30Â°)
  - video_1: å§¿åŠ¿[45Â°, 0Â°, 0Â°]  (å³è½¬45Â°)
  - video_2: å§¿åŠ¿[5Â°, 0Â°, 0Â°]   (å³è½¬5Â°ï¼Œè§’åº¦å·®å¼‚å¤ªå°ï¼Œä¼šè¢«è¿‡æ»¤)

person_B:
  - video_3: ç‰¹å¾[512], å§¿åŠ¿[30Â°, 0Â°, 0Â°]  (å³è½¬30Â°)
```

### ç”Ÿæˆçš„é…å¯¹

**person_A**ï¼š
```
1. front_0 (0Â°,0Â°,0Â°) + video_0 (30Â°,0Â°,0Â°) â†’ è§’åº¦å·®å¼‚30Â° âœ“
2. front_0 (0Â°,0Â°,0Â°) + video_1 (45Â°,0Â°,0Â°) â†’ è§’åº¦å·®å¼‚45Â° âœ“
3. front_0 (0Â°,0Â°,0Â°) + video_2 (5Â°,0Â°,0Â°)  â†’ è§’åº¦å·®å¼‚5Â°  âœ— (å¤ªå°ï¼Œè¢«è¿‡æ»¤)
4. front_1 (0Â°,5Â°,0Â°) + video_0 (30Â°,0Â°,0Â°) â†’ è§’åº¦å·®å¼‚30.4Â° âœ“
5. front_1 (0Â°,5Â°,0Â°) + video_1 (45Â°,0Â°,0Â°) â†’ è§’åº¦å·®å¼‚45.3Â° âœ“
6. front_1 (0Â°,5Â°,0Â°) + video_2 (5Â°,0Â°,0Â°)  â†’ è§’åº¦å·®å¼‚5Â°  âœ— (å¤ªå°ï¼Œè¢«è¿‡æ»¤)
```

**person_B**ï¼š
```
1. front_2 (0Â°,0Â°,0Â°) + video_3 (30Â°,0Â°,0Â°) â†’ è§’åº¦å·®å¼‚30Â° âœ“
```

**æœ€ç»ˆæ ·æœ¬æ•°**ï¼š5ä¸ªï¼ˆperson_A: 4ä¸ªï¼Œperson_B: 1ä¸ªï¼‰

---

## âš™ï¸ å¯é…ç½®å‚æ•°

### è§’åº¦å·®å¼‚é˜ˆå€¼

```python
# åœ¨åˆ›å»ºæ•°æ®é›†æ—¶è®¾ç½®
dataset = FeatureControlDataset(
    data_dir='train/datas/file',
    min_angle_diff=5.0,   # æœ€å°è§’åº¦å·®å¼‚ï¼ˆåº¦ï¼‰
    max_angle_diff=90.0   # æœ€å¤§è§’åº¦å·®å¼‚ï¼ˆåº¦ï¼‰
)
```

**å»ºè®®å€¼**ï¼š
- `min_angle_diff = 5.0Â°`ï¼šè¿‡æ»¤æ‰å‡ ä¹ç›¸åŒçš„è§’åº¦ï¼ˆé¿å…å†—ä½™ï¼‰
- `max_angle_diff = 90.0Â°`ï¼šè¿‡æ»¤æ‰è§’åº¦å·®å¼‚è¿‡å¤§çš„é…å¯¹ï¼ˆå¯èƒ½ä¸ç›¸å…³ï¼‰

### æœ€å¤§æ ·æœ¬æ•°é™åˆ¶

```python
dataset = FeatureControlDataset(
    data_dir='train/datas/file',
    max_samples=10000  # é™åˆ¶æœ€å¤§æ ·æœ¬æ•°ï¼ˆç”¨äºå¿«é€Ÿæµ‹è¯•ï¼‰
)
```

---

## ğŸ” é…å¯¹ç»Ÿè®¡

è®­ç»ƒæ—¶ä¼šæ‰“å°é…å¯¹ç»Ÿè®¡ä¿¡æ¯ï¼š

```
æ­£é¢å›¾æ•°é‡: 100
è§†é¢‘å¸§æ•°é‡: 1000
æ€»æ ·æœ¬æ•°: 5000
```

**è¯´æ˜**ï¼š
- 100ä¸ªæ­£é¢å›¾ Ã— å¹³å‡50ä¸ªæœ‰æ•ˆè§†é¢‘å¸§ = 5000ä¸ªæ ·æœ¬å¯¹
- å®é™…æ•°é‡å–å†³äºè§’åº¦å·®å¼‚ç­›é€‰ç»“æœ

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æ•°æ®ä¸å¹³è¡¡

å¦‚æœæŸäº›äººå‘˜æœ‰å¾ˆå¤šè§†é¢‘å¸§ï¼Œä¼šäº§ç”Ÿå¤§é‡æ ·æœ¬å¯¹ï¼Œå¯èƒ½å¯¼è‡´ï¼š
- è®­ç»ƒåå‘è¿™äº›äººå‘˜
- å†…å­˜å ç”¨å¢åŠ 

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å¯ä»¥é™åˆ¶æ¯ä¸ªäººçš„æœ€å¤§é…å¯¹æ•°é‡
- ä½¿ç”¨åŠ æƒé‡‡æ ·å¹³è¡¡ä¸åŒäººå‘˜

### 2. è§’åº¦å·®å¼‚è®¡ç®—

å½“å‰ä½¿ç”¨ç®€åŒ–çš„è§’åº¦å·®å¼‚è®¡ç®—ï¼ˆæ¬§å‡ é‡Œå¾—è·ç¦»ï¼‰ï¼Œå¯èƒ½ä¸å¤Ÿç²¾ç¡®ã€‚

**æ”¹è¿›æ–¹å‘**ï¼š
- ä½¿ç”¨æ›´ç²¾ç¡®çš„è§’åº¦å·®å¼‚è®¡ç®—ï¼ˆè€ƒè™‘è§’åº¦å‘¨æœŸæ€§ï¼‰
- åˆ†åˆ«è€ƒè™‘ yawã€pitchã€roll çš„å·®å¼‚

### 3. é…å¯¹è´¨é‡

ç¡®ä¿ï¼š
- âœ… å…ƒæ•°æ®ä¸­åŒ…å«æ­£ç¡®çš„ `person_name`
- âœ… å…³é”®ç‚¹æ•°æ®è´¨é‡è‰¯å¥½ï¼ˆç”¨äºæå–å§¿åŠ¿ï¼‰
- âœ… è§’åº¦å·®å¼‚ç­›é€‰èŒƒå›´åˆç†

---

## ğŸ“ æ€»ç»“

ControlNetæ•°æ®é›†çš„é…å¯¹ç­–ç•¥ï¼š

1. **æŒ‰äººå‘˜èº«ä»½åˆ†ç»„**ï¼šç¡®ä¿èº«ä»½ä¸€è‡´æ€§
2. **å…¨é…å¯¹ç­–ç•¥**ï¼šæ¯ä¸ªæ­£é¢å›¾ä¸æ‰€æœ‰è§†é¢‘å¸§é…å¯¹
3. **è§’åº¦å·®å¼‚ç­›é€‰**ï¼šåªä¿ç•™åˆç†çš„è§’åº¦å·®å¼‚é…å¯¹
4. **å¯é…ç½®å‚æ•°**ï¼šæ”¯æŒè°ƒæ•´è§’åº¦å·®å¼‚é˜ˆå€¼å’Œæœ€å¤§æ ·æœ¬æ•°

è¿™ç§é…å¯¹ç­–ç•¥ç¡®ä¿äº†ï¼š
- âœ… æ¨¡å‹å­¦ä¹ çš„æ˜¯**è§’åº¦è½¬æ¢**ï¼Œè€Œä¸æ˜¯**èº«ä»½è½¬æ¢**
- âœ… è®­ç»ƒæ•°æ®ä¸°å¯Œï¼ˆå……åˆ†åˆ©ç”¨æ‰€æœ‰å¯èƒ½çš„é…å¯¹ï¼‰
- âœ… æ•°æ®è´¨é‡å¯æ§ï¼ˆé€šè¿‡è§’åº¦å·®å¼‚ç­›é€‰ï¼‰

