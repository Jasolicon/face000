# æ•°æ®å½’ä¸€åŒ–æ–¹å¼è¯´æ˜

## ğŸ¯ å½“å‰å½’ä¸€åŒ–æ–¹å¼

### æ ¸å¿ƒåŸåˆ™

**ä½¿ç”¨æ¯å¼ å›¾ç‰‡è‡ªå·±çš„ä¸­å¿ƒç‚¹ä½œä¸ºé›¶ç‚¹**ï¼Œè€Œä¸æ˜¯å…¨å±€æ ‡å‡†ä¸­å¿ƒç‚¹ã€‚

### å½’ä¸€åŒ–æ­¥éª¤

1. **è®¡ç®—å›¾ç‰‡è‡ªå·±çš„ä¸­å¿ƒç‚¹**ï¼š
   ```python
   image_center = np.mean(landmarks_3d, axis=0)  # [3] - 5ä¸ªå…³é”®ç‚¹çš„å¹³å‡å€¼
   ```

2. **è®¡ç®—ç›¸å¯¹åæ ‡**ï¼š
   ```python
   relative_landmarks = landmarks_3d - image_center  # [5, 3] - ç›¸å¯¹äºä¸­å¿ƒç‚¹çš„åæ ‡
   ```

3. **å½’ä¸€åŒ–**ï¼ˆä½¿ç”¨æ ‡å‡†å°ºåº¦ï¼‰ï¼š
   ```python
   normalized = relative_landmarks * standard_scale  # [5, 3]
   ```

### ä¼˜åŠ¿

1. **æ¶ˆé™¤ä½ç½®å·®å¼‚**ï¼šä¸åŒå›¾ç‰‡çš„äººè„¸ä½ç½®ä¸åŒï¼Œä½¿ç”¨è‡ªå·±çš„ä¸­å¿ƒç‚¹å¯ä»¥æ¶ˆé™¤è¿™ç§å·®å¼‚
2. **ä¿ç•™å½¢çŠ¶ä¿¡æ¯**ï¼šåªä¿ç•™å…³é”®ç‚¹ä¹‹é—´çš„ç›¸å¯¹ä½ç½®å…³ç³»ï¼ˆå½¢çŠ¶ä¿¡æ¯ï¼‰
3. **é¿å…åç§»**ï¼šä¸ä¼šå› ä¸ºå›¾ç‰‡ä½ç½®ä¸å…¨å±€ä¸­å¿ƒç‚¹ä¸ä¸€è‡´è€Œäº§ç”Ÿåç§»
4. **æ›´ç¬¦åˆå½’ä¸€åŒ–ç›®çš„**ï¼šå½’ä¸€åŒ–çš„ç›®çš„æ˜¯æ¶ˆé™¤ä½ç½®ä¿¡æ¯ï¼Œä¿ç•™å½¢çŠ¶ä¿¡æ¯

### æ ‡å‡†å°ºåº¦çš„è®¡ç®—

æ ‡å‡†å°ºåº¦ä»ç„¶ä»æ‰€æœ‰æ­£é¢å›¾è®¡ç®—ï¼Œä½†è®¡ç®—æ–¹å¼æœ‰æ‰€æ”¹å˜ï¼š

1. å¯¹æ¯ä¸ªæ­£é¢å›¾ï¼Œå…ˆè®¡ç®—è‡ªå·±çš„ä¸­å¿ƒç‚¹
2. è®¡ç®—ç›¸å¯¹äºè‡ªå·±ä¸­å¿ƒç‚¹çš„åæ ‡
3. è®¡ç®—æ‰€æœ‰ç›¸å¯¹åæ ‡çš„å¹³å‡å€¼
4. ä½¿ç”¨å¹³å‡ç›¸å¯¹åæ ‡çš„æœ€å¤§è·ç¦»è®¡ç®—å½’ä¸€åŒ–å°ºåº¦

è¿™æ ·å¯ä»¥ç¡®ä¿ï¼š
- æ‰€æœ‰å›¾ç‰‡ä½¿ç”¨ç›¸åŒçš„å½’ä¸€åŒ–å°ºåº¦ï¼ˆä¿æŒä¸€è‡´æ€§ï¼‰
- ä½†ä½¿ç”¨è‡ªå·±çš„ä¸­å¿ƒç‚¹ä½œä¸ºé›¶ç‚¹ï¼ˆæ¶ˆé™¤ä½ç½®å·®å¼‚ï¼‰

## ğŸ“ ä»£ç å®ç°

### Landmark3DAligner ç±»

```python
def align_and_normalize(self, landmarks_3d: np.ndarray, use_self_center: bool = True) -> np.ndarray:
    """
    å¯¹é½å’Œå½’ä¸€åŒ–3Då…³é”®ç‚¹
    
    Args:
        landmarks_3d: 3Då…³é”®ç‚¹ [5, 3]
        use_self_center: æ˜¯å¦ä½¿ç”¨å›¾ç‰‡è‡ªå·±çš„ä¸­å¿ƒç‚¹ï¼ˆé»˜è®¤Trueï¼‰
    
    Returns:
        aligned_normalized: å¯¹é½å’Œå½’ä¸€åŒ–åçš„å…³é”®ç‚¹ [5, 3]
    """
    if use_self_center:
        # ä½¿ç”¨è¯¥å›¾ç‰‡è‡ªå·±çš„ä¸­å¿ƒç‚¹ä½œä¸ºé›¶ç‚¹
        image_center = np.mean(landmarks_3d, axis=0)  # [3]
        aligned = landmarks_3d - image_center  # [5, 3]
    else:
        # ä½¿ç”¨å…¨å±€æ ‡å‡†ä¸­å¿ƒç‚¹ï¼ˆä¸æ¨èï¼‰
        aligned = landmarks_3d - self.standard_center
    
    # å½’ä¸€åŒ–ï¼šä¹˜ä»¥æ ‡å‡†å°ºåº¦
    normalized = aligned * self.standard_scale
    
    return normalized
```

## ğŸ”„ é‡æ–°ç”Ÿæˆæ•°æ®

å¦‚æœéœ€è¦é‡æ–°ç”Ÿæˆæ•°æ®ä»¥åº”ç”¨æ–°çš„å½’ä¸€åŒ–æ–¹å¼ï¼š

```bash
python train_transformer3D/extract_and_align_3d_data.py \
    --face_dir train/datas/face \
    --video_dir train/datas/video \
    --output_dir train/datas/file \
    --force_reprocess
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹æ€§**ï¼šä»£ç ä¿ç•™äº† `standard_center` çš„è®¡ç®—å’Œä¿å­˜ï¼Œä½†ä¸å†ä½¿ç”¨å®ƒè¿›è¡Œå½’ä¸€åŒ–
2. **æ•°æ®ä¸€è‡´æ€§**ï¼šå¦‚æœé‡æ–°ç”Ÿæˆæ•°æ®ï¼Œéœ€è¦ç¡®ä¿æ‰€æœ‰æ•°æ®ä½¿ç”¨ç›¸åŒçš„å½’ä¸€åŒ–æ–¹å¼
3. **è®­ç»ƒå½±å“**ï¼šä½¿ç”¨æ–°çš„å½’ä¸€åŒ–æ–¹å¼åï¼Œæ¨¡å‹éœ€è¦é‡æ–°è®­ç»ƒ

## ğŸ“Š å¯¹æ¯”

### æ—§æ–¹å¼ï¼ˆä½¿ç”¨å…¨å±€æ ‡å‡†ä¸­å¿ƒç‚¹ï¼‰

```python
# æ‰€æœ‰å›¾ç‰‡éƒ½å‡å»åŒä¸€ä¸ªå…¨å±€ä¸­å¿ƒç‚¹
aligned = landmarks_3d - global_standard_center
normalized = aligned * standard_scale
```

**é—®é¢˜**ï¼šå¦‚æœå›¾ç‰‡ä½ç½®ä¸å…¨å±€ä¸­å¿ƒç‚¹ä¸ä¸€è‡´ï¼Œå½’ä¸€åŒ–åä¼šäº§ç”Ÿåç§»

### æ–°æ–¹å¼ï¼ˆä½¿ç”¨å›¾ç‰‡è‡ªå·±çš„ä¸­å¿ƒç‚¹ï¼‰

```python
# æ¯å¼ å›¾ç‰‡å‡å»è‡ªå·±çš„ä¸­å¿ƒç‚¹
image_center = np.mean(landmarks_3d, axis=0)
aligned = landmarks_3d - image_center
normalized = aligned * standard_scale
```

**ä¼˜åŠ¿**ï¼šæ¶ˆé™¤ä½ç½®å·®å¼‚ï¼Œåªä¿ç•™å½¢çŠ¶ä¿¡æ¯ï¼Œä¸ä¼šäº§ç”Ÿåç§»
