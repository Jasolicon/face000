# TransformerEncoderDecoder3D ç¼–ç å™¨-è§£ç å™¨æ¨¡å‹è¯´æ˜

## ğŸ“ æ¨¡å‹æ¶æ„

### æ•´ä½“ç»“æ„

```
è¾“å…¥
â”œâ”€â”€ src [batch, 512] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”œâ”€â”€ keypoints_3d [batch, 5, 3] â”‚
â””â”€â”€ pose [batch, 3] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    [ç¼–ç å™¨éƒ¨åˆ†]
    â”œâ”€â”€ ä¾§é¢ç‰¹å¾æŠ•å½±
    â”œâ”€â”€ 3Då…³é”®ç‚¹ç¼–ç ï¼ˆæ¯ä¸ªå…³é”®ç‚¹ â†’ d_modelç»´å‘é‡ï¼‰
    â”œâ”€â”€ å…³é”®ç‚¹ä½ç½®ç¼–ç ï¼ˆå¯å­¦ä¹ çš„ï¼‰
    â””â”€â”€ Transformerç¼–ç å™¨
        â†“
    memory [batch, 6, 512]  # 1ä¸ªä¾§é¢ç‰¹å¾ + 5ä¸ªå…³é”®ç‚¹
        â†“
    [è§£ç å™¨éƒ¨åˆ†]
    â”œâ”€â”€ è§£ç å™¨è¾“å…¥æŠ•å½±
    â”œâ”€â”€ å§¿æ€ä½ç½®ç¼–ç ï¼ˆæ­£å¼¦/ä½™å¼¦ç¼–ç ï¼‰
    â”œâ”€â”€ è§’åº¦ä½ç½®ç¼–ç ï¼ˆå¢å¼ºï¼‰
    â”œâ”€â”€ è§’åº¦æ¡ä»¶å½’ä¸€åŒ–
    â””â”€â”€ Transformerè§£ç å™¨
        â†“
    è¾“å‡º [batch, 512]
```

## ğŸ”‘ æ ¸å¿ƒè®¾è®¡

### 1. **ç¼–ç å™¨éƒ¨åˆ†**

#### è¾“å…¥
- **ä¾§é¢ç‰¹å¾** (`src`): `[batch, 512]` - InsightFaceæå–çš„ä¾§é¢äººè„¸ç‰¹å¾
- **3Då…³é”®ç‚¹** (`keypoints_3d`): `[batch, 5, 3]` - 5ä¸ªå…³é”®ç‚¹çš„3Dåæ ‡

#### å¤„ç†æµç¨‹
1. **ä¾§é¢ç‰¹å¾æŠ•å½±**ï¼š
   ```python
   src_features = input_projection(src)  # [batch, 512] â†’ [batch, 512]
   src_features = src_features.unsqueeze(1)  # [batch, 1, 512]
   ```

2. **3Då…³é”®ç‚¹ç¼–ç **ï¼š
   ```python
   # æ¯ä¸ªå…³é”®ç‚¹ç‹¬ç«‹ç¼–ç 
   keypoint_features = keypoint_encoder(keypoints_3d)  # [batch, 5, 512]
   # æ·»åŠ å¯å­¦ä¹ çš„ä½ç½®ç¼–ç ï¼ˆåŒºåˆ†ä¸åŒå…³é”®ç‚¹ï¼‰
   keypoint_features = keypoint_features + keypoint_pos_encoding  # [batch, 5, 512]
   ```

3. **ç»„åˆè¾“å…¥**ï¼š
   ```python
   encoder_input = [src_features, keypoint_features]  # [batch, 6, 512]
   # åºåˆ—ï¼šä¾§é¢ç‰¹å¾(ä½ç½®0) + 5ä¸ªå…³é”®ç‚¹(ä½ç½®1-5)
   ```

4. **Transformerç¼–ç **ï¼š
   ```python
   encoder_output = TransformerEncoder(encoder_input)  # [batch, 6, 512]
   # ç¼–ç åçš„ä¾§é¢ç‰¹å¾ï¼šencoder_output[:, 0, :]
   # ç¼–ç åçš„å…³é”®ç‚¹ä¿¡æ¯ï¼šencoder_output[:, 1:, :]
   ```

### 2. **è§£ç å™¨éƒ¨åˆ†**

#### Memoryï¼ˆæ¥è‡ªç¼–ç å™¨ï¼‰
- **å®Œæ•´ç¼–ç å™¨è¾“å‡º** (`memory`): `[batch, 6, 512]`
  - åŒ…å«ç¼–ç åçš„ä¾§é¢ç‰¹å¾å’Œå…³é”®ç‚¹ä¿¡æ¯
  - ä½œä¸ºè§£ç å™¨çš„"è®°å¿†"ï¼Œæä¾›ä¸Šä¸‹æ–‡ä¿¡æ¯

#### è§£ç å™¨è¾“å…¥
- **ç¼–ç åçš„ä¾§é¢ç‰¹å¾** (`encoded_src`): `[batch, 512]`
- **å§¿æ€å‘é‡** (`pose`): `[batch, 3]` - æ¬§æ‹‰è§’ï¼ˆyaw, pitch, rollï¼‰

#### å¤„ç†æµç¨‹
1. **è§£ç å™¨è¾“å…¥æŠ•å½±**ï¼š
   ```python
   decoder_input = decoder_input_projection(encoded_src)  # [batch, 512]
   decoder_input = decoder_input.unsqueeze(1)  # [batch, 1, 512]
   ```

2. **æ·»åŠ ä½ç½®ç¼–ç **ï¼ˆå…³é”®æ­¥éª¤ï¼‰ï¼š
   ```python
   # å§¿æ€ä½ç½®ç¼–ç ï¼ˆæ­£å¼¦/ä½™å¼¦ç¼–ç ï¼‰
   pose_pe = pose_pe(pose)  # [batch, 512]
   decoder_input = decoder_input + pose_pe  # å§¿æ€ä¿¡æ¯æ³¨å…¥
   
   # è§’åº¦ä½ç½®ç¼–ç ï¼ˆå¢å¼ºï¼‰
   angle_pe = angle_pe(pose)  # [batch, 512]
   decoder_input = decoder_input + angle_pe  # è§’åº¦ä¿¡æ¯æ³¨å…¥
   ```

3. **è§’åº¦æ¡ä»¶å½’ä¸€åŒ–**ï¼š
   ```python
   decoder_input = angle_conditioned_norm(decoder_input, pose)
   # æ ¹æ®å§¿æ€åŠ¨æ€è°ƒæ•´å½’ä¸€åŒ–å‚æ•°
   ```

4. **Transformerè§£ç **ï¼š
   ```python
   decoder_output = TransformerDecoder(
       tgt=decoder_input,      # [batch, 1, 512] - å¸¦ä½ç½®ç¼–ç çš„è¾“å…¥
       memory=memory,          # [batch, 6, 512] - ç¼–ç å™¨è¾“å‡º
       tgt_mask=tgt_mask,
       memory_mask=src_mask
   )
   # è§£ç å™¨é€šè¿‡äº¤å‰æ³¨æ„åŠ›å…³æ³¨ç¼–ç å™¨çš„è¾“å‡ºï¼ˆä¾§é¢ç‰¹å¾+å…³é”®ç‚¹ï¼‰
   ```

5. **è¾“å‡ºæŠ•å½±**ï¼š
   ```python
   residual = output_projection(decoder_output)  # [batch, 512]
   output = src + residual  # æ®‹å·®è¿æ¥
   ```

## ğŸ¯ ä½ç½®ç¼–ç è®¾è®¡

### å§¿æ€ä½ç½®ç¼–ç  (`PoseAndAnglePositionalEncoding`)

**è®¾è®¡æ€è·¯**ï¼š
- å°†å§¿æ€ï¼ˆæ¬§æ‹‰è§’ï¼‰è½¬æ¢ä¸ºä½ç½®ç¼–ç 
- ä½¿ç”¨æ­£å¼¦/ä½™å¼¦ç¼–ç ï¼Œä¿æŒè§’åº¦çš„å‘¨æœŸæ€§
- å¯å­¦ä¹ çš„ç¼©æ”¾å› å­ï¼Œè®©æ¨¡å‹è‡ªé€‚åº”è°ƒæ•´

**å®ç°**ï¼š
```python
# 1. è§’åº¦å½’ä¸€åŒ–ï¼ˆå‡è®¾è¾“å…¥æ˜¯åº¦ï¼ŒèŒƒå›´Â±90åº¦ï¼‰
pose_normalized = tanh(pose / 90.0)  # å½’ä¸€åŒ–åˆ°[-1, 1]

# 2. æ­£å¼¦/ä½™å¼¦ç¼–ç 
pose_sin = sin(pose_normalized * Ï€)  # å‘¨æœŸæ€§ç¼–ç 
pose_cos = cos(pose_normalized * Ï€)

# 3. æ‹¼æ¥å¹¶æŠ•å½±
pose_encoded = [pose_sin, pose_cos]  # [batch, 6] (3ä¸ªè§’åº¦ Ã— 2)
pos_encoding = MLP(pose_encoded)    # [batch, 512]
```

### å…³é”®ç‚¹ä½ç½®ç¼–ç 

**è®¾è®¡æ€è·¯**ï¼š
- æ¯ä¸ªå…³é”®ç‚¹æœ‰ç‹¬ç«‹çš„ä½ç½®ç¼–ç 
- å¯å­¦ä¹ çš„å‚æ•°ï¼Œè®©æ¨¡å‹å­¦ä¹ å…³é”®ç‚¹çš„é¡ºåºå’Œé‡è¦æ€§

**å®ç°**ï¼š
```python
keypoint_pos_encoding = nn.Parameter(torch.zeros(5, 512))
# æ¯ä¸ªå…³é”®ç‚¹æœ‰ç‹¬ç«‹çš„512ç»´ä½ç½®ç¼–ç 
```

## ğŸ”„ ä¸Decoder-Onlyæ¨¡å‹çš„å¯¹æ¯”

| ç‰¹æ€§ | Decoder-Only | Encoder-Decoder |
|------|--------------|-----------------|
| **æ¶æ„** | ä»…è§£ç å™¨ | ç¼–ç å™¨ + è§£ç å™¨ |
| **å…³é”®ç‚¹å¤„ç†** | èåˆåˆ°ç‰¹å¾ | ä½œä¸ºåºåˆ—è¾“å…¥ç¼–ç å™¨ |
| **ä½ç½®ç¼–ç ** | è§’åº¦/å§¿æ€æ¡ä»¶ | å§¿æ€ä½œä¸ºè§£ç å™¨ä½ç½®ç¼–ç  |
| **æ³¨æ„åŠ›æœºåˆ¶** | è‡ªæ³¨æ„åŠ› | ç¼–ç å™¨è‡ªæ³¨æ„åŠ› + è§£ç å™¨äº¤å‰æ³¨æ„åŠ› |
| **å‚æ•°é‡** | è¾ƒå°‘ | è¾ƒå¤šï¼ˆç¼–ç å™¨+è§£ç å™¨ï¼‰ |
| **è¡¨è¾¾èƒ½åŠ›** | ä¸­ç­‰ | æ›´å¼ºï¼ˆæ›´ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ï¼‰ |

## ğŸ“Š æ•°æ®æµç¤ºä¾‹

### è¾“å…¥
```python
src = torch.randn(4, 512)              # 4ä¸ªæ ·æœ¬ï¼Œä¾§é¢ç‰¹å¾
keypoints_3d = torch.randn(4, 5, 3)   # 4ä¸ªæ ·æœ¬ï¼Œ5ä¸ªå…³é”®ç‚¹
pose = torch.tensor([[30.0, 10.0, 5.0], ...])  # 4ä¸ªæ ·æœ¬ï¼Œå§¿æ€
```

### ç¼–ç å™¨å¤„ç†
```python
# 1. ç¼–ç ä¾§é¢ç‰¹å¾
src_features = [4, 1, 512]

# 2. ç¼–ç å…³é”®ç‚¹
keypoint_features = [4, 5, 512]

# 3. ç»„åˆ
encoder_input = [4, 6, 512]  # 1ä¸ªç‰¹å¾ + 5ä¸ªå…³é”®ç‚¹

# 4. Transformerç¼–ç 
encoder_output = [4, 6, 512]
memory = encoder_output  # ä½œä¸ºè§£ç å™¨çš„memory
```

### è§£ç å™¨å¤„ç†
```python
# 1. æå–ç¼–ç åçš„ä¾§é¢ç‰¹å¾
encoded_src = encoder_output[:, 0, :]  # [4, 512]

# 2. å‡†å¤‡è§£ç å™¨è¾“å…¥
decoder_input = decoder_input_projection(encoded_src)  # [4, 512]
decoder_input = decoder_input.unsqueeze(1)  # [4, 1, 512]

# 3. æ·»åŠ ä½ç½®ç¼–ç 
pose_pe = pose_pe(pose)  # [4, 512]
angle_pe = angle_pe(pose)  # [4, 512]
decoder_input = decoder_input + pose_pe.unsqueeze(1) + angle_pe.unsqueeze(1)

# 4. Transformerè§£ç 
decoder_output = TransformerDecoder(
    tgt=decoder_input,  # [4, 1, 512]
    memory=memory       # [4, 6, 512]
)  # [4, 1, 512]

# 5. è¾“å‡º
output = src + output_projection(decoder_output.squeeze(1))  # [4, 512]
```

## ğŸš€ ä½¿ç”¨æ–¹å¼

### è®­ç»ƒå‘½ä»¤

```bash
python train_transformer3D/train_3d.py \
    --model_type encoder_decoder \
    --num_encoder_layers 4 \
    --num_decoder_layers 4 \
    --use_pose_pe \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 150 \
    --lr 1e-4 \
    --warmup_epochs 10 \
    --scheduler_type cosine \
    --use_mixed_precision
```

### å…³é”®å‚æ•°

- `--model_type encoder_decoder`: ä½¿ç”¨ç¼–ç å™¨-è§£ç å™¨æ¶æ„
- `--num_encoder_layers 4`: ç¼–ç å™¨å±‚æ•°
- `--num_decoder_layers 4`: è§£ç å™¨å±‚æ•°
- `--use_pose_pe`: ä½¿ç”¨å§¿æ€ä½ç½®ç¼–ç ï¼ˆé»˜è®¤Trueï¼‰

## ğŸ’¡ ä¼˜åŠ¿

1. **æ›´å¼ºçš„è¡¨è¾¾èƒ½åŠ›**ï¼š
   - ç¼–ç å™¨å¯ä»¥å……åˆ†ç†è§£ä¾§é¢ç‰¹å¾å’Œå…³é”®ç‚¹çš„å…³ç³»
   - è§£ç å™¨é€šè¿‡äº¤å‰æ³¨æ„åŠ›å…³æ³¨ç¼–ç å™¨çš„æ‰€æœ‰ä¿¡æ¯

2. **æ›´ä¸°å¯Œçš„ä¸Šä¸‹æ–‡**ï¼š
   - å…³é”®ç‚¹ä½œä¸ºåºåˆ—è¾“å…¥ï¼Œæ¨¡å‹å¯ä»¥å­¦ä¹ å…³é”®ç‚¹ä¹‹é—´çš„å…³ç³»
   - ç¼–ç å™¨è¾“å‡ºåŒ…å«èåˆåçš„ç‰¹å¾å’Œå…³é”®ç‚¹ä¿¡æ¯

3. **ä½ç½®ç¼–ç æ›´ç²¾ç¡®**ï¼š
   - å§¿æ€ç›´æ¥ä½œä¸ºè§£ç å™¨çš„ä½ç½®ç¼–ç 
   - è§’åº¦ä¿¡æ¯é€šè¿‡æ¡ä»¶å½’ä¸€åŒ–æ·±å…¥å½±å“ç‰¹å¾

4. **æ›´ç¬¦åˆTransformerè®¾è®¡**ï¼š
   - æ ‡å‡†çš„ç¼–ç å™¨-è§£ç å™¨æ¶æ„
   - å……åˆ†åˆ©ç”¨äº¤å‰æ³¨æ„åŠ›æœºåˆ¶

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‚æ•°é‡å¢åŠ **ï¼šç¼–ç å™¨-è§£ç å™¨æ¨¡å‹å‚æ•°é‡çº¦ä¸ºDecoder-Onlyçš„1.5-2å€
2. **è®¡ç®—é‡å¢åŠ **ï¼šéœ€è¦ç¼–ç å™¨å’Œè§£ç å™¨çš„åŒé‡è®¡ç®—
3. **æ˜¾å­˜å ç”¨**ï¼šmemoryéœ€è¦ä¿å­˜ç¼–ç å™¨è¾“å‡ºï¼Œæ˜¾å­˜å ç”¨æ›´å¤§
4. **è®­ç»ƒæ—¶é—´**ï¼šå¯èƒ½éœ€è¦æ›´é•¿çš„è®­ç»ƒæ—¶é—´æ‰èƒ½æ”¶æ•›

## ğŸ“ˆ é€‚ç”¨åœºæ™¯

**æ¨èä½¿ç”¨ç¼–ç å™¨-è§£ç å™¨æ¶æ„å½“**ï¼š
- æ•°æ®é‡å……è¶³
- æ˜¾å­˜å……è¶³
- è¿½æ±‚æœ€ä½³æ€§èƒ½
- ç›¸ä¼¼åº¦ç“¶é¢ˆéš¾ä»¥çªç ´ï¼ˆå¦‚å¡åœ¨0.75ï¼‰

**æ¨èä½¿ç”¨Decoder-Onlyæ¶æ„å½“**ï¼š
- èµ„æºæœ‰é™
- éœ€è¦å¿«é€Ÿè¿­ä»£
- æ¨¡å‹å·²ç»è¡¨ç°è‰¯å¥½
