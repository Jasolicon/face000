# è§’åº¦æ¡ä»¶ä»¿å°„å˜æ¢æ¨¡å‹è¯´æ˜

## ğŸ“ æ ¸å¿ƒæ€æƒ³

**å°†è§’åº¦å˜åŒ–å»ºæ¨¡ä¸ºç‰¹å¾ç©ºé—´çš„ä»¿å°„å˜æ¢ï¼Œç”¨ç¥ç»ç½‘ç»œå­¦ä¹ è¿™ä¸ªå˜æ¢çŸ©é˜µã€‚**

ç›¸æ¯”ä¼ ç»Ÿçš„Transformeræ¶æ„ï¼Œè¿™ä¸ªæ–¹æ¡ˆï¼š
- âœ… **æ›´é«˜æ•ˆ**ï¼šå‚æ•°é‡å‡å°‘50%ä»¥ä¸Š
- âœ… **æ›´ç¨³å®š**ï¼šé¿å…Transformerçš„æ¢¯åº¦ä¸ç¨³å®šé—®é¢˜
- âœ… **æ›´å¯è§£é‡Š**ï¼šå˜æ¢çŸ©é˜µå¯ä»¥ç›´æ¥å¯è§†åŒ–åˆ†æ
- âœ… **æ›´ä¼˜é›…**ï¼šç›´æ¥æŠ“ä½é—®é¢˜çš„æœ¬è´¨

## ğŸ—ï¸ æ¨¡å‹æ¶æ„

### 1. **AngleConditionedFeatureWarping**ï¼ˆæ ¸å¿ƒæ¨¡å—ï¼‰

```python
è¾“å…¥: ä¾§é¢ç‰¹å¾ [batch, 512] + è§’åº¦ [batch, 3]
è¾“å‡º: æ­£é¢ç‰¹å¾ [batch, 512]
```

**æ ¸å¿ƒå…¬å¼**ï¼š
```
frontal = scale âŠ™ side_features + translation
```

**å¤„ç†æµç¨‹**ï¼š
1. **è§’åº¦åˆ°å˜æ¢å‚æ•°**ï¼šé€šè¿‡MLPå°†è§’åº¦è½¬æ¢ä¸ºç¼©æ”¾å’Œå¹³ç§»å‚æ•°
2. **ä»¿å°„å˜æ¢**ï¼šåº”ç”¨ `scale * features + translation`
3. **ç‰¹å¾åŸºé‡å»º**ï¼ˆå¯é€‰ï¼‰ï¼šä½¿ç”¨å¯å­¦ä¹ çš„åŸºå‘é‡é‡å»ºæ­£é¢ç‰¹å¾
4. **æ®‹å·®ç»†åŒ–**ï¼ˆå¯é€‰ï¼‰ï¼šé€šè¿‡æ®‹å·®ç½‘ç»œè¿›ä¸€æ­¥ç²¾ä¿®

### 2. **FinalRecommendedModel**ï¼ˆé›†æˆæ¨¡å‹ï¼‰

```python
è¾“å…¥: ä¾§é¢ç‰¹å¾ + è§’åº¦
  â†“
è§’åº¦æ¡ä»¶ç‰¹å¾å˜æ¢ (AngleConditionedFeatureWarping)
  â†“
è‡ªæ³¨æ„åŠ›ç²¾ä¿® (SelfAttentionBlock) [å¯é€‰]
  â†“
è¾“å‡ºæŠ•å½±
  â†“
è¾“å‡º: æ­£é¢ç‰¹å¾
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### è®­ç»ƒå‘½ä»¤

```bash
python train_transformer3D/train_3d.py \
    --model_type angle_warping \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 150 \
    --lr 1e-4 \
    --warmup_epochs 10 \
    --scheduler_type cosine \
    --cosine_eta_min 1e-5 \
    --weight_decay 1e-4 \
    --dropout 0.1 \
    --mse_weight 0.1 \
    --cosine_weight 0.9 \
    --hidden_dim 256 \
    --num_basis 32 \
    --use_basis \
    --use_refinement \
    --use_attention_refine \
    --num_attention_layers 1 \
    --use_mixed_precision
```

### å…³é”®å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--model_type angle_warping` | - | ä½¿ç”¨è§’åº¦æ¡ä»¶ä»¿å°„å˜æ¢æ¨¡å‹ |
| `--hidden_dim` | 256 | éšè—å±‚ç»´åº¦ |
| `--num_basis` | 32 | ç‰¹å¾åŸºå‘é‡æ•°é‡ |
| `--use_basis` | True | ä½¿ç”¨ç‰¹å¾åŸºé‡å»º |
| `--use_refinement` | True | ä½¿ç”¨æ®‹å·®ç»†åŒ– |
| `--use_attention_refine` | True | ä½¿ç”¨è‡ªæ³¨æ„åŠ›ç²¾ä¿® |
| `--num_attention_layers` | 1 | è‡ªæ³¨æ„åŠ›å±‚æ•° |

### ç®€åŒ–ç‰ˆæœ¬ï¼ˆæœ€å¿«ï¼‰

```bash
python train_transformer3D/train_3d.py \
    --model_type angle_warping \
    --no_basis \
    --no_refinement \
    --no_attention_refine \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 150 \
    --lr 1e-4
```

## ğŸ“Š æ¨¡å‹å¯¹æ¯”

### å‚æ•°é‡å¯¹æ¯”

| æ¨¡å‹ | å‚æ•°é‡ | ç›¸å¯¹Transformer |
|------|--------|-----------------|
| TransformerDecoderOnly3D | ~15M | 100% |
| TransformerEncoderDecoder3D | ~25M | 167% |
| **FinalRecommendedModelï¼ˆå®Œæ•´ï¼‰** | **~8M** | **53%** |
| **FinalRecommendedModelï¼ˆç®€åŒ–ï¼‰** | **~3M** | **20%** |

### è®¡ç®—å¤æ‚åº¦å¯¹æ¯”

| æ¨¡å‹ | å‰å‘ä¼ æ’­å¤æ‚åº¦ | å†…å­˜å ç”¨ |
|------|----------------|----------|
| TransformerDecoderOnly3D | O(nÂ²) | é«˜ |
| TransformerEncoderDecoder3D | O(nÂ²) | å¾ˆé«˜ |
| **FinalRecommendedModel** | **O(n)** | **ä½** |

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### 1. **ç†è®ºä¼˜é›…**
- å°†è§’åº¦å˜æ¢æ˜ç¡®å»ºæ¨¡ä¸ºç‰¹å¾ç©ºé—´ä»¿å°„å˜æ¢
- å…¬å¼æ¸…æ™°ï¼š`frontal = scale âŠ™ side + translation`
- å¯è§£é‡Šæ€§å¼ºï¼šå˜æ¢çŸ©é˜µå¯ä»¥ç›´æ¥å¯è§†åŒ–

### 2. **è®¡ç®—é«˜æ•ˆ**
- å‚æ•°é‡å‡å°‘50%ä»¥ä¸Š
- å‰å‘ä¼ æ’­å¤æ‚åº¦ä»O(nÂ²)é™åˆ°O(n)
- è®­ç»ƒå’Œæ¨ç†é€Ÿåº¦æ›´å¿«

### 3. **è®­ç»ƒç¨³å®š**
- é¿å…Transformerçš„æ¢¯åº¦ä¸ç¨³å®šé—®é¢˜
- ä¸éœ€è¦å¤æ‚çš„warmupç­–ç•¥
- æ”¶æ•›æ›´å¿«

### 4. **æ‰©å±•æ€§å¥½**
- å®¹æ˜“æ·»åŠ å¤šè§†è§’èåˆ
- å®¹æ˜“æ·»åŠ å‡ ä½•çº¦æŸ
- å®¹æ˜“ä¸å…¶ä»–æ¨¡å—ç»„åˆ

## ğŸ”¬ æŠ€æœ¯ç»†èŠ‚

### 1. è§’åº¦åˆ°å˜æ¢å‚æ•°çš„ç”Ÿæˆ

```python
è§’åº¦ [batch, 3] 
  â†’ MLP(128 â†’ 256 â†’ 1024)
  â†’ ç¼©æ”¾å‚æ•° [batch, 512] (sigmoid * 2, èŒƒå›´0-2)
  â†’ å¹³ç§»å‚æ•° [batch, 512]
```

### 2. ç‰¹å¾åŸºé‡å»ºï¼ˆå¯é€‰ï¼‰

```python
# 32ä¸ªå¯å­¦ä¹ çš„åŸºå‘é‡
feature_basis: [32, 512]

# é€šè¿‡æ³¨æ„åŠ›é€‰æ‹©é‡è¦åŸºå‘é‡
basis_weights = attention(features, angles)  # [batch, 32]

# é‡å»ºæ­£é¢ç‰¹å¾
basis_features = einsum('bk,kd->bd', basis_weights, feature_basis)
```

### 3. è‡ªæ³¨æ„åŠ›ç²¾ä¿®ï¼ˆå¯é€‰ï¼‰

```python
# è½»é‡è‡ªæ³¨æ„åŠ›ï¼ˆä»…1å±‚ï¼‰
attended = MultiheadAttention(features)
refined = LayerNorm(features + attended)
```

## ğŸ“ˆ è®­ç»ƒå»ºè®®

### 1. **å­¦ä¹ ç‡è®¾ç½®**
- åˆå§‹å­¦ä¹ ç‡ï¼š`1e-4`ï¼ˆæ¯”Transformerç¨é«˜ï¼‰
- Warmupï¼š5-10ä¸ªepoch
- ä½™å¼¦é€€ç«ï¼šeta_min = `1e-5`

### 2. **æŸå¤±å‡½æ•°æƒé‡**
- ä½™å¼¦ç›¸ä¼¼åº¦æƒé‡ï¼š`0.9`ï¼ˆæ›´å…³æ³¨ç‰¹å¾æ–¹å‘ï¼‰
- MSEæƒé‡ï¼š`0.1`ï¼ˆæ•°å€¼å·®å¼‚ï¼‰

### 3. **æ­£åˆ™åŒ–**
- Dropoutï¼š`0.1`ï¼ˆæ¯”Transformerç¨ä½ï¼‰
- Weight Decayï¼š`1e-4`

### 4. **æ‰¹æ¬¡å¤§å°**
- å¯ä»¥æ¯”Transformeræ›´å¤§ï¼ˆå†…å­˜å ç”¨æ›´å°ï¼‰
- æ¨èï¼š32-64

## ğŸ¨ å¯è§†åŒ–åˆ†æ

### å˜æ¢çŸ©é˜µå¯è§†åŒ–

```python
# è·å–å˜æ¢å‚æ•°
transform_params = model.angle_warping.angle_to_transform(angles)
scale = transform_params[:, :512]
translation = transform_params[:, 512:]

# å¯è§†åŒ–ä¸åŒè§’åº¦å¯¹åº”çš„å˜æ¢
# å¯ä»¥å‘ç°ï¼šè§’åº¦è¶Šå¤§ï¼Œå˜æ¢è¶Šå¼º
```

### ç‰¹å¾åŸºé‡è¦æ€§

```python
# è·å–åŸºå‘é‡æƒé‡
basis_weights = model.angle_warping.attention_selector(features, angles)

# å¯è§†åŒ–å“ªäº›åŸºå‘é‡å¯¹æ­£é¢é‡å»ºæœ€é‡è¦
```

## ğŸ”„ ä¸å…¶ä»–æ¨¡å‹çš„ç»„åˆ

### 1. å¤šè§†è§’èåˆ

```python
# å¦‚æœæœ‰å¤šä¸ªè§’åº¦çš„ç‰¹å¾
multi_view_features = [feat1, feat2, feat3]
multi_view_angles = [angle1, angle2, angle3]

# åˆ†åˆ«å˜æ¢åèåˆ
frontal_features = []
for feat, angle in zip(multi_view_features, multi_view_angles):
    frontal = model(feat, angle)
    frontal_features.append(frontal)

# åŠ æƒèåˆï¼ˆè§’åº¦è¶Šå°æƒé‡è¶Šå¤§ï¼‰
weights = compute_angle_weights(multi_view_angles)
final_frontal = weighted_sum(frontal_features, weights)
```

### 2. æ¸è¿›å¼è®­ç»ƒ

```python
# ä»æ¥è¿‘æ­£é¢çš„è§’åº¦å¼€å§‹ï¼Œé€æ¸å¢åŠ éš¾åº¦
for epoch in range(max_epochs):
    max_angle = min(90, 10 + epoch * 2)  # ä»10Â°åˆ°90Â°
    filtered_data = filter_by_angle(dataset, max_angle)
    train_epoch(model, filtered_data)
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **è§’åº¦å•ä½**ï¼šè¾“å…¥è§’åº¦åº”ä¸º**åº¦**ï¼ˆdegreesï¼‰ï¼Œæ¨¡å‹å†…éƒ¨ä¼šè½¬æ¢ä¸ºå¼§åº¦
2. **ç‰¹å¾å½’ä¸€åŒ–**ï¼šç¡®ä¿è¾“å…¥ç‰¹å¾å·²å½’ä¸€åŒ–ï¼ˆInsightFaceç‰¹å¾å·²L2å½’ä¸€åŒ–ï¼‰
3. **è§’åº¦èŒƒå›´**ï¼šå»ºè®®è§’åº¦èŒƒå›´åœ¨Â±90åº¦å†…
4. **æ‰¹æ¬¡å¤§å°**ï¼šå¯ä»¥æ¯”Transformeræ›´å¤§ï¼Œä½†æ³¨æ„å†…å­˜

## ğŸ“ ä»£ç ç¤ºä¾‹

### å•ç‹¬ä½¿ç”¨

```python
from train_transformer3D.models_angle_warping import FinalRecommendedModel

# åˆ›å»ºæ¨¡å‹
model = FinalRecommendedModel(
    d_model=512,
    hidden_dim=256,
    num_basis=32,
    use_basis=True,
    use_refinement=True,
    use_attention_refine=True
)

# å‰å‘ä¼ æ’­
side_features = torch.randn(4, 512)  # ä¾§é¢ç‰¹å¾
angles = torch.tensor([[30.0, 10.0, 5.0], ...])  # æ¬§æ‹‰è§’ï¼ˆåº¦ï¼‰

output = model(
    src=side_features,
    angles=angles,
    keypoints_3d=None,  # æœªä½¿ç”¨
    pose=angles,  # ä½¿ç”¨è§’åº¦ä½œä¸ºpose
    return_residual=True
)
```

## ğŸ¯ é€‚ç”¨åœºæ™¯

**æ¨èä½¿ç”¨è§’åº¦æ¡ä»¶ä»¿å°„å˜æ¢æ¨¡å‹å½“**ï¼š
- âœ… è¿½æ±‚è®¡ç®—æ•ˆç‡
- âœ… èµ„æºæœ‰é™ï¼ˆæ˜¾å­˜/ç®—åŠ›ï¼‰
- âœ… éœ€è¦å¿«é€Ÿè¿­ä»£
- âœ… éœ€è¦å¯è§£é‡Šæ€§
- âœ… è®­ç»ƒç¨³å®šæ€§è¦æ±‚é«˜

**æ¨èä½¿ç”¨Transformeræ¨¡å‹å½“**ï¼š
- âœ… æ•°æ®é‡éå¸¸å¤§
- âœ… éœ€è¦å¤„ç†éå¸¸å¤æ‚çš„è§’åº¦å˜æ¢
- âœ… æœ‰å……è¶³çš„èµ„æº
- âœ… è¿½æ±‚æè‡´æ€§èƒ½

## ğŸ“š å‚è€ƒæ–‡çŒ®

- **NeRF**: Neural Radiance Fieldsï¼ˆé¢‘ç‡ç¼–ç çš„çµæ„Ÿæ¥æºï¼‰
- **ä»¿å°„å˜æ¢**: ç‰¹å¾ç©ºé—´çš„çº¿æ€§å˜æ¢
- **ç‰¹å¾åŸºé‡å»º**: ä½ç§©è¿‘ä¼¼ç†è®º

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `models_angle_warping.py`: æ¨¡å‹å®šä¹‰
- `train_3d.py`: è®­ç»ƒè„šæœ¬ï¼ˆå·²é›†æˆï¼‰
- `models_3d.py`: Transformeræ¨¡å‹ï¼ˆå¯¹æ¯”å‚è€ƒï¼‰
