# ä»…ä½¿ç”¨å§¿æ€ä½ç½®ç¼–ç è¯´æ˜

## ğŸ“‹ ä¿®æ”¹è¯´æ˜

æ¨¡å‹å·²ä¿®æ”¹ä¸º**åªä½¿ç”¨å§¿æ€å€¼ï¼ˆposeï¼‰ä½œä¸ºä½ç½®ç¼–ç **ï¼Œä¸å†ä½¿ç”¨5ä¸ªå…³é”®ç‚¹ã€‚

## ğŸ”„ ä¿®æ”¹å†…å®¹

### 1. `TransformerDecoderOnly3D` æ¨¡å‹ (`models_3d.py`)

**ç§»é™¤çš„ç»„ä»¶**ï¼š
- `keypoint_encoder`: 3Då…³é”®ç‚¹ç¼–ç å™¨
- `spatial_fusion`: ç©ºé—´æ³¨æ„åŠ›èåˆï¼ˆéœ€è¦å…³é”®ç‚¹ï¼‰
- `fusion_weights`: å…³é”®ç‚¹èåˆæƒé‡

**ä¿ç•™çš„ç»„ä»¶**ï¼š
- `pose_encoder`: å§¿æ€ç¼–ç å™¨ï¼ˆç”¨äºä½ç½®ç¼–ç ï¼‰
- `pose_attention`: å§¿æ€æ¡ä»¶æ³¨æ„åŠ›ï¼ˆå¯é€‰ï¼‰
- `angle_pe`: è§’åº¦ä½ç½®ç¼–ç ï¼ˆä½¿ç”¨å§¿æ€ï¼‰
- `angle_conditioned_norm`: è§’åº¦æ¡ä»¶å½’ä¸€åŒ–ï¼ˆä½¿ç”¨å§¿æ€ï¼‰

**ä¿®æ”¹åçš„å‰å‘ä¼ æ’­**ï¼š
```python
# 1. ç¼–ç å§¿æ€ï¼ˆä½œä¸ºä½ç½®ç¼–ç ï¼‰
pose_features = self.pose_encoder(pose)  # [batch, d_model]

# 2. åˆå§‹ç‰¹å¾æŠ•å½±
src_features = self.input_projection(src)  # [batch, d_model]

# 3. å§¿æ€æ¡ä»¶æ³¨æ„åŠ›ï¼ˆå¦‚æœå¯ç”¨ï¼‰
if self.use_pose_attention:
    src_features, pose_attn = self.pose_attention(src_features, pose)

# 4. èåˆç‰¹å¾å’Œå§¿æ€ç¼–ç 
combined_features = 0.7 * src_features + 0.3 * pose_features

# 5. æ·»åŠ è§’åº¦ä½ç½®ç¼–ç ï¼ˆä½¿ç”¨å§¿æ€ï¼‰
if self.use_angle_pe:
    angle_pe = self.angle_pe(pose)
    combined_features = combined_features + angle_pe
```

### 2. `TransformerEncoderDecoder3D` æ¨¡å‹ (`models_3d_fulltransformer.py`)

**ç§»é™¤çš„ç»„ä»¶**ï¼š
- `keypoint_encoder`: 3Då…³é”®ç‚¹ç¼–ç å™¨
- `keypoint_pos_encoding`: å…³é”®ç‚¹ä½ç½®ç¼–ç 

**ä¿®æ”¹åçš„ç¼–ç å™¨**ï¼š
- ç¼–ç å™¨åªå¤„ç†ä¾§é¢ç‰¹å¾ï¼Œä¸å†å¤„ç†å…³é”®ç‚¹
- ç¼–ç å™¨è¾“å…¥ä» `[batch, 1+num_kp, d_model]` å˜ä¸º `[batch, 1, d_model]`

**ä¿®æ”¹åçš„å‰å‘ä¼ æ’­**ï¼š
```python
# ç¼–ç å™¨åªç¼–ç ä¾§é¢ç‰¹å¾
src_features = self.input_projection(src)  # [batch, d_model]
src_features = src_features.unsqueeze(1)  # [batch, 1, d_model]

# Transformerç¼–ç ï¼ˆåªç¼–ç ä¾§é¢ç‰¹å¾ï¼‰
encoder_output = self.encoder(src_features, mask=src_mask)  # [batch, 1, d_model]

# è§£ç å™¨ä½¿ç”¨å§¿æ€ä½œä¸ºä½ç½®ç¼–ç 
if self.use_pose_pe:
    pose_pe = self.pose_pe(pose)  # [batch, d_model]
    decoder_input = decoder_input + pose_pe
```

## âœ… å…¼å®¹æ€§

- `keypoints_3d` å‚æ•°åœ¨ `forward` æ–¹æ³•ä¸­è®¾ä¸ºå¯é€‰ï¼ˆ`keypoints_3d=None`ï¼‰
- è®­ç»ƒè„šæœ¬ä»ç„¶å¯ä»¥ä¼ é€’ `keypoints_3d`ï¼Œä½†æ¨¡å‹ä¼šå¿½ç•¥å®ƒ
- å¦‚æœ `pose` ä¸º `None`ï¼Œä¼šè‡ªåŠ¨ä½¿ç”¨ `angles`ï¼ˆå…¼å®¹æ€§å¤„ç†ï¼‰

## ğŸ¯ ä¼˜åŠ¿

1. **ç®€åŒ–æ¨¡å‹**ï¼šç§»é™¤å…³é”®ç‚¹ç¼–ç ï¼Œæ¨¡å‹æ›´è½»é‡
2. **ä¸“æ³¨å§¿æ€**ï¼šåªä½¿ç”¨å§¿æ€ä¿¡æ¯ï¼Œæ›´ç¬¦åˆ"è§’åº¦æ¡ä»¶å˜æ¢"çš„æ ¸å¿ƒæ€æƒ³
3. **å‡å°‘å‚æ•°**ï¼šç§»é™¤å…³é”®ç‚¹ç›¸å…³å‚æ•°ï¼Œæ¨¡å‹å‚æ•°é‡å‡å°‘
4. **è®­ç»ƒæ›´å¿«**ï¼šè¾“å…¥åºåˆ—æ›´çŸ­ï¼ˆç¼–ç å™¨è¾“å…¥ä» `1+5=6` å˜ä¸º `1`ï¼‰

## ğŸ“Š æ¨¡å‹æ¶æ„å˜åŒ–

### ä¿®æ”¹å‰
```
è¾“å…¥: srcç‰¹å¾ + 5ä¸ªå…³é”®ç‚¹ + å§¿æ€
  â†“
å…³é”®ç‚¹ç¼–ç  â†’ ç©ºé—´æ³¨æ„åŠ›èåˆ
  â†“
ç‰¹å¾ + å…³é”®ç‚¹ç‰¹å¾ + å§¿æ€ç‰¹å¾ â†’ èåˆ
  â†“
Transformerè§£ç 
```

### ä¿®æ”¹å
```
è¾“å…¥: srcç‰¹å¾ + å§¿æ€
  â†“
å§¿æ€ç¼–ç ï¼ˆä½ç½®ç¼–ç ï¼‰
  â†“
ç‰¹å¾ + å§¿æ€ç‰¹å¾ â†’ èåˆ
  â†“
Transformerè§£ç 
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

ä½¿ç”¨æ–¹æ³•ä¸å˜ï¼Œæ¨¡å‹ä¼šè‡ªåŠ¨å¿½ç•¥ `keypoints_3d` å‚æ•°ï¼š

```bash
C:/Users/62487/.conda/envs/llm/python.exe train_transformer3D/train_3d.py --data_dir train/datas/file --batch_size 32 --epochs 150 --lr 1e-3 --model_type decoder_only --num_decoder_layers 4 --use_pose_attention --min_yaw_angle 15
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å·²è®­ç»ƒçš„æ¨¡å‹**ï¼šå¦‚æœåŠ è½½æ—§æ¨¡å‹checkpointï¼Œå¯èƒ½ä¼šæœ‰å‚æ•°ä¸åŒ¹é…çš„è­¦å‘Šï¼ˆå› ä¸ºç§»é™¤äº†å…³é”®ç‚¹ç›¸å…³å‚æ•°ï¼‰ã€‚è¿™æ˜¯æ­£å¸¸çš„ï¼Œæ¨¡å‹ä¼šä½¿ç”¨ `strict=False` æ¨¡å¼åŠ è½½ã€‚

2. **æ¨¡å‹å®¹é‡**ï¼šç§»é™¤å…³é”®ç‚¹åï¼Œæ¨¡å‹å®¹é‡å‡å°‘ï¼Œå¯èƒ½éœ€è¦è°ƒæ•´å­¦ä¹ ç‡æˆ–å…¶ä»–è¶…å‚æ•°ã€‚

3. **æ€§èƒ½å½±å“**ï¼šç†è®ºä¸Šï¼Œåªä½¿ç”¨å§¿æ€åº”è¯¥è¶³å¤Ÿï¼Œå› ä¸ºå§¿æ€ä¿¡æ¯å·²ç»åŒ…å«äº†è§’åº¦ä¿¡æ¯ã€‚å¦‚æœæ€§èƒ½ä¸‹é™ï¼Œå¯ä»¥è€ƒè™‘ï¼š
   - å¢åŠ æ¨¡å‹å±‚æ•°
   - å¢åŠ  `pose_encoder` çš„å®¹é‡
   - è°ƒæ•´å§¿æ€ç¼–ç çš„æ–¹å¼

## ğŸ” éªŒè¯ä¿®æ”¹

è¿è¡Œè®­ç»ƒæ—¶ï¼Œæ¨¡å‹ä¼šæ­£å¸¸è®­ç»ƒï¼Œä¸å†ä½¿ç”¨å…³é”®ç‚¹ã€‚å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼éªŒè¯ï¼š

1. **æ£€æŸ¥æ¨¡å‹å‚æ•°æ•°é‡**ï¼šåº”è¯¥æ¯”ä¹‹å‰å°‘ï¼ˆç§»é™¤äº†å…³é”®ç‚¹ç¼–ç å™¨ï¼‰
2. **æ£€æŸ¥è®­ç»ƒæ—¥å¿—**ï¼šä¸ä¼šæœ‰å…³äºå…³é”®ç‚¹çš„å¤„ç†ä¿¡æ¯
3. **æ€§èƒ½å¯¹æ¯”**ï¼šå¯¹æ¯”ä½¿ç”¨å…³é”®ç‚¹å’Œä¸ä½¿ç”¨å…³é”®ç‚¹çš„æ€§èƒ½å·®å¼‚
