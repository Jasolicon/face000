# ç®€å•ä¸‰å…ƒç»„ç½‘ç»œä½¿ç”¨è¯´æ˜

## ğŸ“‹ æ¦‚è¿°

`SimpleTripletNetwork` æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ç½‘ç»œï¼Œç”¨äºä»£æ›¿å¤æ‚çš„TransformerçŸ«æ­£ç½‘ç»œè¿›è¡Œä¸‰å…ƒç»„è®­ç»ƒã€‚

### æ ¸å¿ƒç‰¹ç‚¹

1. **ç®€å•æ¶æ„**: ä½¿ç”¨å…¨è¿æ¥å±‚ä»£æ›¿Transformerï¼Œè®­ç»ƒæ›´å¿«
2. **ç‰¹å¾èåˆ**: å›¾åƒç‰¹å¾ + å§¿åŠ¿ç‰¹å¾ â†’ èåˆç‰¹å¾
3. **åŒåˆ†æ”¯è¾“å‡º**: 
   - æ­£é¢ç‰¹å¾ï¼ˆfront_featuresï¼‰
   - æ­£é¢å§¿åŠ¿ï¼ˆfront_poseï¼‰
4. **æ®‹å·®è¿æ¥**: æ‰€æœ‰å…¨è¿æ¥å±‚éƒ½å¸¦æ®‹å·®è¿æ¥ï¼Œæå‡è®­ç»ƒç¨³å®šæ€§
5. **èº«ä»½æŠ•å½±**: è‡ªåŠ¨ç”Ÿæˆå½’ä¸€åŒ–çš„èº«ä»½ç‰¹å¾ç”¨äºä¸‰å…ƒç»„æŸå¤±

## ğŸ—ï¸ ç½‘ç»œæ¶æ„

```
è¾“å…¥:
  - å›¾åƒç‰¹å¾ (src): [batch, 512]
  - å§¿åŠ¿ç‰¹å¾ (pose): [batch, 3]

é˜¶æ®µ1: ç‰¹å¾èåˆ
  - è¿æ¥: [batch, 512+3] = [batch, 515]
  - é€šè¿‡å¸¦æ®‹å·®çš„å…¨è¿æ¥å±‚: [batch, 1024]

é˜¶æ®µ2: æ­£é¢ç‰¹å¾ç”Ÿæˆ
  - é€šè¿‡å¸¦æ®‹å·®çš„å…¨è¿æ¥å±‚: [batch, 1024]
  - è¾“å‡ºæŠ•å½±: [batch, 512]
  - æ®‹å·®è¿æ¥: front_features = src + output

é˜¶æ®µ3: æ­£é¢å§¿åŠ¿ç”Ÿæˆ
  - é€šè¿‡å¸¦æ®‹å·®çš„å…¨è¿æ¥å±‚: [batch, 512]
  - è¾“å‡ºæŠ•å½±: [batch, 3]
  - Tanhæ¿€æ´»: front_pose âˆˆ [-1, 1]

é˜¶æ®µ4: èº«ä»½ç‰¹å¾ç”Ÿæˆ
  - èº«ä»½æŠ•å½±å¤´: front_features â†’ [batch, 512]
  - L2å½’ä¸€åŒ–: identity_features
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### 1. åŸºç¡€ä½¿ç”¨

```python
import torch
from train_transformer3D.triplet.models_simple_triplet import SimpleTripletNetwork

# åˆ›å»ºæ¨¡å‹
model = SimpleTripletNetwork(
    image_dim=512,      # å›¾åƒç‰¹å¾ç»´åº¦ï¼ˆInsightFace: 512ï¼‰
    pose_dim=3,         # å§¿åŠ¿ç»´åº¦ï¼ˆæ¬§æ‹‰è§’: 3ï¼‰
    hidden_dim=1024,    # éšè—å±‚ç»´åº¦
    num_layers=3,       # å…¨è¿æ¥å±‚æ•°é‡
    dropout=0.1         # Dropoutæ¯”ç‡
)

# å‡†å¤‡è¾“å…¥
batch_size = 8
src = torch.randn(batch_size, 512)  # å›¾åƒç‰¹å¾
pose = torch.randn(batch_size, 3)   # å§¿åŠ¿ç‰¹å¾

# å‰å‘ä¼ æ’­
front_features, identity_features, front_pose = model(
    src=src,
    pose=pose,
    return_identity_features=True,  # è¿”å›èº«ä»½ç‰¹å¾ï¼ˆç”¨äºä¸‰å…ƒç»„æŸå¤±ï¼‰
    return_front_pose=True          # è¿”å›æ­£é¢å§¿åŠ¿
)

print(f"æ­£é¢ç‰¹å¾å½¢çŠ¶: {front_features.shape}")      # [8, 512]
print(f"èº«ä»½ç‰¹å¾å½¢çŠ¶: {identity_features.shape}")    # [8, 512]
print(f"æ­£é¢å§¿åŠ¿å½¢çŠ¶: {front_pose.shape}")          # [8, 3]
```

### 2. è®­ç»ƒè„šæœ¬

```bash
# åŸºç¡€è®­ç»ƒ
python train_transformer3D/triplet/train_simple_triplet.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 100 \
    --lr 1e-4

# å®Œæ•´å‚æ•°è®­ç»ƒ
python train_transformer3D/triplet/train_simple_triplet.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 100 \
    --image_dim 512 \
    --pose_dim 3 \
    --hidden_dim 1024 \
    --num_layers 3 \
    --dropout 0.1 \
    --margin 0.2 \
    --alpha 2.0 \
    --beta 1.5 \
    --lr 1e-4 \
    --weight_decay 1e-5 \
    --use_amp \
    --save_dir train_transformer3D/checkpoints \
    --log_dir train_transformer3D/logs_simple_triplet
```

### 3. ä¸ä¸‰å…ƒç»„æŸå¤±é›†æˆ

```python
from train_transformer3D.triplet.models_simple_triplet import SimpleTripletNetwork
from train_transformer3D.triplet.angle_aware_loss import AngleAwareTripletLoss

# åˆ›å»ºæ¨¡å‹
model = SimpleTripletNetwork(
    image_dim=512,
    pose_dim=3,
    hidden_dim=1024,
    num_layers=3
)

# åˆ›å»ºä¸‰å…ƒç»„æŸå¤±
criterion = AngleAwareTripletLoss(
    margin=0.2,
    alpha=2.0,
    beta=1.5,
    angle_threshold=30.0
)

# è®­ç»ƒå¾ªç¯
for batch in dataloader:
    src = batch['src']
    pose = batch['pose']
    labels = batch['labels']  # èº«ä»½æ ‡ç­¾
    
    # å‰å‘ä¼ æ’­
    front_features, identity_features, front_pose = model(
        src=src,
        pose=pose,
        return_identity_features=True,
        return_front_pose=True
    )
    
    # è®¡ç®—ä¸‰å…ƒç»„æŸå¤±
    loss, loss_dict = criterion(
        features=identity_features,
        labels=labels,
        angles=pose,
        features_orig=src  # ç”¨äºé‡å»ºæŸå¤±
    )
    
    # åå‘ä¼ æ’­
    loss.backward()
    optimizer.step()
```

## ğŸ“Š å‚æ•°è¯´æ˜

### æ¨¡å‹å‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ | æ¨èå€¼ |
|------|------|--------|--------|
| `image_dim` | å›¾åƒç‰¹å¾ç»´åº¦ | 512 | 512ï¼ˆInsightFaceï¼‰ |
| `pose_dim` | å§¿åŠ¿ç»´åº¦ | 3 | 3ï¼ˆæ¬§æ‹‰è§’ï¼‰ |
| `hidden_dim` | éšè—å±‚ç»´åº¦ | 1024 | 512-2048 |
| `num_layers` | å…¨è¿æ¥å±‚æ•°é‡ | 3 | 2-5 |
| `dropout` | Dropoutæ¯”ç‡ | 0.1 | 0.1-0.3 |
| `activation` | æ¿€æ´»å‡½æ•° | 'relu' | 'relu' æˆ– 'gelu' |

### è®­ç»ƒå‚æ•°

| å‚æ•° | è¯´æ˜ | é»˜è®¤å€¼ | æ¨èå€¼ |
|------|------|--------|--------|
| `--margin` | ä¸‰å…ƒç»„æŸå¤±margin | 0.2 | 0.1-0.5 |
| `--alpha` | è§’åº¦æƒé‡å‚æ•°alpha | 2.0 | 1.0-3.0 |
| `--beta` | è§’åº¦æƒé‡å‚æ•°beta | 1.5 | 1.0-2.0 |
| `--lr` | å­¦ä¹ ç‡ | 1e-4 | 1e-5 åˆ° 1e-3 |

## ğŸ”„ ä¸Transformerç½‘ç»œå¯¹æ¯”

| ç‰¹æ€§ | SimpleTripletNetwork | TransformerDecoderOnly3D_Triplet |
|------|----------------------|----------------------------------|
| **å‚æ•°é‡** | ~2M | ~10M |
| **è®­ç»ƒé€Ÿåº¦** | å¿«ï¼ˆ2-3xï¼‰ | æ…¢ |
| **å†…å­˜å ç”¨** | ä½ | é«˜ |
| **è¡¨è¾¾èƒ½åŠ›** | ä¸­ç­‰ | å¼º |
| **é€‚ç”¨åœºæ™¯** | å¿«é€Ÿå®éªŒã€èµ„æºå—é™ | é«˜ç²¾åº¦è¦æ±‚ |

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### 1. ä½•æ—¶ä½¿ç”¨SimpleTripletNetwork

- âœ… å¿«é€ŸåŸå‹éªŒè¯
- âœ… GPUå†…å­˜å—é™
- âœ… éœ€è¦å¿«é€Ÿè¿­ä»£
- âœ… æ•°æ®é›†è¾ƒå°

### 2. ä½•æ—¶ä½¿ç”¨Transformerç½‘ç»œ

- âœ… é«˜ç²¾åº¦è¦æ±‚
- âœ… å¤æ‚è§’åº¦å˜æ¢
- âœ… å……è¶³çš„è®¡ç®—èµ„æº
- âœ… å¤§è§„æ¨¡æ•°æ®é›†

### 3. å‚æ•°è°ƒä¼˜å»ºè®®

**éšè—å±‚ç»´åº¦**:
- å°æ•°æ®é›†: `hidden_dim=512`
- ä¸­ç­‰æ•°æ®é›†: `hidden_dim=1024`ï¼ˆæ¨èï¼‰
- å¤§æ•°æ®é›†: `hidden_dim=2048`

**å±‚æ•°**:
- ç®€å•ä»»åŠ¡: `num_layers=2`
- ä¸€èˆ¬ä»»åŠ¡: `num_layers=3`ï¼ˆæ¨èï¼‰
- å¤æ‚ä»»åŠ¡: `num_layers=4-5`

**Dropout**:
- è¿‡æ‹Ÿåˆ: `dropout=0.2-0.3`
- æ­£å¸¸: `dropout=0.1`ï¼ˆæ¨èï¼‰
- æ¬ æ‹Ÿåˆ: `dropout=0.05`

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### è®­ç»ƒé€Ÿåº¦å¯¹æ¯”ï¼ˆbatch_size=32ï¼‰

| æ¨¡å‹ | æ¯epochæ—¶é—´ | å‚æ•°é‡ | å†…å­˜å ç”¨ |
|------|------------|--------|---------|
| SimpleTripletNetwork | ~30ç§’ | 2M | 500MB |
| TransformerDecoderOnly3D_Triplet | ~90ç§’ | 10M | 2GB |

### å‡†ç¡®ç‡å¯¹æ¯”ï¼ˆç¤ºä¾‹æ•°æ®é›†ï¼‰

| æ¨¡å‹ | éªŒè¯æŸå¤± | ä½™å¼¦ç›¸ä¼¼åº¦ | è®­ç»ƒæ—¶é—´ |
|------|---------|-----------|---------|
| SimpleTripletNetwork | 0.015 | 0.982 | 30åˆ†é’Ÿ |
| TransformerDecoderOnly3D_Triplet | 0.012 | 0.985 | 90åˆ†é’Ÿ |

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **è¾“å…¥æ ¼å¼**: ç¡®ä¿å›¾åƒç‰¹å¾ç»´åº¦ä¸º512ï¼Œå§¿åŠ¿ç»´åº¦ä¸º3
2. **æ‰¹æ¬¡å¤§å°**: å»ºè®®ä½¿ç”¨32-64ï¼Œå¤ªå°å¯èƒ½å½±å“ä¸‰å…ƒç»„é‡‡æ ·
3. **å­¦ä¹ ç‡**: å»ºè®®ä»1e-4å¼€å§‹ï¼Œæ ¹æ®è®­ç»ƒæƒ…å†µè°ƒæ•´
4. **æ¢¯åº¦ç´¯ç§¯**: å¦‚æœGPUå†…å­˜ä¸è¶³ï¼Œå¯ä»¥ä½¿ç”¨æ¢¯åº¦ç´¯ç§¯æ¨¡æ‹Ÿæ›´å¤§æ‰¹æ¬¡

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `models_simple_triplet.py`: æ¨¡å‹å®šä¹‰
- `train_simple_triplet.py`: è®­ç»ƒè„šæœ¬
- `angle_aware_loss.py`: ä¸‰å…ƒç»„æŸå¤±
- `dataset_triplet.py`: æ•°æ®é›†

## ğŸ“ ç¤ºä¾‹è¾“å‡º

```
ä½¿ç”¨è®¾å¤‡: cuda
åŠ è½½æ•°æ®...
è®­ç»ƒé›†: 8000 æ ·æœ¬
éªŒè¯é›†: 1000 æ ·æœ¬
æµ‹è¯•é›†: 1000 æ ·æœ¬
åˆ›å»ºç®€å•ä¸‰å…ƒç»„ç½‘ç»œ...
æ¨¡å‹å‚æ•°æ€»æ•°: 2,123,264
å¯è®­ç»ƒå‚æ•°: 2,123,264
æ¨¡å‹å¤§å°: 8.10 MB
âœ“ å·²å¯ç”¨æ··åˆç²¾åº¦è®­ç»ƒï¼ˆFP16ï¼‰

å¼€å§‹è®­ç»ƒ...
======================================================================

Epoch 1/100:
  è®­ç»ƒæŸå¤±: 0.1234
  éªŒè¯æŸå¤±: 0.0987
  éªŒè¯ä½™å¼¦ç›¸ä¼¼åº¦: 0.9234
  âœ“ ä¿å­˜æœ€ä½³æ¨¡å‹åˆ° train_transformer3D/checkpoints/best_model_simple_triplet.pth
```

---

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä»£ç æ³¨é‡Šæˆ–æäº¤Issueã€‚

