# SENetä¸‰å…ƒç»„ç½‘ç»œè®­ç»ƒè¯´æ˜

## ğŸ“‹ æ¦‚è¿°

`train_senet_triplet.py` æ˜¯ä¸“é—¨ä¸º `SENetTripletNetwork` è®¾è®¡çš„è®­ç»ƒè„šæœ¬ï¼Œé›†æˆäº†ä»¥ä¸‹ç‰¹æ€§ï¼š

1. **åŒåˆ†æ”¯SENetæ¶æ„**ï¼šåˆ†ç¦»èº«ä»½ç‰¹å¾å’Œå§¿æ€ç‰¹å¾
2. **èº«ä»½ä¿æŠ¤æŸå¤±**ï¼šä¿æŠ¤é«˜ç›¸ä¼¼ç»´åº¦ï¼ˆå¦‚ç»´åº¦60, 312, 459ç­‰ï¼‰
3. **èåˆæƒé‡ç›‘æ§**ï¼šå®æ—¶ç›‘æ§SENetçš„èåˆæƒé‡Î±
4. **å®Œæ•´çš„è®­ç»ƒæµç¨‹**ï¼šè®­ç»ƒã€éªŒè¯ã€ä¿å­˜ã€å¯è§†åŒ–

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åŸºç¡€è®­ç»ƒå‘½ä»¤

```bash
python train_transformer3D/triplet/train_senet_triplet.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 100 \
    --lr 1e-4
```

### å®Œæ•´è®­ç»ƒå‘½ä»¤ï¼ˆæ¨èé…ç½®ï¼‰

```bash
python train_transformer3D/triplet/train_senet_triplet.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --num_workers 4 \
    --epochs 100 \
    --lr 1e-4 \
    --weight_decay 1e-5 \
    --identity_preserve_weight 0.3 \
    --margin 0.3 \
    --alpha 2.0 \
    --beta 1.0 \
    --angle_threshold 30.0 \
    --se_reduction 16 \
    --fusion_alpha 0.7 \
    --use_amp \
    --save_dir train_transformer3D/triplet/checkpoints_senet \
    --log_dir train_transformer3D/triplet/logs_senet
```

---

## ğŸ“Š å‚æ•°è¯´æ˜

### æ•°æ®å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--data_dir` | å¿…éœ€ | æ•°æ®ç›®å½•è·¯å¾„ |
| `--batch_size` | 32 | æ‰¹æ¬¡å¤§å° |
| `--num_workers` | 4 | æ•°æ®åŠ è½½å™¨å·¥ä½œè¿›ç¨‹æ•° |

### æ¨¡å‹å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--image_dim` | 512 | å›¾åƒç‰¹å¾ç»´åº¦ï¼ˆInsightFace: 512ï¼‰ |
| `--pose_dim` | 3 | å§¿åŠ¿ç»´åº¦ï¼ˆæ¬§æ‹‰è§’: 3ï¼‰ |
| `--hidden_dim` | 1024 | éšè—å±‚ç»´åº¦ |
| `--num_layers` | 3 | å…¨è¿æ¥å±‚æ•°é‡ |
| `--se_reduction` | 16 | SE Blockå‹ç¼©æ¯”ä¾‹ï¼ˆ8-32ï¼‰ |
| `--fusion_alpha` | 0.7 | èº«ä»½åˆ†æ”¯åˆå§‹æƒé‡ï¼ˆ0-1ï¼‰ |
| `--use_batch_stat` | False | SE Blockæ˜¯å¦ä½¿ç”¨batchç»Ÿè®¡ï¼ˆé»˜è®¤ï¼šæ¯ä¸ªæ ·æœ¬ç‹¬ç«‹ï¼‰ |

### è®­ç»ƒå‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--epochs` | 100 | è®­ç»ƒè½®æ•° |
| `--lr` | 1e-4 | å­¦ä¹ ç‡ |
| `--weight_decay` | 1e-5 | æƒé‡è¡°å‡ |
| `--identity_preserve_weight` | 0.3 | èº«ä»½ä¿æŠ¤æŸå¤±æƒé‡ |
| `--gradient_accumulation_steps` | 1 | æ¢¯åº¦ç´¯ç§¯æ­¥æ•° |
| `--use_amp` | False | ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒ |

### ä¸‰å…ƒç»„æŸå¤±å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--margin` | 0.3 | ä¸‰å…ƒç»„æŸå¤±margin |
| `--alpha` | 2.0 | è§’åº¦æƒé‡å‚æ•°alpha |
| `--beta` | 1.0 | è§’åº¦æƒé‡å‚æ•°beta |
| `--angle_threshold` | 30.0 | è§’åº¦å·®å¼‚é˜ˆå€¼ï¼ˆåº¦ï¼‰ |

### å…¶ä»–å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--save_dir` | `checkpoints_senet` | æ¨¡å‹ä¿å­˜ç›®å½• |
| `--log_dir` | `logs_senet` | TensorBoardæ—¥å¿—ç›®å½• |
| `--resume` | None | æ¢å¤è®­ç»ƒçš„æ£€æŸ¥ç‚¹è·¯å¾„ |
| `--save_interval` | 10 | ä¿å­˜æ¨¡å‹çš„é—´éš”ï¼ˆepochï¼‰ |

---

## ğŸ”§ æ ¸å¿ƒç‰¹æ€§

### 1. èº«ä»½ä¿æŠ¤æŸå¤±

è„šæœ¬è‡ªåŠ¨ä½¿ç”¨ç‰¹å¾åˆ†ææŠ¥å‘Šä¸­è¯†åˆ«çš„é«˜ç›¸ä¼¼ç»´åº¦ï¼ˆèº«ä»½ç›¸å…³ç»´åº¦ï¼‰æ¥è®¡ç®—èº«ä»½ä¿æŠ¤æŸå¤±ï¼š

```python
# èº«ä»½ç›¸å…³ç»´åº¦ï¼ˆTop 20ï¼‰
IDENTITY_DIMS = [60, 312, 459, 217, 115, 74, 350, 113, 305, 149, ...]

# è®¡ç®—èº«ä»½ä¿æŠ¤æŸå¤±
identity_loss = compute_identity_preserve_loss(
    front_features, src, IDENTITY_DIMS, weight=0.3
)
```

**ä½œç”¨**ï¼š
- ä¿æŠ¤é«˜ç›¸ä¼¼ç»´åº¦ä¸è¢«è¿‡åº¦ä¿®æ”¹
- ç¡®ä¿èº«ä»½ä¿¡æ¯åœ¨ç‰¹å¾è½¬æ¢è¿‡ç¨‹ä¸­ä¿æŒç¨³å®š

### 2. èåˆæƒé‡ç›‘æ§

è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šå®æ—¶ç›‘æ§SENetçš„èåˆæƒé‡Î±ï¼š

```python
fusion_alpha = model.get_fusion_alpha()  # è·å–å½“å‰èåˆæƒé‡
```

**å«ä¹‰**ï¼š
- Î±æ¥è¿‘1ï¼šæ¨¡å‹æ›´ä¾èµ–èº«ä»½åˆ†æ”¯ï¼ˆä¿æŠ¤åŸå§‹ç‰¹å¾ï¼‰
- Î±æ¥è¿‘0ï¼šæ¨¡å‹æ›´ä¾èµ–å§¿æ€åˆ†æ”¯ï¼ˆå­¦ä¹ è½¬æ¢ï¼‰
- Î±åœ¨0.5-0.8ä¹‹é—´é€šå¸¸æ˜¯æœ€ä½³å¹³è¡¡

### 3. è®­ç»ƒæ›²çº¿å¯è§†åŒ–

è„šæœ¬ä¼šè‡ªåŠ¨ç”Ÿæˆ4ä¸ªå­å›¾çš„è®­ç»ƒæ›²çº¿ï¼š

1. **æ€»æŸå¤±ä¸ä½™å¼¦ç›¸ä¼¼åº¦**ï¼šç›‘æ§æ•´ä½“è®­ç»ƒè¿›åº¦
2. **ä¸‰å…ƒç»„æŸå¤±**ï¼šç›‘æ§ä¸‰å…ƒç»„å­¦ä¹ æ•ˆæœ
3. **èº«ä»½ä¿æŠ¤æŸå¤±**ï¼šç›‘æ§èº«ä»½ä¿æŠ¤æ•ˆæœ
4. **èåˆæƒé‡å˜åŒ–**ï¼šç›‘æ§SENetèåˆæƒé‡

---

## ğŸ“ˆ è®­ç»ƒè¾“å‡º

### æ§åˆ¶å°è¾“å‡ºç¤ºä¾‹

```
ä½¿ç”¨è®¾å¤‡: cuda
åŠ è½½æ•°æ®...
è®­ç»ƒé›†: 8000 æ ·æœ¬
éªŒè¯é›†: 1000 æ ·æœ¬
æµ‹è¯•é›†: 1000 æ ·æœ¬

åˆ›å»ºæ¨¡å‹...
æ€»å‚æ•°é‡: 2,345,856
å¯è®­ç»ƒå‚æ•°: 2,345,856
åˆå§‹èåˆæƒé‡: 0.7000

å¼€å§‹è®­ç»ƒ...
======================================================================

Epoch 1/100
  è®­ç»ƒ - æ€»æŸå¤±: 0.5234, ä¸‰å…ƒç»„: 0.4123, èº«ä»½ä¿æŠ¤: 0.0891, èåˆæƒé‡: 0.7012
  éªŒè¯ - æ€»æŸå¤±: 0.4987, ä¸‰å…ƒç»„: 0.3956, ä½™å¼¦ç›¸ä¼¼åº¦: 0.2345
  âœ“ ä¿å­˜æœ€ä½³æ¨¡å‹: checkpoints_senet/best_model.pth
```

### ä¿å­˜çš„æ–‡ä»¶

è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šä¿å­˜ä»¥ä¸‹æ–‡ä»¶ï¼š

1. **æ¨¡å‹æ–‡ä»¶**ï¼š
   - `best_model.pth`ï¼šæœ€ä½³éªŒè¯æŸå¤±æ¨¡å‹
   - `checkpoint_epoch_N.pth`ï¼šå®šæœŸæ£€æŸ¥ç‚¹
   - `final_model.pth`ï¼šæœ€ç»ˆæ¨¡å‹

2. **è®­ç»ƒå†å²**ï¼š
   - `training_history.json`ï¼šè®­ç»ƒæŒ‡æ ‡å†å²ï¼ˆJSONæ ¼å¼ï¼‰

3. **å¯è§†åŒ–**ï¼š
   - `training_curves_epoch_N.png`ï¼šå®šæœŸè®­ç»ƒæ›²çº¿
   - `final_training_curves.png`ï¼šæœ€ç»ˆè®­ç»ƒæ›²çº¿

4. **TensorBoardæ—¥å¿—**ï¼š
   - `logs_senet/`ï¼šTensorBoardæ—¥å¿—ç›®å½•

---

## ğŸ¯ ä½¿ç”¨å»ºè®®

### 1. åˆå§‹è®­ç»ƒï¼ˆæ¢ç´¢é˜¶æ®µï¼‰

```bash
# ä½¿ç”¨è¾ƒå°çš„å­¦ä¹ ç‡å’Œè¾ƒå°‘çš„epochsè¿›è¡Œæ¢ç´¢
python train_transformer3D/triplet/train_senet_triplet.py \
    --data_dir train/datas/file \
    --batch_size 16 \
    --epochs 20 \
    --lr 5e-5 \
    --identity_preserve_weight 0.2
```

### 2. æ­£å¼è®­ç»ƒï¼ˆæ¨èé…ç½®ï¼‰

```bash
# ä½¿ç”¨æ¨èé…ç½®è¿›è¡Œå®Œæ•´è®­ç»ƒ
python train_transformer3D/triplet/train_senet_triplet.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 100 \
    --lr 1e-4 \
    --identity_preserve_weight 0.3 \
    --use_amp
```

### 3. å¾®è°ƒè®­ç»ƒï¼ˆä»æ£€æŸ¥ç‚¹æ¢å¤ï¼‰

```bash
# ä»æ£€æŸ¥ç‚¹æ¢å¤è®­ç»ƒ
python train_transformer3D/triplet/train_senet_triplet.py \
    --data_dir train/datas/file \
    --resume checkpoints_senet/checkpoint_epoch_50.pth \
    --lr 5e-5 \
    --epochs 150
```

### 4. å¤§æ¨¡å‹è®­ç»ƒï¼ˆæ›´å¤šå‚æ•°ï¼‰

```bash
# ä½¿ç”¨æ›´å¤§çš„æ¨¡å‹
python train_transformer3D/triplet/train_senet_triplet.py \
    --data_dir train/datas/file \
    --hidden_dim 2048 \
    --num_layers 5 \
    --se_reduction 8 \
    --batch_size 16 \
    --use_amp
```

---

## ğŸ“Š ç›‘æ§è®­ç»ƒ

### TensorBoard

å¯åŠ¨TensorBoardæŸ¥çœ‹è®­ç»ƒè¿›åº¦ï¼š

```bash
tensorboard --logdir train_transformer3D/triplet/logs_senet
```

**å¯ç›‘æ§çš„æŒ‡æ ‡**ï¼š
- `Train/Loss`ï¼šè®­ç»ƒæ€»æŸå¤±
- `Train/TripletLoss`ï¼šä¸‰å…ƒç»„æŸå¤±
- `Train/IdentityLoss`ï¼šèº«ä»½ä¿æŠ¤æŸå¤±
- `Train/LearningRate`ï¼šå­¦ä¹ ç‡
- `Epoch/TrainLoss`ï¼šæ¯ä¸ªepochçš„è®­ç»ƒæŸå¤±
- `Epoch/ValLoss`ï¼šæ¯ä¸ªepochçš„éªŒè¯æŸå¤±
- `Epoch/ValCosineSim`ï¼šéªŒè¯ä½™å¼¦ç›¸ä¼¼åº¦
- `Epoch/FusionAlpha`ï¼šèåˆæƒé‡

### å…³é”®æŒ‡æ ‡è§£è¯»

1. **æ€»æŸå¤±ä¸‹é™**ï¼šæ¨¡å‹æ­£åœ¨å­¦ä¹ 
2. **ä¸‰å…ƒç»„æŸå¤±ä¸‹é™**ï¼šèº«ä»½åŒºåˆ†èƒ½åŠ›æå‡
3. **èº«ä»½ä¿æŠ¤æŸå¤±ç¨³å®š**ï¼šèº«ä»½ç‰¹å¾å¾—åˆ°ä¿æŠ¤
4. **èåˆæƒé‡åœ¨0.5-0.8ä¹‹é—´**ï¼šèº«ä»½å’Œå§¿æ€å¹³è¡¡è‰¯å¥½
5. **ä½™å¼¦ç›¸ä¼¼åº¦ä¸Šå‡**ï¼šæ¨¡å‹è¾“å‡ºè´¨é‡æå‡

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. èº«ä»½ä¿æŠ¤æŸå¤±æƒé‡

- **å¤ªå°ï¼ˆ<0.1ï¼‰**ï¼šèº«ä»½ç‰¹å¾å¯èƒ½è¢«è¿‡åº¦ä¿®æ”¹
- **å¤ªå¤§ï¼ˆ>0.5ï¼‰**ï¼šæ¨¡å‹å¯èƒ½è¿‡äºä¿å®ˆï¼Œå­¦ä¹ èƒ½åŠ›å—é™
- **æ¨èå€¼**ï¼š0.2-0.4

### 2. èåˆæƒé‡

- **Î± > 0.8**ï¼šæ¨¡å‹è¿‡äºä¾èµ–èº«ä»½åˆ†æ”¯ï¼Œå¯èƒ½å­¦ä¹ ä¸è¶³
- **Î± < 0.3**ï¼šæ¨¡å‹è¿‡äºä¾èµ–å§¿æ€åˆ†æ”¯ï¼Œå¯èƒ½ä¸¢å¤±èº«ä»½ä¿¡æ¯
- **æ¨èèŒƒå›´**ï¼š0.5-0.8

### 3. SE Blockå‹ç¼©æ¯”ä¾‹

- **reduction=8**ï¼šæ›´å¤šå‚æ•°ï¼Œæ›´å¼ºè¡¨è¾¾èƒ½åŠ›ï¼Œä½†å¯èƒ½è¿‡æ‹Ÿåˆ
- **reduction=16**ï¼šå¹³è¡¡é€‰æ‹©ï¼ˆæ¨èï¼‰
- **reduction=32**ï¼šæ›´å°‘å‚æ•°ï¼Œä½†å¯èƒ½è¡¨è¾¾èƒ½åŠ›ä¸è¶³

### 4. è®­ç»ƒç¨³å®šæ€§

- å¦‚æœè®­ç»ƒä¸ç¨³å®šï¼Œå°è¯•ï¼š
  - é™ä½å­¦ä¹ ç‡ï¼ˆå¦‚5e-5ï¼‰
  - å¢åŠ æ¢¯åº¦ç´¯ç§¯æ­¥æ•°
  - ä½¿ç”¨æ¢¯åº¦è£å‰ªï¼ˆå·²å†…ç½®ï¼Œmax_norm=1.0ï¼‰

---

## ğŸ” æ•…éšœæ’é™¤

### é—®é¢˜1ï¼šæŸå¤±ä¸ä¸‹é™

**å¯èƒ½åŸå› **ï¼š
- å­¦ä¹ ç‡å¤ªå¤§æˆ–å¤ªå°
- èº«ä»½ä¿æŠ¤æŸå¤±æƒé‡å¤ªå¤§

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# è°ƒæ•´å­¦ä¹ ç‡
--lr 5e-5  # æˆ– 2e-4

# é™ä½èº«ä»½ä¿æŠ¤æŸå¤±æƒé‡
--identity_preserve_weight 0.2
```

### é—®é¢˜2ï¼šèåˆæƒé‡å¼‚å¸¸

**å¯èƒ½åŸå› **ï¼š
- è®­ç»ƒä¸å……åˆ†
- æŸå¤±æƒé‡ä¸å¹³è¡¡

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ç»§ç»­è®­ç»ƒï¼Œè§‚å¯Ÿèåˆæƒé‡å˜åŒ–è¶‹åŠ¿
- å¦‚æœÎ±ä¸€ç›´æ¥è¿‘0æˆ–1ï¼Œè°ƒæ•´`fusion_alpha`åˆå§‹å€¼

### é—®é¢˜3ï¼šå†…å­˜ä¸è¶³

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# å‡å°æ‰¹æ¬¡å¤§å°
--batch_size 16

# ä½¿ç”¨æ¢¯åº¦ç´¯ç§¯
--gradient_accumulation_steps 2

# ä½¿ç”¨æ··åˆç²¾åº¦è®­ç»ƒ
--use_amp
```

---

## ğŸ“ è®­ç»ƒæ£€æŸ¥æ¸…å•

è®­ç»ƒå‰ç¡®è®¤ï¼š

- [ ] æ•°æ®ç›®å½•è·¯å¾„æ­£ç¡®
- [ ] æ•°æ®æ ¼å¼ç¬¦åˆè¦æ±‚
- [ ] GPUå†…å­˜å……è¶³ï¼ˆæˆ–ä½¿ç”¨CPUï¼‰
- [ ] ä¿å­˜ç›®å½•æœ‰å†™å…¥æƒé™
- [ ] å‚æ•°è®¾ç½®åˆç†

è®­ç»ƒä¸­ç›‘æ§ï¼š

- [ ] æŸå¤±æ­£å¸¸ä¸‹é™
- [ ] èåˆæƒé‡åœ¨åˆç†èŒƒå›´
- [ ] æ²¡æœ‰NaNæˆ–Infé”™è¯¯
- [ ] TensorBoardæ—¥å¿—æ­£å¸¸è®°å½•

è®­ç»ƒåæ£€æŸ¥ï¼š

- [ ] æœ€ä½³æ¨¡å‹å·²ä¿å­˜
- [ ] è®­ç»ƒæ›²çº¿å·²ç”Ÿæˆ
- [ ] è®­ç»ƒå†å²å·²ä¿å­˜
- [ ] éªŒè¯æŒ‡æ ‡åˆç†

---

ç”Ÿæˆæ—¶é—´: 2024-12-16

