# TransformerDecoderOnly3D æ¨¡å‹è¾“å…¥è¾“å‡ºè¯´æ˜

## ğŸ“¥ æ¨¡å‹è¾“å…¥

### å¿…éœ€è¾“å…¥ï¼ˆ4ä¸ªï¼‰

| å‚æ•°å | å½¢çŠ¶ | æ•°æ®ç±»å‹ | è¯´æ˜ | æ¥æº |
|--------|------|----------|------|------|
| **`src`** | `[batch_size, 512]` | `torch.FloatTensor` | **ä¾§é¢äººè„¸ç‰¹å¾**ï¼ˆInsightFaceæå–ï¼‰ | `batch['src']` |
| **`keypoints_3d`** | `[batch_size, 5, 3]` | `torch.FloatTensor` | **3Då…³é”®ç‚¹åæ ‡**ï¼ˆå·²å¯¹é½å’Œå½’ä¸€åŒ–ï¼‰ | `batch['keypoints_3d']` |
| **`pose`** | `[batch_size, 3]` | `torch.FloatTensor` | **å¤´éƒ¨å§¿æ€**ï¼ˆæ¬§æ‹‰è§’ï¼šyaw, pitch, rollï¼Œå•ä½ï¼šåº¦ï¼‰ | `batch['pose']` |
| **`angles`** | `[batch_size, 3]` | `torch.FloatTensor` | **è§’åº¦**ï¼ˆå…¼å®¹æ€§å‚æ•°ï¼Œå®é™…ä½¿ç”¨`pose`ï¼‰ | `batch['angles']` |

### å¯é€‰è¾“å…¥ï¼ˆ2ä¸ªï¼‰

| å‚æ•°å | å½¢çŠ¶ | æ•°æ®ç±»å‹ | è¯´æ˜ | é»˜è®¤å€¼ |
|--------|------|----------|------|--------|
| **`src_mask`** | `[batch_size, seq_len]` | `torch.BoolTensor` | æºåºåˆ—æ©ç ï¼ˆç”¨äºå±è”½æ— æ•ˆä½ç½®ï¼‰ | `None` |
| **`return_residual`** | `bool` | `bool` | æ˜¯å¦è¿”å›æ®‹å·®ï¼ˆ`True`ï¼‰æˆ–å®Œæ•´ç‰¹å¾ï¼ˆ`False`ï¼‰ | `True` |

---

## ğŸ“¤ æ¨¡å‹è¾“å‡º

### è¾“å‡ºå½¢çŠ¶

| `return_residual` | è¾“å‡ºå½¢çŠ¶ | è¾“å‡ºå«ä¹‰ |
|-------------------|----------|----------|
| `True` | `[batch_size, 512]` | **æ®‹å·®ç‰¹å¾**ï¼ˆéœ€è¦åŠ åˆ°è¾“å…¥ç‰¹å¾ä¸Šï¼‰ |
| `False` | `[batch_size, 512]` | **å®Œæ•´ç‰¹å¾**ï¼ˆè¾“å…¥ç‰¹å¾ + æ®‹å·®ç‰¹å¾ï¼‰ |

### è®­ç»ƒæ—¶çš„è¾“å‡º

åœ¨ `train_3d.py` ä¸­ï¼Œä½¿ç”¨ `return_residual=False`ï¼Œæ‰€ä»¥è¾“å‡ºæ˜¯ï¼š

```python
output = model(
    src=src,                    # [batch, 512] - ä¾§é¢ç‰¹å¾
    angles=angles,              # [batch, 3] - è§’åº¦ï¼ˆå…¼å®¹æ€§ï¼‰
    keypoints_3d=keypoints_3d, # [batch, 5, 3] - 3Då…³é”®ç‚¹
    pose=pose,                  # [batch, 3] - å§¿æ€
    return_residual=False       # è¿”å›å®Œæ•´ç‰¹å¾
)
# output: [batch, 512] - çŸ«æ­£åçš„ç‰¹å¾ï¼ˆæ¥è¿‘æ­£é¢ç‰¹å¾ï¼‰
```

---

## ğŸ”„ æ•°æ®æµç¨‹

### è®­ç»ƒæµç¨‹

```
è¾“å…¥æ•°æ®ï¼ˆbatchï¼‰
â”œâ”€â”€ src: [batch, 512]          # ä¾§é¢äººè„¸ç‰¹å¾ï¼ˆInsightFaceï¼‰
â”œâ”€â”€ tgt: [batch, 512]          # æ­£é¢äººè„¸ç‰¹å¾ï¼ˆç›®æ ‡ï¼Œç”¨äºè®¡ç®—æŸå¤±ï¼‰
â”œâ”€â”€ keypoints_3d: [batch, 5, 3] # 3Då…³é”®ç‚¹ï¼ˆå·²å¯¹é½å½’ä¸€åŒ–ï¼‰
â”œâ”€â”€ pose: [batch, 3]           # å¤´éƒ¨å§¿æ€ï¼ˆæ¬§æ‹‰è§’ï¼‰
â””â”€â”€ angles: [batch, 3]          # è§’åº¦ï¼ˆå…¼å®¹æ€§ï¼Œ= poseï¼‰

        â†“
    æ¨¡å‹å‰å‘ä¼ æ’­
        â†“
    output: [batch, 512]        # çŸ«æ­£åçš„ç‰¹å¾ï¼ˆåº”è¯¥æ¥è¿‘tgtï¼‰

        â†“
    è®¡ç®—æŸå¤±
    loss = criterion(output, tgt)  # æ¯”è¾ƒoutputå’Œtgtçš„å·®å¼‚
```

---

## ğŸ“Š è¯¦ç»†è¾“å…¥è¯´æ˜

### 1. `src` - ä¾§é¢äººè„¸ç‰¹å¾
- **ç»´åº¦**: `[batch_size, 512]`
- **æ¥æº**: InsightFaceæ¨¡å‹æå–çš„ä¾§é¢äººè„¸ç‰¹å¾
- **ç‰¹ç‚¹**: 
  - L2å½’ä¸€åŒ–åçš„ç‰¹å¾å‘é‡
  - 512ç»´ï¼ˆInsightFace `buffalo_l` æ¨¡å‹ï¼‰
  - ä»£è¡¨ä¾§é¢è§’åº¦çš„é¢éƒ¨ç‰¹å¾

### 2. `keypoints_3d` - 3Då…³é”®ç‚¹
- **ç»´åº¦**: `[batch_size, 5, 3]`
- **æ¥æº**: ä»2Då…³é”®ç‚¹é€šè¿‡PnPç®—æ³•ä¼°è®¡çš„3Dåæ ‡
- **ç‰¹ç‚¹**:
  - 5ä¸ªå…³é”®ç‚¹ï¼ˆInsightFaceçš„5ç‚¹ï¼šå·¦çœ¼ã€å³çœ¼ã€é¼»å°–ã€å·¦å˜´è§’ã€å³å˜´è§’ï¼‰
  - æ¯ä¸ªç‚¹3Dåæ ‡ `[x, y, z]`
  - **å·²å¯¹é½å’Œå½’ä¸€åŒ–**ï¼ˆç›¸å¯¹äºæ­£é¢å›¾çš„å¹³å‡ä½ç½®ï¼‰

### 3. `pose` - å¤´éƒ¨å§¿æ€
- **ç»´åº¦**: `[batch_size, 3]`
- **æ¥æº**: ä»3Då…³é”®ç‚¹ä¼°è®¡çš„å¤´éƒ¨å§¿æ€ï¼ˆæ¬§æ‹‰è§’ï¼‰
- **æ ¼å¼**: `[yaw, pitch, roll]`ï¼ˆå•ä½ï¼šåº¦ï¼‰
  - `yaw`: å·¦å³è½¬å¤´è§’åº¦ï¼ˆ-90Â°åˆ°+90Â°ï¼‰
  - `pitch`: ä¸Šä¸‹æŠ¬å¤´è§’åº¦ï¼ˆ-90Â°åˆ°+90Â°ï¼‰
  - `roll`: å·¦å³å€¾æ–œè§’åº¦ï¼ˆ-90Â°åˆ°+90Â°ï¼‰

### 4. `angles` - è§’åº¦ï¼ˆå…¼å®¹æ€§ï¼‰
- **ç»´åº¦**: `[batch_size, 3]`
- **è¯´æ˜**: ä¸ºäº†å…¼å®¹æ—§ä»£ç ä¿ç•™çš„å‚æ•°ï¼Œå®é™…å€¼ä¸`pose`ç›¸åŒ
- **ç”¨é€”**: åœ¨æ¨¡å‹å†…éƒ¨å®é™…ä½¿ç”¨`pose`ï¼Œ`angles`ä»…ç”¨äºå…¼å®¹æ€§

---

## ğŸ“¤ è¯¦ç»†è¾“å‡ºè¯´æ˜

### `return_residual=True`ï¼ˆé»˜è®¤ï¼‰
```python
residual = model(..., return_residual=True)
# residual: [batch, 512] - æ®‹å·®ç‰¹å¾
corrected_feature = src + residual  # éœ€è¦æ‰‹åŠ¨ç›¸åŠ 
```

### `return_residual=False`ï¼ˆè®­ç»ƒæ—¶ä½¿ç”¨ï¼‰
```python
output = model(..., return_residual=False)
# output: [batch, 512] - å®Œæ•´ç‰¹å¾ï¼ˆå·²åŒ…å«æ®‹å·®ï¼‰
# ç­‰ä»·äº: output = src + residual
```

---

## ğŸ¯ æ¨¡å‹ç›®æ ‡

æ¨¡å‹çš„ç›®æ ‡æ˜¯ï¼š**å°†ä¾§é¢äººè„¸ç‰¹å¾è½¬æ¢ä¸ºæ­£é¢äººè„¸ç‰¹å¾**

- **è¾“å…¥**: ä¾§é¢ç‰¹å¾ + 3Då…³é”®ç‚¹ + å§¿æ€
- **è¾“å‡º**: çŸ«æ­£åçš„ç‰¹å¾ï¼ˆåº”è¯¥æ¥è¿‘æ­£é¢ç‰¹å¾ï¼‰
- **æŸå¤±**: `loss = criterion(output, tgt)`ï¼Œå…¶ä¸­`tgt`æ˜¯çœŸå®çš„æ­£é¢ç‰¹å¾

---

## ğŸ’¡ ä½¿ç”¨ç¤ºä¾‹

### è®­ç»ƒæ—¶
```python
# ä»æ•°æ®åŠ è½½å™¨è·å–batch
batch = next(iter(train_loader))

# æå–è¾“å…¥
src = batch['src'].to(device)              # [32, 512] - ä¾§é¢ç‰¹å¾
tgt = batch['tgt'].to(device)              # [32, 512] - æ­£é¢ç‰¹å¾ï¼ˆç›®æ ‡ï¼‰
keypoints_3d = batch['keypoints_3d'].to(device)  # [32, 5, 3]
pose = batch['pose'].to(device)           # [32, 3]
angles = batch['angles'].to(device)       # [32, 3]

# æ¨¡å‹å‰å‘ä¼ æ’­
output = model(
    src=src,
    angles=angles,
    keypoints_3d=keypoints_3d,
    pose=pose,
    return_residual=False  # è¿”å›å®Œæ•´ç‰¹å¾
)

# è®¡ç®—æŸå¤±ï¼ˆoutputåº”è¯¥æ¥è¿‘tgtï¼‰
loss = criterion(output, tgt)
```

### æ¨ç†æ—¶
```python
# å‡è®¾å·²æœ‰ä¾§é¢ç‰¹å¾ã€3Då…³é”®ç‚¹å’Œå§¿æ€
src = torch.randn(1, 512)              # ä¾§é¢ç‰¹å¾
keypoints_3d = torch.randn(1, 5, 3)   # 3Då…³é”®ç‚¹
pose = torch.tensor([[30.0, 10.0, 5.0]])  # å§¿æ€ï¼ˆåº¦ï¼‰
angles = pose.clone()

# æ¨¡å‹æ¨ç†
output = model(
    src=src,
    angles=angles,
    keypoints_3d=keypoints_3d,
    pose=pose,
    return_residual=False
)

# output: [1, 512] - çŸ«æ­£åçš„ç‰¹å¾ï¼ˆå¯ç”¨äºäººè„¸è¯†åˆ«ï¼‰
```

---

## ğŸ” æ¨¡å‹å†…éƒ¨å¤„ç†æµç¨‹

```
è¾“å…¥
â”œâ”€â”€ src [batch, 512] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”œâ”€â”€ keypoints_3d [batch, 5, 3] â”‚
â”œâ”€â”€ pose [batch, 3] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â””â”€â”€ angles [batch, 3] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“
    [é˜¶æ®µ1: 3Dä¿¡æ¯ç¼–ç ]
    â”œâ”€â”€ ç¼–ç 3Då…³é”®ç‚¹ â†’ kp_features [batch, 512]
    â”œâ”€â”€ ç¼–ç å§¿æ€ â†’ pose_features [batch, 512]
    â””â”€â”€ æŠ•å½±è¾“å…¥ç‰¹å¾ â†’ src_features [batch, 512]
        â†“
    [é˜¶æ®µ2: æ³¨æ„åŠ›èåˆ]
    â”œâ”€â”€ ç©ºé—´æ³¨æ„åŠ›èåˆï¼ˆå¯é€‰ï¼‰
    â””â”€â”€ å§¿æ€æ¡ä»¶æ³¨æ„åŠ›ï¼ˆå¯é€‰ï¼‰
        â†“
    [é˜¶æ®µ3: ç‰¹å¾èåˆ]
    â””â”€â”€ åŠ æƒèåˆ: combined_features = w1*src + w2*kp + w3*pose
        â†“
    [é˜¶æ®µ4: è§’åº¦æ¡ä»¶å¤„ç†]
    â”œâ”€â”€ è§’åº¦ä½ç½®ç¼–ç 
    â””â”€â”€ è§’åº¦æ¡ä»¶å½’ä¸€åŒ–
        â†“
    [é˜¶æ®µ5: Transformerè§£ç ]
    â”œâ”€â”€ è¾“å…¥: tgt [batch, 1, 512]
    â”œâ”€â”€ Memory: angle_memory [batch, 1, 512]
    â””â”€â”€ Transformerè§£ç å™¨
        â†“
    [é˜¶æ®µ6: è¾“å‡ºæŠ•å½±]
    â””â”€â”€ residual [batch, 512]
        â†“
    è¾“å‡º
    â”œâ”€â”€ return_residual=True  â†’ residual [batch, 512]
    â””â”€â”€ return_residual=False â†’ src + residual [batch, 512]
```

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç‰¹å¾ç»´åº¦**: æ‰€æœ‰ç‰¹å¾éƒ½æ˜¯512ç»´ï¼ˆInsightFaceç‰¹å¾ç»´åº¦ï¼‰
2. **å…³é”®ç‚¹æ•°é‡**: å›ºå®šä¸º5ä¸ªï¼ˆInsightFaceçš„5ç‚¹ï¼‰
3. **å§¿æ€ç»´åº¦**: å›ºå®šä¸º3ç»´ï¼ˆæ¬§æ‹‰è§’ï¼‰
4. **æ•°æ®é¢„å¤„ç†**: 3Då…³é”®ç‚¹å¿…é¡»å·²ç»è¿‡å¯¹é½å’Œå½’ä¸€åŒ–å¤„ç†
5. **è®¾å¤‡**: æ‰€æœ‰è¾“å…¥å¿…é¡»åœ¨åŒä¸€è®¾å¤‡ä¸Šï¼ˆCPUæˆ–GPUï¼‰

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- **æ¨¡å‹å®šä¹‰**: `train_transformer3D/models_3d.py`
- **è®­ç»ƒè„šæœ¬**: `train_transformer3D/train_3d.py`
- **æ•°æ®é›†**: `train_transformer3D/dataset.py`
- **æ•°æ®æå–**: `train_transformer3D/extract_and_align_3d_data.py`
