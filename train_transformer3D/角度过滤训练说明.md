# 角度过滤训练说明

## 📋 功能说明

根据诊断结果，模型在大角度下的改进效果更明显：
- **大角度右转 (45° ~ 90°)**: 改进量 0.1056 ✓
- **大角度左转 (-90° ~ -45°)**: 改进量 0.0622 ✓
- **接近正面 (-15° ~ 15°)**: 改进量 0.0158（改进很小）

因此，可以只使用大角度图片进行训练，让模型更专注于学习如何从极端角度正面化。

## 🎯 使用方法

### 只保留大角度图片（排除接近正面的图片）

```bash
C:/Users/62487/.conda/envs/llm/python.exe train_transformer3D/train_3d.py --data_dir train/datas/file --batch_size 32 --epochs 150 --lr 1e-3 --min_yaw_angle 15 --model_type decoder_only --num_decoder_layers 4 --use_spatial_attention --use_pose_attention
```

**说明**：
- `--min_yaw_angle 15`: 只保留 yaw 角度绝对值 >= 15° 的样本
- 这会排除接近正面的图片（-15° ~ 15°）
- 保留所有左转和右转的图片

### 只保留极端角度图片

```bash
C:/Users/62487/.conda/envs/llm/python.exe train_transformer3D/train_3d.py --data_dir train/datas/file --batch_size 32 --epochs 150 --lr 1e-3 --min_yaw_angle 30 --max_yaw_angle 90 --model_type decoder_only --num_decoder_layers 4 --use_spatial_attention --use_pose_attention
```

**说明**：
- `--min_yaw_angle 30`: 只保留 |yaw| >= 30° 的样本
- `--max_yaw_angle 90`: 只保留 |yaw| <= 90° 的样本
- 这会排除接近正面和小角度的图片，只保留中等和极端角度的图片

### 只保留中等角度图片

```bash
C:/Users/62487/.conda/envs/llm/python.exe train_transformer3D/train_3d.py --data_dir train/datas/file --batch_size 32 --epochs 150 --lr 1e-3 --min_yaw_angle 15 --max_yaw_angle 45 --model_type decoder_only --num_decoder_layers 4 --use_spatial_attention --use_pose_attention
```

**说明**：
- `--min_yaw_angle 15`: 只保留 |yaw| >= 15° 的样本
- `--max_yaw_angle 45`: 只保留 |yaw| <= 45° 的样本
- 这会排除接近正面和极端角度的图片，只保留中等角度的图片

## 📊 参数说明

- `--min_yaw_angle`: 最小 yaw 角度阈值（度）
  - 如果设置，只保留 `|yaw| >= min_yaw_angle` 的样本
  - 用于排除接近正面的图片
  - 例如：`--min_yaw_angle 15` 表示只保留 yaw 角度绝对值 >= 15° 的样本

- `--max_yaw_angle`: 最大 yaw 角度阈值（度）
  - 如果设置，只保留 `|yaw| <= max_yaw_angle` 的样本
  - 用于排除极端角度的图片
  - 例如：`--max_yaw_angle 60` 表示只保留 yaw 角度绝对值 <= 60° 的样本

## 💡 训练策略建议

### 策略1：渐进式训练（推荐）

1. **第一阶段**：使用所有数据训练基础模型
   ```bash
   # 不使用角度过滤，训练基础模型
   C:/Users/62487/.conda/envs/llm/python.exe train_transformer3D/train_3d.py --data_dir train/datas/file ...
   ```

2. **第二阶段**：只使用大角度数据微调
   ```bash
   # 使用角度过滤，只保留大角度图片
   C:/Users/62487/.conda/envs/llm/python.exe train_transformer3D/train_3d.py --data_dir train/datas/file --min_yaw_angle 15 --resume train_transformer3D/checkpoints/best_model.pth ...
   ```

### 策略2：直接使用大角度数据训练

如果数据集足够大，可以直接只使用大角度数据训练：

```bash
C:/Users/62487/.conda/envs/llm/python.exe train_transformer3D/train_3d.py --data_dir train/datas/file --min_yaw_angle 15 --batch_size 32 --epochs 150 --lr 1e-3 ...
```

## 📈 预期效果

根据诊断结果，使用大角度数据训练后：

1. **改进量提升**：
   - 大角度右转：改进量从 0.1056 可能进一步提升
   - 大角度左转：改进量从 0.0622 可能进一步提升

2. **模型更专注**：
   - 模型不再需要学习处理接近正面的图片（改进空间小）
   - 可以更专注于学习如何从极端角度正面化

3. **训练效率**：
   - 数据量减少（排除接近正面的图片）
   - 训练速度可能更快
   - 模型容量可以更专注于大角度变换

## ⚠️ 注意事项

1. **数据量**：过滤后确保有足够的数据量（建议至少保留 50% 的数据）

2. **验证集**：验证集也会被过滤，确保验证集仍有足够的样本

3. **正面图保留**：正面图（front）不会被过滤，因为它们是目标特征

4. **角度分布**：检查过滤后的角度分布是否平衡（左右转是否对称）

## 🔍 检查过滤效果

训练开始时会显示：
```
角度过滤设置:
  最小yaw角度阈值: 15.0° (只保留 |yaw| >= 15.0° 的样本)
构建了 10151 个训练样本（过滤前）
角度过滤后剩余 7234 个训练样本
```

可以据此判断过滤效果是否符合预期。
