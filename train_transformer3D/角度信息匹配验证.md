# è§’åº¦ä¿¡æ¯åŒ¹é…éªŒè¯

## ğŸ“‹ Datasetè¿”å›çš„è§’åº¦ä¿¡æ¯

æ ¹æ® `dataset.py` çš„ `__getitem__` æ–¹æ³•ï¼ˆç¬¬211-281è¡Œï¼‰ï¼Œdatasetè¿”å›ä»¥ä¸‹è§’åº¦ä¿¡æ¯ï¼š

### ä¾§é¢è§’åº¦ä¿¡æ¯
```python
# ä»video_posesè·å–ï¼ˆè§†é¢‘å¸§çš„å§¿æ€ï¼‰
pose = self.video_poses[video_idx]  # [3] - æ¬§æ‹‰è§’: yaw, pitch, roll
angles = pose.clone()  # [3] - å…¼å®¹æ€§ï¼Œä¸poseç›¸åŒ
```

### æ­£é¢è§’åº¦ä¿¡æ¯
```python
# ä»front_posesè·å–ï¼ˆæ­£é¢å›¾çš„å§¿æ€ï¼‰
front_pose = self.front_poses[front_idx]  # [3] - æ¬§æ‹‰è§’: yaw, pitch, rollï¼ˆé€šå¸¸æ¥è¿‘[0,0,0]ï¼‰
front_angles = front_pose.clone()  # [3] - å…¼å®¹æ€§ï¼Œä¸front_poseç›¸åŒ
```

### Datasetè¿”å›çš„å®Œæ•´å­—å…¸
```python
return {
    'src': src,  # ä¾§é¢ç‰¹å¾ï¼ˆè§†é¢‘å¸§ï¼‰
    'tgt': tgt,  # æ­£é¢ç‰¹å¾
    'keypoints_3d': keypoints_3d,  # ä¾§é¢å…³é”®ç‚¹ï¼ˆè§†é¢‘å¸§ï¼‰
    'pose': pose,  # ä¾§é¢å§¿æ€ï¼ˆè§†é¢‘å¸§ï¼‰
    'angles': angles,  # ä¾§é¢è§’åº¦ï¼ˆè§†é¢‘å¸§ï¼Œå…¼å®¹æ€§ï¼‰
    'front_keypoints_3d': front_keypoints_3d,  # æ­£é¢å…³é”®ç‚¹
    'front_pose': front_pose,  # æ­£é¢å§¿æ€
    'front_angles': front_angles,  # æ­£é¢è§’åº¦ï¼ˆå…¼å®¹æ€§ï¼‰
    'person_name': sample_info['person_name'],
    'front_idx': front_idx,
    'video_idx': video_idx
}
```

## âœ… è®­ç»ƒä»£ç ä¸­çš„è§’åº¦ä½¿ç”¨

### è®­ç»ƒå‡½æ•°ï¼ˆtrain_gan_epochï¼‰

```python
# ä»batchè·å–è§’åº¦ä¿¡æ¯
side_features = batch['src'].to(device)  # ä¾§é¢ç‰¹å¾
front_features = batch['tgt'].to(device)  # æ­£é¢ç‰¹å¾
keypoints_3d = batch['keypoints_3d'].to(device)  # ä¾§é¢å…³é”®ç‚¹
pose = batch['pose'].to(device)  # ä¾§é¢å§¿æ€
angles = batch['angles'].to(device)  # ä¾§é¢è§’åº¦ï¼ˆä»datasetè·å–ï¼‰

# è·å–æ­£é¢å…³é”®ç‚¹å’Œå§¿æ€ï¼ˆç”¨äºèº«ä»½æŸå¤±ï¼‰
front_keypoints_3d = batch.get('front_keypoints_3d', keypoints_3d).to(device)
front_pose = batch.get('front_pose', pose).to(device)
front_angles = batch.get('front_angles', front_pose.clone()).to(device)  # âœ… ä½¿ç”¨datasetè¿”å›çš„front_angles
```

**åŒ¹é…æƒ…å†µ**ï¼šâœ… **å®Œå…¨åŒ¹é…**
- `angles` æ¥è‡ª `batch['angles']`ï¼Œå¯¹åº”datasetè¿”å›çš„ä¾§é¢è§’åº¦
- `front_angles` æ¥è‡ª `batch.get('front_angles', ...)`ï¼Œå¯¹åº”datasetè¿”å›çš„æ­£é¢è§’åº¦

### éªŒè¯å‡½æ•°ï¼ˆvalidate_ganï¼‰

**ä¿®å¤å‰**ï¼ˆâŒ ä¸åŒ¹é…ï¼‰ï¼š
```python
front_angles = front_pose.clone()  # âŒ æ²¡æœ‰ä½¿ç”¨datasetè¿”å›çš„front_angles
```

**ä¿®å¤å**ï¼ˆâœ… åŒ¹é…ï¼‰ï¼š
```python
front_angles = batch.get('front_angles', front_pose.clone()).to(device)  # âœ… ä½¿ç”¨datasetè¿”å›çš„front_angles
```

## ğŸ¯ è§’åº¦ä¿¡æ¯ä½¿ç”¨æ€»ç»“

| è§’åº¦å˜é‡ | Datasetæ¥æº | è®­ç»ƒä»£ç ä½¿ç”¨ | åŒ¹é…çŠ¶æ€ |
|---------|------------|------------|---------|
| `angles` | `video_poses[video_idx]` (ä¾§é¢) | `batch['angles']` | âœ… åŒ¹é… |
| `pose` | `video_poses[video_idx]` (ä¾§é¢) | `batch['pose']` | âœ… åŒ¹é… |
| `front_angles` | `front_poses[front_idx]` (æ­£é¢) | `batch.get('front_angles', ...)` | âœ… åŒ¹é…ï¼ˆå·²ä¿®å¤ï¼‰ |
| `front_pose` | `front_poses[front_idx]` (æ­£é¢) | `batch.get('front_pose', ...)` | âœ… åŒ¹é… |

## ğŸ“Š è§’åº¦ä¿¡æ¯çš„æ•°æ®æµ

```
Dataset (dataset.py)
  â†“
video_poses[video_idx] â†’ pose â†’ angles (ä¾§é¢è§’åº¦)
front_poses[front_idx] â†’ front_pose â†’ front_angles (æ­£é¢è§’åº¦)
  â†“
Batch (DataLoader)
  â†“
batch['angles'] â†’ angles (ä¾§é¢è§’åº¦)
batch['front_angles'] â†’ front_angles (æ­£é¢è§’åº¦)
  â†“
è®­ç»ƒä»£ç  (gan_train.py)
  â†“
G_AB(ä¾§é¢ç‰¹å¾, angles, ...) â†’ ç”Ÿæˆæ­£é¢ç‰¹å¾
G_BA(æ­£é¢ç‰¹å¾, angles, ...) â†’ ç”Ÿæˆä¾§é¢ç‰¹å¾ï¼ˆä½¿ç”¨ä¾§é¢çš„è§’åº¦ï¼ï¼‰
```

## âš ï¸ å…³é”®ç‚¹

1. **ä¾§é¢è§’åº¦ï¼ˆanglesï¼‰**ï¼š
   - æ¥æºï¼š`video_poses`ï¼ˆè§†é¢‘å¸§çš„å§¿æ€ï¼‰
   - ç”¨é€”ï¼šç”¨äºG_ABï¼ˆä¾§é¢â†’æ­£é¢ï¼‰å’ŒG_BAï¼ˆæ­£é¢â†’ä¾§é¢ï¼‰çš„ç”Ÿæˆ
   - å…³é”®ï¼šG_BAä½¿ç”¨ä¾§é¢çš„è§’åº¦ï¼Œè€Œä¸æ˜¯æ­£é¢çš„è§’åº¦ï¼

2. **æ­£é¢è§’åº¦ï¼ˆfront_anglesï¼‰**ï¼š
   - æ¥æºï¼š`front_poses`ï¼ˆæ­£é¢å›¾çš„å§¿æ€ï¼Œé€šå¸¸æ¥è¿‘[0,0,0]ï¼‰
   - ç”¨é€”ï¼šç”¨äºèº«ä»½æŸå¤±ï¼ˆæ­£é¢â†’æ­£é¢åº”è¯¥ä¿æŒä¸å˜ï¼‰

3. **è§’åº¦å…³ç³»**ï¼š
   - `angles` å’Œ `pose` æ˜¯ç›¸åŒçš„ï¼ˆä¾§é¢è§’åº¦ï¼‰
   - `front_angles` å’Œ `front_pose` æ˜¯ç›¸åŒçš„ï¼ˆæ­£é¢è§’åº¦ï¼‰
   - åœ¨GANè®­ç»ƒä¸­ï¼Œåå‘ç”Ÿæˆï¼ˆG_BAï¼‰ä½¿ç”¨**ä¾§é¢çš„è§’åº¦**ï¼Œè€Œä¸æ˜¯æ­£é¢çš„è§’åº¦

## âœ… éªŒè¯ç»“æœ

ç»è¿‡æ£€æŸ¥å’Œä¿®å¤ï¼Œè§’åº¦ä¿¡æ¯çš„ä½¿ç”¨ç°åœ¨**å®Œå…¨åŒ¹é…**ï¼š

1. âœ… Datasetè¿”å›çš„è§’åº¦ä¿¡æ¯è¢«æ­£ç¡®ä½¿ç”¨
2. âœ… è®­ç»ƒå‡½æ•°å’ŒéªŒè¯å‡½æ•°éƒ½ä½¿ç”¨datasetè¿”å›çš„`front_angles`
3. âœ… è§’åº¦å…³ç³»æ­£ç¡®ï¼šG_BAä½¿ç”¨ä¾§é¢çš„è§’åº¦ï¼ŒG_ABä¹Ÿä½¿ç”¨ä¾§é¢çš„è§’åº¦
4. âœ… èº«ä»½æŸå¤±ä½¿ç”¨æ­£ç¡®çš„è§’åº¦ï¼šæ­£é¢ç”¨æ­£é¢è§’åº¦ï¼Œä¾§é¢ç”¨ä¾§é¢è§’åº¦
