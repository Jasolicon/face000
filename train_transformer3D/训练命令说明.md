# 3Då¢å¼ºTransformeræ¨¡å‹è®­ç»ƒå‘½ä»¤è¯´æ˜

## ğŸ“‹ å¿«é€Ÿå¼€å§‹

### åŸºç¡€è®­ç»ƒå‘½ä»¤ï¼ˆä½¿ç”¨é»˜è®¤å‚æ•°ï¼‰

```bash
python train_transformer3D/train_3d.py
```

è¿™å°†ä½¿ç”¨é»˜è®¤å‚æ•°è¿›è¡Œè®­ç»ƒï¼š
- æ•°æ®ç›®å½•ï¼š`train/datas/file`
- æ‰¹æ¬¡å¤§å°ï¼š32
- æ¨¡å‹ç»´åº¦ï¼š512ï¼ˆInsightFaceç‰¹å¾ç»´åº¦ï¼‰
- è®­ç»ƒè½®æ•°ï¼š100
- å­¦ä¹ ç‡ï¼š1e-4

## ğŸ¯ å®Œæ•´è®­ç»ƒå‘½ä»¤ç¤ºä¾‹

### 1. åŸºç¡€è®­ç»ƒï¼ˆæ¨èï¼‰

```bash
python train_transformer3D/train_3d.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 100 \
    --lr 1e-4
```

### 2. å¯ç”¨3Dæ³¨æ„åŠ›æœºåˆ¶

```bash
python train_transformer3D/train_3d.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 100 \
    --use_spatial_attention \
    --use_pose_attention
```

### 3. è‡ªå®šä¹‰æ¨¡å‹ç»“æ„

```bash
python train_transformer3D/train_3d.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --d_model 512 \
    --nhead 8 \
    --num_layers 6 \
    --dim_feedforward 2048 \
    --dropout 0.1
```

### 4. ä½¿ç”¨CPUè®­ç»ƒ

```bash
python train_transformer3D/train_3d.py \
    --data_dir train/datas/file \
    --device cpu \
    --batch_size 16 \
    --num_workers 0
```

### 5. æ¢å¤è®­ç»ƒ

```bash
python train_transformer3D/train_3d.py \
    --data_dir train/datas/file \
    --resume train_transformer3D/checkpoints/checkpoint_epoch_50.pth \
    --epochs 100
```

### 6. ä½¿ç”¨ç¡®å®šæ€§æ¨¡å¼ï¼ˆå¯å¤ç°ï¼‰

```bash
python train_transformer3D/train_3d.py \
    --data_dir train/datas/file \
    --deterministic \
    --batch_size 32
```

### 7. å®Œæ•´å‚æ•°è®­ç»ƒ

```bash
python train_transformer3D/train_3d.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --num_workers 4 \
    --d_model 512 \
    --nhead 8 \
    --num_layers 4 \
    --dim_feedforward 2048 \
    --dropout 0.1 \
    --num_keypoints 5 \
    --pose_dim 3 \
    --use_spatial_attention \
    --use_pose_attention \
    --epochs 100 \
    --lr 1e-4 \
    --weight_decay 1e-5 \
    --loss_type combined \
    --device cuda \
    --save_dir train_transformer3D/checkpoints \
    --log_dir train_transformer3D/logs
```

## ğŸ“Š å‚æ•°è¯´æ˜

### æ•°æ®å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--data_dir` | `train/datas/file` | æ•°æ®ç›®å½•ï¼ˆåŒ…å«front_*.npyå’Œvideo_*.npyæ–‡ä»¶ï¼‰ |
| `--batch_size` | 32 | æ‰¹æ¬¡å¤§å° |
| `--num_workers` | 4 | æ•°æ®åŠ è½½å™¨å·¥ä½œè¿›ç¨‹æ•°ï¼ˆWindowså»ºè®®ä½¿ç”¨0ï¼‰ |

### æ¨¡å‹å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--d_model` | 512 | æ¨¡å‹ç»´åº¦ï¼ˆInsightFaceç‰¹å¾ç»´åº¦ï¼š512ï¼‰ |
| `--nhead` | 8 | æ³¨æ„åŠ›å¤´æ•° |
| `--num_layers` | 4 | è§£ç å™¨å±‚æ•° |
| `--dim_feedforward` | 2048 | å‰é¦ˆç½‘ç»œç»´åº¦ |
| `--dropout` | 0.1 | Dropoutæ¯”ç‡ |
| `--num_keypoints` | 5 | 3Då…³é”®ç‚¹æ•°é‡ï¼ˆInsightFaceæ˜¯5ä¸ªï¼‰ |
| `--pose_dim` | 3 | å§¿æ€ç»´åº¦ï¼ˆæ¬§æ‹‰è§’ï¼šyaw, pitch, rollï¼‰ |
| `--use_spatial_attention` | False | å¯ç”¨ç©ºé—´æ³¨æ„åŠ›èåˆ |
| `--use_pose_attention` | False | å¯ç”¨å§¿æ€æ¡ä»¶æ³¨æ„åŠ› |

### è®­ç»ƒå‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--epochs` | 100 | è®­ç»ƒè½®æ•° |
| `--lr` | 1e-4 | å­¦ä¹ ç‡ |
| `--weight_decay` | 1e-5 | æƒé‡è¡°å‡ï¼ˆL2æ­£åˆ™åŒ–ï¼‰ |
| `--loss_type` | `combined` | æŸå¤±å‡½æ•°ç±»å‹ï¼š`mse`ã€`cosine`ã€`combined` |

### å…¶ä»–å‚æ•°

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--device` | `cuda`/`cpu` | è®¡ç®—è®¾å¤‡ï¼ˆè‡ªåŠ¨é€‰æ‹©ï¼‰ |
| `--save_dir` | `train_transformer3D/checkpoints` | æ¨¡å‹ä¿å­˜ç›®å½• |
| `--log_dir` | `train_transformer3D/logs` | TensorBoardæ—¥å¿—ç›®å½• |
| `--resume` | None | æ¢å¤è®­ç»ƒçš„æ£€æŸ¥ç‚¹è·¯å¾„ |
| `--deterministic` | False | ä½¿ç”¨ç¡®å®šæ€§æ¨¡å¼ï¼ˆå¯å¤ç°ï¼‰ |

## ğŸ”„ è®­ç»ƒæµç¨‹

### 1. æ•°æ®å‡†å¤‡

é¦–å…ˆéœ€è¦è¿è¡Œæ•°æ®æå–è„šæœ¬ï¼š

```bash
python train_transformer3D/extract_and_align_3d_data.py \
    --face_dir train/datas/face \
    --video_dir train/datas/video \
    --output_dir train/datas/file
```

### 2. å¼€å§‹è®­ç»ƒ

```bash
python train_transformer3D/train_3d.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --epochs 100
```

### 3. ç›‘æ§è®­ç»ƒ

ä½¿ç”¨TensorBoardæŸ¥çœ‹è®­ç»ƒè¿›åº¦ï¼š

```bash
tensorboard --logdir train_transformer3D/logs
```

ç„¶ååœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ `http://localhost:6006`

## ğŸ“ˆ è®­ç»ƒè¾“å‡º

è®­ç»ƒè¿‡ç¨‹ä¸­ä¼šè¾“å‡ºï¼š

- **è®­ç»ƒæŸå¤±**ï¼šæ¯ä¸ªbatchçš„æŸå¤±
- **éªŒè¯æŸå¤±**ï¼šæ¯ä¸ªepochçš„éªŒè¯æŸå¤±
- **ä½™å¼¦ç›¸ä¼¼åº¦**ï¼šç”Ÿæˆç‰¹å¾ä¸ç›®æ ‡ç‰¹å¾çš„ç›¸ä¼¼åº¦
- **å­¦ä¹ ç‡**ï¼šå½“å‰å­¦ä¹ ç‡
- **æ¨¡å‹æ£€æŸ¥ç‚¹**ï¼š
  - `best_model.pth`ï¼šæœ€ä½³æ¨¡å‹ï¼ˆéªŒè¯æŸå¤±æœ€ä½ï¼‰
  - `checkpoint_epoch_N.pth`ï¼šæ¯10ä¸ªepochçš„æ£€æŸ¥ç‚¹

## ğŸ’¡ è®­ç»ƒå»ºè®®

### 1. æ‰¹æ¬¡å¤§å°è°ƒæ•´

- **GPUæ˜¾å­˜å……è¶³**ï¼š`--batch_size 64` æˆ–æ›´å¤§
- **GPUæ˜¾å­˜æœ‰é™**ï¼š`--batch_size 16` æˆ– `--batch_size 8`
- **CPUè®­ç»ƒ**ï¼š`--batch_size 8` æˆ–æ›´å°

### 2. å­¦ä¹ ç‡è°ƒæ•´

- **åˆå§‹è®­ç»ƒ**ï¼š`--lr 1e-4`ï¼ˆé»˜è®¤ï¼‰
- **å¾®è°ƒ**ï¼š`--lr 1e-5` æˆ–æ›´å°
- **å¿«é€Ÿå®éªŒ**ï¼š`--lr 5e-4`ï¼ˆå¯èƒ½ä¸ç¨³å®šï¼‰

### 3. å¯ç”¨3Dæ³¨æ„åŠ›

å¦‚æœæ•°æ®è´¨é‡å¥½ï¼Œå»ºè®®å¯ç”¨ï¼š

```bash
--use_spatial_attention --use_pose_attention
```

### 4. æŸå¤±å‡½æ•°é€‰æ‹©

- **combined**ï¼ˆæ¨èï¼‰ï¼šç»“åˆMSEå’Œä½™å¼¦ç›¸ä¼¼åº¦
- **cosine**ï¼šåªä½¿ç”¨ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆé€‚åˆç‰¹å¾åŒ¹é…ï¼‰
- **mse**ï¼šåªä½¿ç”¨å‡æ–¹è¯¯å·®ï¼ˆé€‚åˆå›å½’ä»»åŠ¡ï¼‰

### 5. Windowsç³»ç»Ÿæ³¨æ„äº‹é¡¹

```bash
# Windowsä¸Šå»ºè®®è®¾ç½® num_workers=0
python train_transformer3D/train_3d.py \
    --data_dir train/datas/file \
    --num_workers 0
```

## ğŸš€ å®Œæ•´è®­ç»ƒç¤ºä¾‹

### ç¤ºä¾‹1ï¼šå¿«é€Ÿå®éªŒï¼ˆå°æ¨¡å‹ï¼‰

```bash
python train_transformer3D/train_3d.py \
    --data_dir train/datas/file \
    --batch_size 16 \
    --d_model 256 \
    --nhead 4 \
    --num_layers 2 \
    --dim_feedforward 1024 \
    --epochs 50 \
    --lr 1e-4
```

### ç¤ºä¾‹2ï¼šå®Œæ•´è®­ç»ƒï¼ˆæ¨èé…ç½®ï¼‰

```bash
python train_transformer3D/train_3d.py \
    --data_dir train/datas/file \
    --batch_size 32 \
    --d_model 512 \
    --nhead 8 \
    --num_layers 4 \
    --dim_feedforward 2048 \
    --dropout 0.1 \
    --use_spatial_attention \
    --use_pose_attention \
    --epochs 100 \
    --lr 1e-4 \
    --weight_decay 1e-5 \
    --loss_type combined \
    --save_dir train_transformer3D/checkpoints \
    --log_dir train_transformer3D/logs
```

### ç¤ºä¾‹3ï¼šä»æ£€æŸ¥ç‚¹æ¢å¤

```bash
python train_transformer3D/train_3d.py \
    --data_dir train/datas/file \
    --resume train_transformer3D/checkpoints/checkpoint_epoch_50.pth \
    --epochs 100
```

## ğŸ“ è®­ç»ƒå‰æ£€æŸ¥æ¸…å•

- [ ] æ•°æ®å·²æå–ï¼šè¿è¡Œ `extract_and_align_3d_data.py`
- [ ] æ•°æ®æ–‡ä»¶å­˜åœ¨ï¼šæ£€æŸ¥ `train/datas/file/` ç›®å½•
- [ ] GPUå¯ç”¨ï¼ˆå¯é€‰ï¼‰ï¼š`nvidia-smi` æ£€æŸ¥GPUçŠ¶æ€
- [ ] ç›®å½•æƒé™ï¼šç¡®ä¿æœ‰å†™å…¥æƒé™

## ğŸ” å¸¸è§é—®é¢˜

### Q: è®­ç»ƒæ—¶å†…å­˜ä¸è¶³æ€ä¹ˆåŠï¼Ÿ
A: å‡å° `--batch_size` æˆ–è®¾ç½® `--num_workers 0`

### Q: å¦‚ä½•æŸ¥çœ‹è®­ç»ƒè¿›åº¦ï¼Ÿ
A: ä½¿ç”¨TensorBoardï¼š`tensorboard --logdir train_transformer3D/logs`

### Q: è®­ç»ƒä¸­æ–­åå¦‚ä½•ç»§ç»­ï¼Ÿ
A: ä½¿ç”¨ `--resume` å‚æ•°æŒ‡å®šæ£€æŸ¥ç‚¹è·¯å¾„

### Q: Windowsä¸Šè®­ç»ƒå¾ˆæ…¢ï¼Ÿ
A: è®¾ç½® `--num_workers 0` å’Œè¾ƒå°çš„ `--batch_size`
