# Universalç½‘ç»œæ•°æ®é›†è¾“å…¥è¯´æ˜

## ğŸ“‹ æ•°æ®æµæ¦‚è§ˆ

```
æ•°æ®é›† (Aligned3DFaceDataset)
    â†“
DataLoader (æ‰¹å¤„ç†)
    â†“
è®­ç»ƒè„šæœ¬ (train_universal.py)
    â†“
æ¨¡å‹ (UniversalFaceTransformer)
```

---

## ğŸ” Datasetè¿”å›çš„æ•°æ®æ ¼å¼

### `__getitem__` è¿”å›çš„å­—å…¸

```python
{
    'src': torch.Tensor,           # [512] è§†é¢‘å¸§ç‰¹å¾ï¼ˆä¾§é¢ç‰¹å¾ï¼‰
    'tgt': torch.Tensor,           # [512] æ­£é¢å›¾ç‰¹å¾ï¼ˆæ­£é¢ç‰¹å¾ï¼‰
    'pose': torch.Tensor,          # [3] è§†é¢‘å¸§å§¿æ€ (yaw, pitch, roll)
    'person_name': str,            # äººå‘˜åç§°
    'keypoints_3d': torch.Tensor, # [5, 3] å…³é”®ç‚¹ï¼ˆUniversalæ¨¡å‹ä¸ä½¿ç”¨ï¼‰
    'angles': torch.Tensor,        # [3] è§’åº¦ï¼ˆå…¼å®¹æ€§ï¼Œç­‰äºposeï¼‰
    'front_keypoints_3d': ...,    # Universalæ¨¡å‹ä¸ä½¿ç”¨
    'front_pose': ...,             # Universalæ¨¡å‹ä¸ä½¿ç”¨
    'front_angles': ...,           # Universalæ¨¡å‹ä¸ä½¿ç”¨
    'front_idx': int,              # ç´¢å¼•ï¼ˆUniversalæ¨¡å‹ä¸ä½¿ç”¨ï¼‰
    'video_idx': int                # ç´¢å¼•ï¼ˆUniversalæ¨¡å‹ä¸ä½¿ç”¨ï¼‰
}
```

### æ•°æ®æ¥æº

- **src** (è§†é¢‘å¸§ç‰¹å¾): ä» `video_feature.npy` åŠ è½½ï¼Œå½¢çŠ¶ `[512]`
- **tgt** (æ­£é¢å›¾ç‰¹å¾): ä» `front_feature.npy` åŠ è½½ï¼Œå½¢çŠ¶ `[512]`
- **pose** (å§¿æ€è§’åº¦): ä» `video_metadata.json` çš„ `poses` å­—æ®µåŠ è½½ï¼Œå½¢çŠ¶ `[3]`
- **person_name**: ä»å…ƒæ•°æ®ä¸­è·å–ï¼Œç”¨äºå¯¹æ¯”å­¦ä¹ 

---

## ğŸ¯ è®­ç»ƒè„šæœ¬ä½¿ç”¨çš„å­—æ®µ

### `train_universal.py` ä¸­çš„ä½¿ç”¨

```python
# ä»batchä¸­æå–æ•°æ®
src = batch['src'].to(device)      # [batch, 512] ä¾§é¢ç‰¹å¾ â†’ æ¨¡å‹è¾“å…¥
tgt = batch['tgt'].to(device)      # [batch, 512] æ­£é¢ç‰¹å¾ â†’ ç›®æ ‡ç‰¹å¾
pose = batch['pose'].to(device)    # [batch, 3] å§¿æ€è§’åº¦ â†’ æ¨¡å‹è¾“å…¥
person_names = batch['person_name'] # [batch] äººå‘˜åç§° â†’ å¯¹æ¯”å­¦ä¹ 
```

### æ•°æ®ç”¨é€”

| å­—æ®µ | ç”¨é€” | å½¢çŠ¶ | è¯´æ˜ |
|------|------|------|------|
| `src` | æ¨¡å‹è¾“å…¥ | `[batch, 512]` | ä¾§é¢ç‰¹å¾ï¼Œè¾“å…¥åˆ°æ¨¡å‹ |
| `pose` | æ¨¡å‹è¾“å…¥ | `[batch, 3]` | å§¿æ€è§’åº¦ï¼Œè¾“å…¥åˆ°æ¨¡å‹ |
| `tgt` | ç›®æ ‡ç‰¹å¾ | `[batch, 512]` | æ­£é¢ç‰¹å¾ï¼Œç”¨äºæŸå¤±è®¡ç®— |
| `person_name` | å¯¹æ¯”å­¦ä¹  | `[batch]` | äººå‘˜IDï¼Œç”¨äºInfoNCEæŸå¤± |

---

## ğŸ§  æ¨¡å‹æœŸæœ›çš„è¾“å…¥

### `UniversalFaceTransformer.forward()`

```python
def forward(self, features, pose_angles=None, mode='train'):
    """
    Args:
        features: [batch, feat_dim=512]  # æ¥è‡ª batch['src']
        pose_angles: [batch, 3] æˆ– None  # æ¥è‡ª batch['pose']
        mode: 'train' æˆ– 'inference'
    """
```

### è¾“å…¥æ•°æ®æµ

```
batch['src'] [batch, 512]
    â†“
model.forward(features=src, pose_angles=pose, mode='train')
    â†“
æ¨¡å‹å†…éƒ¨å¤„ç†ï¼š
  1. feat_proj(features) â†’ [batch, 512]
  2. åˆ‡åˆ†æˆtokens â†’ [batch, 8, 512]
  3. Transformerå¢å¼º
  4. è§£è€¦ â†’ id_features [batch, 256], pose_features [batch, 128]
  5. èº«ä»½å¢å¼º
  6. å§¿æ€ä¼°è®¡
```

---

## ğŸ“Š å®Œæ•´æ•°æ®æµç¤ºä¾‹

### å•ä¸ªæ ·æœ¬

```python
# Datasetè¿”å›
sample = {
    'src': tensor([0.1, 0.2, ..., 0.9]),      # [512] InsightFaceç‰¹å¾
    'tgt': tensor([0.2, 0.3, ..., 0.8]),      # [512] æ­£é¢ç‰¹å¾
    'pose': tensor([45.0, 10.0, -5.0]),        # [3] (yaw, pitch, roll)
    'person_name': 'person_001'
}

# DataLoaderæ‰¹å¤„ç†
batch = {
    'src': tensor([[0.1, ...], [0.2, ...]]),  # [batch_size, 512]
    'tgt': tensor([[0.2, ...], [0.3, ...]]),  # [batch_size, 512]
    'pose': tensor([[45, 10, -5], [30, 5, 0]]), # [batch_size, 3]
    'person_name': ['person_001', 'person_002']
}

# æ¨¡å‹è¾“å…¥
model(src=batch['src'], pose_angles=batch['pose'], mode='train')
```

---

## ğŸ”„ æ•°æ®é…å¯¹ç­–ç•¥

### æ ·æœ¬æ„å»º

- **é…å¯¹è§„åˆ™**: é€šè¿‡ `person_name` å»ºç«‹é…å¯¹
- **æ¯ä¸ªæ ·æœ¬**: ä¸€ä¸ªè§†é¢‘å¸§ï¼ˆä¾§é¢ï¼‰ + å¯¹åº”äººå‘˜çš„æ­£é¢å›¾
- **ç¤ºä¾‹**: 
  - 36ä¸ªäºº
  - æ¯ä¸ªå¹³å‡282ä¸ªè§†é¢‘å¸§
  - æ€»å…±çº¦ 36 Ã— 282 = 10,152 ä¸ªè®­ç»ƒæ ·æœ¬

### æ•°æ®å«ä¹‰

- **src (ä¾§é¢ç‰¹å¾)**: ä¸åŒå§¿æ€çš„äººè„¸ç‰¹å¾ï¼ˆyawè§’åº¦è¾ƒå¤§ï¼‰
- **tgt (æ­£é¢ç‰¹å¾)**: åŒä¸€äººçš„æ­£é¢äººè„¸ç‰¹å¾ï¼ˆyawâ‰ˆ0Â°ï¼‰
- **pose (å§¿æ€è§’åº¦)**: srcå¯¹åº”çš„çœŸå®å§¿æ€è§’åº¦

---

## âœ… æ¨¡å‹å®é™…ä½¿ç”¨çš„å­—æ®µ

### Universalæ¨¡å‹ä½¿ç”¨

| å­—æ®µ | æ˜¯å¦ä½¿ç”¨ | ç”¨é€” |
|------|---------|------|
| `src` | âœ… æ˜¯ | æ¨¡å‹è¾“å…¥ï¼ˆfeaturesï¼‰ |
| `pose` | âœ… æ˜¯ | æ¨¡å‹è¾“å…¥ï¼ˆpose_anglesï¼‰ |
| `tgt` | âœ… æ˜¯ | ç›®æ ‡ç‰¹å¾ï¼ˆæŸå¤±è®¡ç®—ï¼‰ |
| `person_name` | âœ… æ˜¯ | å¯¹æ¯”å­¦ä¹ ï¼ˆInfoNCEæŸå¤±ï¼‰ |
| `keypoints_3d` | âŒ å¦ | Universalæ¨¡å‹ä¸ä½¿ç”¨å…³é”®ç‚¹ |
| `front_keypoints_3d` | âŒ å¦ | ä¸ä½¿ç”¨ |
| `front_pose` | âŒ å¦ | ä¸ä½¿ç”¨ |
| `angles` | âŒ å¦ | å…¼å®¹æ€§å­—æ®µï¼Œç­‰äºpose |

---

## ğŸ¯ å…³é”®ç‚¹æ€»ç»“

1. **æ¨¡å‹è¾“å…¥**ï¼š
   - `features`: `[batch, 512]` - æ¥è‡ª `batch['src']`
   - `pose_angles`: `[batch, 3]` - æ¥è‡ª `batch['pose']`

2. **ç›®æ ‡æ•°æ®**ï¼š
   - `tgt_features`: `[batch, 512]` - æ¥è‡ª `batch['tgt']`ï¼ˆç”¨äºæŸå¤±è®¡ç®—ï¼‰
   - `pose_labels`: `[batch, 3]` - æ¥è‡ª `batch['pose']`ï¼ˆç”¨äºå§¿æ€æŸå¤±ï¼‰
   - `person_names`: `[batch]` - æ¥è‡ª `batch['person_name']`ï¼ˆç”¨äºå¯¹æ¯”å­¦ä¹ ï¼‰

3. **Universalæ¨¡å‹ç‰¹ç‚¹**ï¼š
   - âœ… ä½¿ç”¨ç‰¹å¾å‘é‡ï¼ˆä¸æ˜¯å›¾åƒï¼‰
   - âœ… ä½¿ç”¨å§¿æ€è§’åº¦ï¼ˆä¸æ˜¯å…³é”®ç‚¹ï¼‰
   - âœ… ç›´æ¥ä½¿ç”¨InsightFaceç‰¹å¾ï¼ˆ512ç»´ï¼‰

4. **æ•°æ®ç»´åº¦**ï¼š
   - ç‰¹å¾ç»´åº¦ï¼š512ï¼ˆInsightFaceæ ‡å‡†ï¼‰
   - å§¿æ€ç»´åº¦ï¼š3ï¼ˆyaw, pitch, rollï¼‰
   - èº«ä»½ç‰¹å¾ç»´åº¦ï¼š256ï¼ˆæ¨¡å‹å†…éƒ¨ï¼‰
   - å§¿æ€ç‰¹å¾ç»´åº¦ï¼š128ï¼ˆæ¨¡å‹å†…éƒ¨ï¼‰

---

## ğŸ’¡ æ³¨æ„äº‹é¡¹

1. **å…³é”®ç‚¹æœªä½¿ç”¨**ï¼š
   - Universalæ¨¡å‹ä¸ä½¿ç”¨ `keypoints_3d`
   - åªä½¿ç”¨å§¿æ€è§’åº¦ä½œä¸ºä½ç½®ç¼–ç 

2. **ç‰¹å¾æ¥æº**ï¼š
   - æ‰€æœ‰ç‰¹å¾éƒ½æ˜¯é¢„æå–çš„InsightFaceç‰¹å¾
   - ä¸æ˜¯åŸå§‹å›¾åƒ

3. **å§¿æ€è§’åº¦èŒƒå›´**ï¼š
   - yaw: é€šå¸¸åœ¨ [-90Â°, 90Â°]
   - pitch: é€šå¸¸åœ¨ [-45Â°, 45Â°]
   - roll: é€šå¸¸åœ¨ [-30Â°, 30Â°]

4. **æ•°æ®é…å¯¹**ï¼š
   - æ¯ä¸ªæ ·æœ¬éƒ½æ˜¯ (ä¾§é¢ç‰¹å¾, æ­£é¢ç‰¹å¾) çš„é…å¯¹
   - é€šè¿‡ `person_name` ç¡®ä¿æ˜¯åŒä¸€äºº

---

## ğŸ” æ•°æ®æµéªŒè¯

å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼éªŒè¯æ•°æ®æµï¼š

```python
# æ£€æŸ¥æ•°æ®é›†
dataset = Aligned3DFaceDataset(...)
sample = dataset[0]
print(f"src shape: {sample['src'].shape}")      # [512]
print(f"tgt shape: {sample['tgt'].shape}")      # [512]
print(f"pose shape: {sample['pose'].shape}")    # [3]

# æ£€æŸ¥DataLoader
dataloader = DataLoader(dataset, batch_size=32)
batch = next(iter(dataloader))
print(f"batch['src'] shape: {batch['src'].shape}")    # [32, 512]
print(f"batch['pose'] shape: {batch['pose'].shape}")  # [32, 3]

# æ£€æŸ¥æ¨¡å‹è¾“å…¥
model = UniversalFaceTransformer(...)
outputs = model(batch['src'], batch['pose'], mode='train')
print(f"id_features shape: {outputs['id_features'].shape}")  # [32, 256]
```

---

## ğŸ“ æ€»ç»“

**Datasetè¾“å…¥æ¨¡å‹çš„å†…å®¹**ï¼š

1. **ä¸»è¦è¾“å…¥**ï¼š
   - `src`: `[batch, 512]` - ä¾§é¢ç‰¹å¾ï¼ˆæ¨¡å‹è¾“å…¥ï¼‰
   - `pose`: `[batch, 3]` - å§¿æ€è§’åº¦ï¼ˆæ¨¡å‹è¾“å…¥ï¼‰

2. **ç›®æ ‡æ•°æ®**ï¼š
   - `tgt`: `[batch, 512]` - æ­£é¢ç‰¹å¾ï¼ˆæŸå¤±è®¡ç®—ï¼‰
   - `person_name`: `[batch]` - äººå‘˜IDï¼ˆå¯¹æ¯”å­¦ä¹ ï¼‰

3. **æœªä½¿ç”¨çš„å­—æ®µ**ï¼š
   - `keypoints_3d` - Universalæ¨¡å‹ä¸ä½¿ç”¨å…³é”®ç‚¹
   - `front_keypoints_3d` - ä¸ä½¿ç”¨
   - `front_pose` - ä¸ä½¿ç”¨

**æ•°æ®æµ**ï¼š
```
Dataset â†’ DataLoader â†’ è®­ç»ƒè„šæœ¬ â†’ æ¨¡å‹
  [512]     [B,512]      [B,512]    [B,512]
  [3]       [B,3]        [B,3]      [B,3]
```
