# æ•°æ®é›†è¯»å–è¯´æ˜

## ğŸ“ æ•°æ®æ ¼å¼

æ•°æ®é›†ä½¿ç”¨å¯¹é½å’Œå½’ä¸€åŒ–åçš„npyå’Œjsonæ–‡ä»¶æ ¼å¼ï¼š

```
train/datas/file/
â”œâ”€â”€ front_feature.npy          # æ­£é¢å›¾ç‰¹å¾ [N, 512] (InsightFaceç‰¹å¾)
â”œâ”€â”€ front_keypoints.npy        # æ­£é¢å›¾å¯¹é½å½’ä¸€åŒ–åçš„å…³é”®ç‚¹ [N, 5, 3]
â”œâ”€â”€ front_metadata.json        # æ­£é¢å›¾å…ƒæ•°æ®ï¼ˆåŒ…å«æ ‡å‡†åæ ‡ç³»ä¿¡æ¯ï¼‰
â”œâ”€â”€ video_feature.npy          # è§†é¢‘å¸§ç‰¹å¾ [M, 512] (InsightFaceç‰¹å¾)
â”œâ”€â”€ video_keypoints.npy        # è§†é¢‘å¸§å¯¹é½å½’ä¸€åŒ–åçš„å…³é”®ç‚¹ [M, 5, 3]
â””â”€â”€ video_metadata.json        # è§†é¢‘å¸§å…ƒæ•°æ®
```

## ğŸ”§ æ•°æ®é›†ç±»ï¼šAligned3DFaceDataset

### åˆå§‹åŒ–å‚æ•°

```python
dataset = Aligned3DFaceDataset(
    data_dir='train/datas/file',  # æ•°æ®ç›®å½•
    load_in_memory=True           # æ˜¯å¦å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜
)
```

### å‚æ•°è¯´æ˜

- `data_dir`: æ•°æ®ç›®å½•è·¯å¾„ï¼ŒåŒ…å«æ‰€æœ‰npyå’Œjsonæ–‡ä»¶
- `load_in_memory`: 
  - `True`: å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ï¼ˆé€Ÿåº¦å¿«ï¼Œä½†å ç”¨å†…å­˜ï¼‰
  - `False`: ä½¿ç”¨å†…å­˜æ˜ å°„ï¼ˆèŠ‚çœå†…å­˜ï¼Œä½†é€Ÿåº¦ç¨æ…¢ï¼‰

### è¿”å›çš„æ•°æ®æ ¼å¼

æ¯ä¸ªæ ·æœ¬åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

```python
{
    'src': torch.Tensor,              # è§†é¢‘å¸§ç‰¹å¾ [feature_dim]
    'tgt': torch.Tensor,              # æ­£é¢å›¾ç‰¹å¾ [feature_dim]
    'keypoints_3d': torch.Tensor,     # è§†é¢‘å¸§3Då…³é”®ç‚¹ [5, 3]ï¼ˆå·²å¯¹é½å’Œå½’ä¸€åŒ–ï¼‰
    'pose': torch.Tensor,              # è§†é¢‘å¸§å§¿æ€å‘é‡ [3] (æ¬§æ‹‰è§’: yaw, pitch, roll)
    'angles': torch.Tensor,            # è§’åº¦ï¼ˆå…¼å®¹æ€§ï¼Œä½¿ç”¨poseï¼‰[3]
    'front_keypoints_3d': torch.Tensor, # æ­£é¢å›¾3Då…³é”®ç‚¹ [5, 3]ï¼ˆå¯é€‰ï¼‰
    'front_pose': torch.Tensor,        # æ­£é¢å›¾å§¿æ€å‘é‡ [3]ï¼ˆå¯é€‰ï¼‰
    'person_name': str,                # äººå
    'front_idx': int,                  # æ­£é¢å›¾ç´¢å¼•
    'video_idx': int                   # è§†é¢‘å¸§ç´¢å¼•
}
```

## ğŸ“Š æ•°æ®åŠ è½½å™¨

### åˆ›å»ºæ•°æ®åŠ è½½å™¨

```python
from train_transformer3D.dataset import create_dataloader

dataloader = create_dataloader(
    data_dir='train/datas/file',
    batch_size=32,
    shuffle=True,
    num_workers=4,
    pin_memory=True,
    load_in_memory=True
)
```

### å‚æ•°è¯´æ˜

- `data_dir`: æ•°æ®ç›®å½•
- `batch_size`: æ‰¹æ¬¡å¤§å°
- `shuffle`: æ˜¯å¦æ‰“ä¹±æ•°æ®
- `num_workers`: æ•°æ®åŠ è½½å™¨å·¥ä½œè¿›ç¨‹æ•°
- `pin_memory`: æ˜¯å¦ä½¿ç”¨pin_memoryï¼ˆGPUè®­ç»ƒæ—¶å»ºè®®Trueï¼‰
- `load_in_memory`: æ˜¯å¦å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜

## ğŸ” æ•°æ®å¯¹åº”å…³ç³»

æ•°æ®é›†é€šè¿‡ `person_name` å»ºç«‹æ­£é¢å›¾å’Œè§†é¢‘å¸§çš„å¯¹åº”å…³ç³»ï¼š

1. **ä¸€ä¸ªæ­£é¢å›¾å¯¹åº”å¤šä¸ªè§†é¢‘å¸§**ï¼šæ¯ä¸ªäººçš„æ­£é¢å›¾ä¼šä¸è¯¥äººçš„æ‰€æœ‰è§†é¢‘å¸§é…å¯¹
2. **æ ·æœ¬æ•°é‡**ï¼š`num_samples = num_front_images Ã— num_video_frames_per_person`

ä¾‹å¦‚ï¼š
- 36ä¸ªæ­£é¢å›¾
- æ¯ä¸ªæ­£é¢å›¾å¯¹åº”è¯¥äººçš„æ‰€æœ‰è§†é¢‘å¸§ï¼ˆå‡è®¾å¹³å‡æ¯äºº278å¸§ï¼‰
- æ€»æ ·æœ¬æ•° = 36 Ã— 278 = 10,008 ä¸ªè®­ç»ƒæ ·æœ¬

## ğŸ“ˆ æ•°æ®é›†ç»Ÿè®¡ä¿¡æ¯

```python
stats = dataset.get_statistics()
# è¿”å›ï¼š
# {
#     'num_samples': 10008,           # æ€»æ ·æœ¬æ•°
#     'num_front_images': 36,         # æ­£é¢å›¾æ•°é‡
#     'num_video_images': 10015,      # è§†é¢‘å¸§æ€»æ•°
#     'feature_dim': 512,              # ç‰¹å¾ç»´åº¦ï¼ˆInsightFaceï¼‰
#     'num_keypoints': 5,              # å…³é”®ç‚¹æ•°é‡
#     'keypoint_dim': 3,               # å…³é”®ç‚¹ç»´åº¦ï¼ˆ3Dï¼‰
#     'pose_dim': 3,                   # å§¿æ€ç»´åº¦ï¼ˆæ¬§æ‹‰è§’ï¼‰
#     'unique_persons': 36            # å”¯ä¸€äººæ•°
# }
```

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. åŸºæœ¬ä½¿ç”¨

```python
from train_transformer3D.dataset import Aligned3DFaceDataset

# åˆ›å»ºæ•°æ®é›†
dataset = Aligned3DFaceDataset(data_dir='train/datas/file')

# è·å–ä¸€ä¸ªæ ·æœ¬
sample = dataset[0]
print(f"srcå½¢çŠ¶: {sample['src'].shape}")        # [512]
print(f"tgtå½¢çŠ¶: {sample['tgt'].shape}")        # [512]
print(f"keypoints_3då½¢çŠ¶: {sample['keypoints_3d'].shape}")  # [5, 3]
print(f"poseå½¢çŠ¶: {sample['pose'].shape}")      # [3]
```

### 2. è®­ç»ƒä¸­ä½¿ç”¨

```python
from train_transformer3D.dataset import create_dataloader

# åˆ›å»ºæ•°æ®åŠ è½½å™¨
train_loader = create_dataloader(
    data_dir='train/datas/file',
    batch_size=32,
    shuffle=True
)

# è®­ç»ƒå¾ªç¯
for batch in train_loader:
    src = batch['src']              # [batch_size, 512]
    tgt = batch['tgt']              # [batch_size, 512]
    keypoints_3d = batch['keypoints_3d']  # [batch_size, 5, 3]
    pose = batch['pose']            # [batch_size, 3]
    
    # å‰å‘ä¼ æ’­
    output = model(
        src=src,
        angles=pose,
        keypoints_3d=keypoints_3d,
        pose=pose
    )
    
    # è®¡ç®—æŸå¤±
    loss = criterion(output, tgt)
    # ...
```

### 3. æµ‹è¯•æ•°æ®é›†

```bash
python train_transformer3D/dataset.py
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å†…å­˜ä½¿ç”¨**ï¼š
   - `load_in_memory=True`: é€‚åˆæ•°æ®é‡è¾ƒå°æˆ–å†…å­˜å……è¶³çš„æƒ…å†µ
   - `load_in_memory=False`: é€‚åˆæ•°æ®é‡å¾ˆå¤§æˆ–å†…å­˜æœ‰é™çš„æƒ…å†µ

2. **æ•°æ®å¯¹é½**ï¼š
   - æ‰€æœ‰å…³é”®ç‚¹éƒ½å·²å¯¹é½å’Œå½’ä¸€åŒ–åˆ°æ ‡å‡†åæ ‡ç³»
   - æ ‡å‡†åæ ‡ç³»ä¿¡æ¯ä¿å­˜åœ¨ `front_metadata.json` çš„ `standard_info` å­—æ®µä¸­

3. **ç‰¹å¾ç»´åº¦**ï¼š
   - ä½¿ç”¨ InsightFace (`buffalo_l`) æå–ç‰¹å¾ï¼Œç‰¹å¾ç»´åº¦ä¸º512
   - ç‰¹å¾å·²ç»L2å½’ä¸€åŒ–ï¼ˆ`normed_embedding`ï¼‰

4. **å…³é”®ç‚¹æ ¼å¼**ï¼š
   - å…³é”®ç‚¹å½¢çŠ¶ï¼š`[5, 3]`ï¼ˆ5ä¸ªå…³é”®ç‚¹ï¼Œæ¯ä¸ª3Dåæ ‡ï¼‰
   - å…³é”®ç‚¹é¡ºåºï¼šå·¦çœ¼ã€å³çœ¼ã€é¼»å°–ã€å·¦å˜´è§’ã€å³å˜´è§’

5. **å§¿æ€æ ¼å¼**ï¼š
   - å§¿æ€å½¢çŠ¶ï¼š`[3]`ï¼ˆæ¬§æ‹‰è§’ï¼‰
   - é¡ºåºï¼š`[yaw, pitch, roll]`ï¼ˆå•ä½ï¼šåº¦ï¼‰

## ğŸ”„ ä¸æ—§æ•°æ®æ ¼å¼çš„å¯¹æ¯”

| ç‰¹æ€§ | æ—§æ ¼å¼ (dataset_3d.py) | æ–°æ ¼å¼ (dataset.py) |
|------|------------------------|---------------------|
| æ•°æ®æº | JSONæ–‡ä»¶ | npy + jsonæ–‡ä»¶ |
| åŠ è½½é€Ÿåº¦ | è¾ƒæ…¢ï¼ˆéœ€è¦è§£æJSONï¼‰ | è¾ƒå¿«ï¼ˆnpyç›´æ¥åŠ è½½ï¼‰ |
| å†…å­˜å ç”¨ | è¾ƒé«˜ï¼ˆJSONè§£æåï¼‰ | è¾ƒä½ï¼ˆnpyæ›´ç´§å‡‘ï¼‰ |
| æ•°æ®å¯¹é½ | æœªå¯¹é½ | å·²å¯¹é½å’Œå½’ä¸€åŒ– |
| é€‚ç”¨åœºæ™¯ | ä¸´æ—¶æ•°æ® | ç”Ÿäº§ç¯å¢ƒ |

## ğŸ“ æ•°æ®ç”Ÿæˆ

ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆæ•°æ®ï¼š

```bash
python train_transformer3D/extract_and_align_3d_data.py \
    --face_dir train/datas/face \
    --video_dir train/datas/video \
    --output_dir train/datas/file
```

è¿™å°†ç”Ÿæˆæ‰€æœ‰å¿…éœ€çš„npyå’Œjsonæ–‡ä»¶ã€‚
