# train_transformer3D ä½¿ç”¨è¯´æ˜

## ğŸ“ æ–‡ä»¶ç»“æ„

```
train_transformer3D/
â”œâ”€â”€ __init__.py                    # æ¨¡å—åˆå§‹åŒ–
â”œâ”€â”€ utils_3d.py                    # 3Då…³é”®ç‚¹å’Œå§¿æ€æå–å·¥å…·
â”œâ”€â”€ filter_valid_images_3d.py      # æ•°æ®æå–è„šæœ¬ï¼ˆç”Ÿæˆvalid_images_3d.jsonï¼‰
â”œâ”€â”€ models_3d.py                    # 3Då¢å¼ºçš„Transformeræ¨¡å‹
â”œâ”€â”€ dataset_3d.py                  # 3Dæ•°æ®é›†ç±»
â”œâ”€â”€ train_3d.py                    # è®­ç»ƒè„šæœ¬
â”œâ”€â”€ data_adapter.py                # æ•°æ®é€‚é…å™¨ï¼ˆå¯é€‰ï¼‰
â”œâ”€â”€ README.md                      # é¡¹ç›®è¯´æ˜
â””â”€â”€ ä½¿ç”¨è¯´æ˜.md                    # æœ¬æ–‡æ¡£
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æå–3Då…³é”®ç‚¹å’Œå§¿æ€æ•°æ®

é¦–å…ˆï¼Œä½¿ç”¨ `filter_valid_images_3d.py` ä»å›¾åƒä¸­æå–3Då…³é”®ç‚¹å’Œå§¿æ€ï¼š

```bash
python train_transformer3D/filter_valid_images_3d.py \
    --video_dir /path/to/video \
    --face_dir /path/to/face \
    --output_file train_transformer3D/valid_images_3d.json \
    --use_cpu  # å¦‚æœä½¿ç”¨CPU
```

è¿™å°†ç”ŸæˆåŒ…å«ä»¥ä¸‹ä¿¡æ¯çš„JSONæ–‡ä»¶ï¼š
- `face_features`: æ­£é¢å›¾DINOv2ç‰¹å¾
- `face_landmarks_3d`: æ­£é¢å›¾3Då…³é”®ç‚¹ [5, 3]
- `face_euler_angles`: æ­£é¢å›¾å§¿æ€ [yaw, pitch, roll]
- `video_data`: è§†é¢‘å¸§æ•°æ®åˆ—è¡¨ï¼Œæ¯ä¸ªåŒ…å«ï¼š
  - `features`: DINOv2ç‰¹å¾
  - `landmarks_3d`: 3Då…³é”®ç‚¹ [5, 3]
  - `euler_angles`: å§¿æ€ [yaw, pitch, roll]
  - `rotation_matrix`: æ—‹è½¬çŸ©é˜µ [3, 3]ï¼ˆå¯é€‰ï¼‰

### 2. è®­ç»ƒ3Då¢å¼ºæ¨¡å‹

ä½¿ç”¨ `train_3d.py` è®­ç»ƒæ¨¡å‹ï¼š

```bash
python train_transformer3D/train_3d.py \
    --valid_images_3d_file train_transformer3D/valid_images_3d.json \
    --batch_size 32 \
    --epochs 100 \
    --lr 1e-4 \
    --use_spatial_attention \
    --use_pose_attention \
    --save_dir train_transformer3D/checkpoints \
    --log_dir train_transformer3D/logs
```

### 3. ä¸»è¦å‚æ•°è¯´æ˜

#### æ¨¡å‹å‚æ•°
- `--d_model`: æ¨¡å‹ç»´åº¦ï¼ˆé»˜è®¤768ï¼‰
- `--nhead`: æ³¨æ„åŠ›å¤´æ•°ï¼ˆé»˜è®¤8ï¼‰
- `--num_layers`: è§£ç å™¨å±‚æ•°ï¼ˆé»˜è®¤4ï¼‰
- `--num_keypoints`: 3Då…³é”®ç‚¹æ•°é‡ï¼ˆé»˜è®¤5ï¼ŒInsightFaceï¼‰
- `--pose_dim`: å§¿æ€ç»´åº¦ï¼ˆé»˜è®¤3ï¼Œæ¬§æ‹‰è§’ï¼‰
- `--use_spatial_attention`: å¯ç”¨ç©ºé—´æ³¨æ„åŠ›èåˆ
- `--use_pose_attention`: å¯ç”¨å§¿æ€æ¡ä»¶æ³¨æ„åŠ›

#### è®­ç»ƒå‚æ•°
- `--batch_size`: æ‰¹æ¬¡å¤§å°ï¼ˆé»˜è®¤32ï¼‰
- `--epochs`: è®­ç»ƒè½®æ•°ï¼ˆé»˜è®¤100ï¼‰
- `--lr`: å­¦ä¹ ç‡ï¼ˆé»˜è®¤1e-4ï¼‰
- `--loss_type`: æŸå¤±å‡½æ•°ç±»å‹ï¼ˆmse/cosine/combinedï¼Œé»˜è®¤combinedï¼‰

## ğŸ”§ æ¨¡å‹æ¶æ„

### TransformerDecoderOnly3D

3Då¢å¼ºçš„Transformerè§£ç å™¨ï¼ŒåŒ…å«ä»¥ä¸‹ç»„ä»¶ï¼š

1. **3Dä¿¡æ¯å¤„ç†åˆ†æ”¯**
   - `SpatialAttentionFusion`: ç©ºé—´æ³¨æ„åŠ›èåˆï¼ˆä½¿ç”¨3Då…³é”®ç‚¹ï¼‰
   - `PoseConditionedAttention`: å§¿æ€æ¡ä»¶æ³¨æ„åŠ›ï¼ˆä½¿ç”¨æ¬§æ‹‰è§’ï¼‰
   - `keypoint_encoder`: 3Då…³é”®ç‚¹ç¼–ç å™¨
   - `pose_encoder`: å§¿æ€ç¼–ç å™¨

2. **è§’åº¦æ¡ä»¶å¤„ç†**ï¼ˆä¿ç•™åŸè®¾è®¡ï¼‰
   - `AnglePositionalEncoding`: è§’åº¦ä½ç½®ç¼–ç 
   - `AngleConditionedLayerNorm`: è§’åº¦æ¡ä»¶å½’ä¸€åŒ–

3. **Transformerè§£ç å™¨**
   - æ ‡å‡†TransformerDecoderLayer
   - ä½¿ç”¨å§¿æ€ç¼–ç ä½œä¸ºmemory

### æ•°æ®æµ

```
è¾“å…¥ç‰¹å¾ â†’ 3Dä¿¡æ¯èåˆ â†’ è§’åº¦æ¡ä»¶å¤„ç† â†’ Transformerè§£ç  â†’ è¾“å‡º
    â”‚           â”‚            â”‚
    â””â”€ç©ºé—´æ³¨æ„åŠ›  â””â”€å§¿æ€æ³¨æ„åŠ›  â””â”€ä½ç½®ç¼–ç +æ¡ä»¶å½’ä¸€åŒ–
```

## ğŸ“Š æ•°æ®æ ¼å¼

### è¾“å…¥æ•°æ®æ ¼å¼

æ¨¡å‹éœ€è¦ä»¥ä¸‹è¾“å…¥ï¼š

- `src`: ä¾§é¢ç‰¹å¾ [batch, 768]
- `keypoints_3d`: 3Då…³é”®ç‚¹ [batch, 5, 3]
- `pose`: å§¿æ€å‘é‡ [batch, 3] (æ¬§æ‹‰è§’: yaw, pitch, roll)
- `angles`: è§’åº¦ï¼ˆå…¼å®¹æ€§ï¼Œä½¿ç”¨poseï¼‰[batch, 3]

### è¾“å‡ºæ•°æ®æ ¼å¼

- `output`: æ®‹å·® [batch, 768] æˆ–å®Œæ•´ç‰¹å¾ [batch, 768]

## ğŸ” æ£€æŸ¥ç‚¹

### 1. æ•°æ®æ–‡ä»¶æ£€æŸ¥

ç¡®ä¿ `valid_images_3d.json` åŒ…å«ä»¥ä¸‹å­—æ®µï¼š
- `face_features`: åˆ—è¡¨
- `face_landmarks_3d`: åˆ—è¡¨ï¼Œå½¢çŠ¶ [5, 3]
- `face_euler_angles`: åˆ—è¡¨ï¼Œé•¿åº¦3
- `video_data`: åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ åŒ…å« `features`, `landmarks_3d`, `euler_angles`

### 2. æ¨¡å‹æ£€æŸ¥

è¿è¡Œæ¨¡å‹æµ‹è¯•ï¼š

```bash
python train_transformer3D/models_3d.py
```

### 3. æ•°æ®é›†æ£€æŸ¥

è¿è¡Œæ•°æ®é›†æµ‹è¯•ï¼š

```bash
python train_transformer3D/dataset_3d.py
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ä¾èµ–é¡¹**
   - éœ€è¦ `train_transformer` æ¨¡å—ä¸­çš„ `AnglePositionalEncoding` å’Œ `AngleConditionedLayerNorm`
   - éœ€è¦ `train_transformer.losses` ä¸­çš„æŸå¤±å‡½æ•°
   - éœ€è¦ `train_transformer.utils_seed` ä¸­çš„éšæœºç§å­è®¾ç½®

2. **æ•°æ®æ ¼å¼ä¸€è‡´æ€§**
   - ç¡®ä¿æ‰€æœ‰å…³é”®ç‚¹éƒ½æ˜¯3Dåæ ‡ [num_kp, 3]
   - ç¡®ä¿å§¿æ€æ˜¯æ¬§æ‹‰è§’ [yaw, pitch, roll]ï¼Œå•ä½ä¸ºåº¦

3. **å†…å­˜ä½¿ç”¨**
   - 3Dæ¨¡å‹æ¯”2Dæ¨¡å‹å‚æ•°æ›´å¤šï¼Œæ³¨æ„æ˜¾å­˜ä½¿ç”¨
   - å¦‚æœæ˜¾å­˜ä¸è¶³ï¼Œå‡å° `batch_size` æˆ– `d_model`

4. **è®­ç»ƒå»ºè®®**
   - å…ˆä½¿ç”¨è¾ƒå°çš„æ¨¡å‹ï¼ˆ`num_layers=2`ï¼‰å¿«é€ŸéªŒè¯
   - ä½¿ç”¨ `--use_spatial_attention` å’Œ `--use_pose_attention` è·å¾—æœ€ä½³æ€§èƒ½
   - ç›‘æ§éªŒè¯æŸå¤±å’Œä½™å¼¦ç›¸ä¼¼åº¦

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

| æ¨¡å‹ | å‚æ•°é‡ | è¾“å…¥ | ä¼˜åŠ¿ |
|------|--------|------|------|
| TransformerDecoderOnly (2D) | ~15M | ç‰¹å¾ + è§’åº¦ | ç®€å•ï¼Œå¿«é€Ÿ |
| TransformerDecoderOnly3D | ~18M | ç‰¹å¾ + 3Då…³é”®ç‚¹ + å§¿æ€ | æ›´å‡†ç¡®ï¼Œé²æ£’æ€§æ›´å¼º |

## ğŸ› å¸¸è§é—®é¢˜

### Q1: å¯¼å…¥é”™è¯¯ `ModuleNotFoundError: No module named 'train_transformer'`

**A**: ç¡®ä¿é¡¹ç›®æ ¹ç›®å½•åœ¨Pythonè·¯å¾„ä¸­ï¼Œæˆ–ä½¿ç”¨ç›¸å¯¹å¯¼å…¥ã€‚

### Q2: æ•°æ®æ–‡ä»¶æ ¼å¼é”™è¯¯

**A**: æ£€æŸ¥ `valid_images_3d.json` æ˜¯å¦åŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µï¼Œä½¿ç”¨ `dataset_3d.py` éªŒè¯ã€‚

### Q3: æ˜¾å­˜ä¸è¶³

**A**: å‡å° `batch_size`ã€`d_model` æˆ– `num_layers`ã€‚

### Q4: è®­ç»ƒæŸå¤±ä¸ä¸‹é™

**A**: 
- æ£€æŸ¥å­¦ä¹ ç‡æ˜¯å¦åˆé€‚
- æ£€æŸ¥æ•°æ®æ˜¯å¦æ­£ç¡®åŠ è½½
- å°è¯•ä½¿ç”¨ä¸åŒçš„æŸå¤±å‡½æ•°ï¼ˆ`--loss_type combined`ï¼‰

## ğŸ“ ä¸‹ä¸€æ­¥

1. **æ¶ˆèå®éªŒ**: åˆ†åˆ«æµ‹è¯•ç©ºé—´æ³¨æ„åŠ›å’Œå§¿æ€æ³¨æ„åŠ›çš„æ•ˆæœ
2. **è¶…å‚æ•°è°ƒä¼˜**: è°ƒæ•´èåˆæƒé‡ã€å­¦ä¹ ç‡ç­‰
3. **æ¨¡å‹é›†æˆ**: ç»“åˆå¤šä¸ªæ¨¡å‹çš„é¢„æµ‹ç»“æœ
4. **éƒ¨ç½²ä¼˜åŒ–**: æ¨¡å‹é‡åŒ–å’ŒåŠ é€Ÿ

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `README.md`: é¡¹ç›®æ¦‚è¿°
- `train_transformer/`: 2Dç‰ˆæœ¬å®ç°å‚è€ƒ
- `utils_3d.py`: 3Då…³é”®ç‚¹æå–è¯¦ç»†è¯´æ˜
