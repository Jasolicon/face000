# 多角度人脸识别训练系统使用说明

## 系统概述

本系统训练一个**角度不变的特征提取模型**，使得：
- 同一人的正脸和多角度人脸在特征空间中距离近
- 不同人的特征在特征空间中距离远
- **适用于只有正脸图片，需要识别多角度人脸的场景**

## 应用场景分析

### 推荐方案：特征对比（Feature Comparison）✅

**为什么特征对比更适合？**

1. **灵活性**：
   - 训练一次，适用于所有人
   - 新增人员只需添加正脸特征，无需重新训练
   - 支持few-shot学习

2. **效率**：
   - 推理时只需提取特征并对比
   - 计算成本低，适合大规模部署

3. **准确性**：
   - 通过训练学习角度不变性
   - 特征空间中对齐不同角度的人脸

**vs 识别模型**：
- 识别模型需要为每个人训练，不适合动态人员库
- 特征对比更适合"只有正脸，识别多角度"的场景

## 模型架构

```
输入: 正脸图像 + 多角度人脸图像
  ↓
CLIP Vision Encoder (预训练，强大的视觉理解)
  ↓
角度不变性模块 (Angle-Invariant Module)
  - 特征变换网络
  - 自注意力机制
  ↓
特征投影层
  ↓
输出: 512维特征向量（L2归一化）
```

### 损失函数

1. **交叉熵损失**（ArcFace logits）
   - 确保类内紧凑、类间分离
   - 使用ArcFace margin增强区分度

2. **对比损失**（Contrastive Loss）
   - 正脸-多角度对拉近
   - 不同人拉远

3. **特征一致性损失**
   - 同一人的正脸和多角度特征应该相似

## 数据准备

### 数据格式

支持两种数据格式：

#### 格式1: 文件名对应模式（推荐）

```
datas/
├── 张三.jpg          # 正脸图片（文件名即人名）
├── 张三.mp4          # 视频（文件名与图片对应）
├── 李四.jpg
├── 李四.mp4
├── 王五.jpg
└── 王五.mp4
```

**说明**：
- 同名的 `.jpg` 和 `.mp4` 文件对应同一个人
- 文件名就是人名（如：张三.jpg 和 张三.mp4）

#### 格式2: 目录模式

```
datas/
├── person_001/
│   ├── face.jpg 或 front.jpg    # 正脸图片
│   └── video.mp4                # 视频
├── person_002/
│   ├── face.jpg
│   └── video.mp4
└── ...
```

### 数据要求

1. **正脸图片**：
   - 格式：jpg, jpeg, png
   - 命名：
     - 格式1: `人名.jpg`（如：张三.jpg）
     - 格式2: `face.jpg` 或 `front.jpg`
   - 要求：清晰的正面人脸

2. **视频文件**：
   - 格式：mp4, avi, mov
   - 命名：
     - 格式1: `人名.mp4`（如：张三.mp4，与图片文件名对应）
     - 格式2: `video.mp4`
   - 内容：多角度转头视频，包含不同角度的人脸

3. **对应关系**：
   - 格式1: 通过文件名匹配（张三.jpg ↔ 张三.mp4）
   - 格式2: 在同一目录下（person_001/face.jpg ↔ person_001/video.mp4）

## 训练步骤

### 1. 准备数据

```bash
# 组织数据目录
mkdir -p train/datas
# 将数据按文件名对应格式组织：
# 张三.jpg + 张三.mp4
# 李四.jpg + 李四.mp4
```

### 2. 预处理视频（推荐）

在训练前，将视频拆分成帧图片，可以加快训练速度：

```bash
# 批量处理所有视频
python train/preprocess_videos.py \
    --data_dir train/datas \
    --frame_interval 1 \
    --max_frames 100

# 处理单个视频
python train/preprocess_videos.py \
    --single_video train/datas/张三.mp4 \
    --max_frames 50
```

**预处理后的目录结构**：
```
datas/
├── 张三.jpg
├── 张三.mp4
├── 张三/              # 自动创建的帧文件夹
│   ├── frame_000000.jpg
│   ├── frame_000001.jpg
│   └── ...
├── 李四.jpg
├── 李四.mp4
└── 李四/
    ├── frame_000000.jpg
    └── ...
```

**预处理参数**：
- `--frame_interval`: 帧间隔（1=每帧都提取，2=每隔一帧提取）
- `--max_frames`: 每个视频最大提取帧数
- `--force_rebuild`: 强制重新提取（即使文件夹已存在）

### 3. 开始训练

```bash
# 基本训练（会自动使用已提取的帧图片）
python train/train.py \
    --data_dir train/datas \
    --output_dir checkpoints \
    --epochs 50 \
    --batch_size 16 \
    --lr 1e-4
```

**注意**：如果已预处理视频（步骤2），数据集会自动使用帧图片，训练速度会更快。如果没有预处理，数据集会从视频中实时提取帧（较慢）。

# 使用ArcFace损失
python train/train.py \
    --data_dir train/datas \
    --output_dir checkpoints \
    --epochs 50 \
    --use_arcface

# 指定GPU
python train/train.py \
    --data_dir train/datas \
    --device cuda \
    --batch_size 32
```

### 3. 训练参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--data_dir` | 数据目录 | 必需 |
| `--output_dir` | 输出目录 | `checkpoints` |
| `--batch_size` | 批次大小 | `16` |
| `--epochs` | 训练轮数 | `50` |
| `--lr` | 学习率 | `1e-4` |
| `--image_size` | 图像尺寸 | `224` |
| `--feature_dim` | 特征维度 | `512` |
| `--use_arcface` | 使用ArcFace损失 | `False` |
| `--use_contrastive` | 使用对比损失 | `True` |
| `--device` | 计算设备 | `cuda` |

### 4. 监控训练

训练过程会：
- 在终端显示进度和损失
- 在 `checkpoints/logs` 生成 TensorBoard 日志

查看训练曲线：
```bash
tensorboard --logdir checkpoints/logs
```

## 测试模型

### 基本测试

```bash
python train/test.py \
    --checkpoint checkpoints/best_model.ckpt \
    --query path/to/angle_face.jpg \
    --gallery path/to/front_faces/ \
    --top_k 5 \
    --threshold 0.6
```

### 测试参数

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `--checkpoint` | 模型检查点 | 必需 |
| `--query` | 查询图像（多角度人脸） | 必需 |
| `--gallery` | 图库目录（正脸图片） | 必需 |
| `--top_k` | 返回top_k个结果 | `5` |
| `--threshold` | 相似度阈值 | `0.6` |

## 使用训练好的模型

### Python代码使用

```python
import torch
from train.model import MultiAngleFaceModel
from PIL import Image
import numpy as np

# 加载模型
device = torch.device('cuda' if torch.cuda.is_available() else 'cpu')
checkpoint = torch.load('checkpoints/best_model.ckpt', map_location=device)

model = MultiAngleFaceModel(feature_dim=512).to(device)
model.load_state_dict(checkpoint['model_state_dict'])
model.eval()

# 提取特征
def extract_feature(image_path):
    # 加载和预处理图像（参考test.py）
    image_tensor = load_image(image_path).to(device)
    feature = model.extract_feature(image_tensor)
    return feature

# 对比特征
front_feature = extract_feature('front.jpg')
angle_feature = extract_feature('angle.jpg')

# 计算相似度
similarity = F.cosine_similarity(
    front_feature.unsqueeze(0),
    angle_feature.unsqueeze(0)
).item()

print(f"相似度: {similarity:.4f}")
```

## 损失函数说明

### 1. 交叉熵损失（ArcFace）

```python
# 使用ArcFace margin增强类间分离
loss_ce = CrossEntropyLoss(arcface_logits, labels)
```

**作用**：
- 确保同一人的不同角度特征在特征空间中聚集
- 不同人的特征分离

### 2. 对比损失

```python
# 正脸-多角度对拉近，不同人推远
loss_contrastive = ContrastiveLoss(front_features, angle_features, labels)
```

**作用**：
- 直接优化正脸和多角度特征的相似度
- 增强角度不变性

### 3. 特征一致性损失

```python
# 同一人的正脸和多角度特征应该相似
consistency_loss = 1.0 - cosine_similarity(front_features, angle_features).mean()
```

**作用**：
- 确保同一人的正脸和多角度特征对齐

## 训练技巧

### 1. 学习率调整

```bash
# 初始学习率
--lr 1e-4

# 如果损失不下降，尝试降低学习率
--lr 5e-5
```

### 2. 批次大小

```bash
# GPU显存充足
--batch_size 32

# GPU显存有限
--batch_size 8
```

### 3. 数据增强

数据集会自动：
- 从视频中随机采样帧
- 检测并裁剪人脸
- 归一化处理

### 4. Few-shot学习

如果数据量少：
- 使用预训练的CLIP（冻结参数）
- 只训练角度不变性模块
- 降低学习率：`--lr 1e-5`

## 性能优化

### 1. 使用FP16

```python
# 在train.py中添加
from torch.cuda.amp import autocast, GradScaler

scaler = GradScaler()
with autocast():
    # 前向传播
    ...
```

### 2. 梯度累积

如果批次大小受限，可以使用梯度累积：
```python
accumulation_steps = 4
loss = loss / accumulation_steps
loss.backward()
if (batch_idx + 1) % accumulation_steps == 0:
    optimizer.step()
```

## 常见问题

### Q1: 训练损失不下降

**解决方案**：
1. 检查数据质量（人脸检测是否正常）
2. 降低学习率：`--lr 5e-5`
3. 增加批次大小
4. 检查数据标注是否正确

### Q2: 验证准确率低

**解决方案**：
1. 增加训练数据
2. 调整损失函数权重
3. 使用ArcFace损失：`--use_arcface`
4. 增加训练轮数

### Q3: 显存不足

**解决方案**：
1. 减小批次大小：`--batch_size 8`
2. 减小图像尺寸：`--image_size 160`
3. 使用梯度累积
4. 使用FP16

### Q4: 模型过拟合

**解决方案**：
1. 增加数据增强
2. 增加dropout
3. 使用权重衰减：`--weight_decay 1e-4`
4. 早停（Early Stopping）

## 输出文件

训练完成后会生成：

```
checkpoints/
├── best_model.ckpt          # 最佳模型（验证准确率最高）
├── checkpoint_epoch_10.ckpt # 定期保存的检查点
├── checkpoint_epoch_20.ckpt
└── logs/                    # TensorBoard日志
    ├── events.out.tfevents.xxx
    └── ...
```

## 总结

- ✅ **特征对比方案更适合**：只有正脸，识别多角度
- ✅ **使用CLIP作为backbone**：强大的视觉理解能力
- ✅ **角度不变性模块**：学习角度不变的特征表示
- ✅ **组合损失函数**：交叉熵 + ArcFace + 对比损失
- ✅ **支持few-shot**：只需少量正脸样本即可工作

开始训练，享受多角度人脸识别的强大功能！

