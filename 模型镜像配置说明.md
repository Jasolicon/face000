# 模型镜像配置说明

## 概述

项目已自动配置模型下载镜像，用于加速模型下载（特别是在中国大陆地区）。

## 自动配置

代码会在加载模型前自动设置镜像环境变量：

- **HuggingFace 镜像**: `https://hf-mirror.com`
- **自动设置**: 如果环境变量未设置，会自动设置
- **设置时机**: 在导入 `timm`、`huggingface_hub` 等库之前设置

### 关键点

⚠️ **重要**: `HF_ENDPOINT` 环境变量必须在导入 `timm` 之前设置！

代码已在以下位置自动设置：
- `feature_extractor.py` - 文件顶部（导入 timm 前）
- `train_transformer/dataset.py` - 文件顶部
- `train_transformer/train.py` - 文件顶部
- `train/model.py` - 文件顶部
- 其他使用 `timm` 的文件

## 支持的模型

以下模型的下载会自动使用镜像：

1. **DINOv2 模型** (通过 `torch.hub.load`)
   - `dinov2_vits14` (小模型，384维)
   - `dinov2_vitb14` (中等模型，768维)
   - `dinov2_vitl14` (大模型，1024维)
   - `dinov2_vitg14` (超大模型，1536维)

2. **InsightFace 模型** (通过 `FaceAnalysis`)
   - `buffalo_l` (推荐)
   - `buffalo_s` (小版本)
   - `buffalo_m` (中等版本)

## 配置位置

镜像设置在以下文件中自动应用：

- `feature_extractor.py` - DINOv2 和 ArcFace 模型加载
- `utils.py` - InsightFace 检测器加载
- `download_dinov2.py` - DINOv2 模型下载脚本
- `download_insightface.py` - InsightFace 模型下载脚本

## 手动配置

如果需要使用其他镜像或自定义配置：

### 方法 1: 设置环境变量

```bash
# Linux/Mac
export HF_ENDPOINT=https://hf-mirror.com

# Windows (PowerShell)
$env:HF_ENDPOINT="https://hf-mirror.com"

# Windows (CMD)
set HF_ENDPOINT=https://hf-mirror.com
```

### 方法 2: 修改 model_utils.py

编辑 `model_utils.py` 中的 `setup_model_mirrors()` 函数：

```python
def setup_model_mirrors():
    # 使用自定义镜像
    if 'HF_ENDPOINT' not in os.environ:
        os.environ['HF_ENDPOINT'] = 'https://your-custom-mirror.com'
    ...
```

## 常用镜像源

### HuggingFace 镜像

- **hf-mirror.com** (推荐，中国大陆)
  ```bash
  export HF_ENDPOINT=https://hf-mirror.com
  ```

- **其他可选镜像**:
  - `https://huggingface.co` (官方源)
  - 其他第三方镜像（根据可用性选择）

### PyTorch Hub 镜像

PyTorch Hub 主要从 GitHub 下载，可以通过以下方式加速：

1. **使用代理**:
   ```bash
   export HTTP_PROXY=http://proxy.example.com:8080
   export HTTPS_PROXY=http://proxy.example.com:8080
   ```

2. **使用 GitHub 镜像**:
   - 可以设置 `GITHUB_MIRROR` 环境变量（如果支持）

## 验证配置

### 检查环境变量

```bash
# Linux/Mac
echo $HF_ENDPOINT

# Windows (PowerShell)
echo $env:HF_ENDPOINT

# Windows (CMD)
echo %HF_ENDPOINT%
```

### 运行测试脚本

```bash
# 测试镜像配置
python model_utils.py
```

这会显示：
- 当前镜像设置
- 环境变量状态
- 配置建议

## 使用示例

### 正常使用（自动配置）

```bash
# 直接运行，会自动设置镜像
python train_transformer/train.py ...

# 下载模型，会自动使用镜像
python download_dinov2.py --save_dir ./models
```

### 自定义镜像

```bash
# 使用自定义镜像
export HF_ENDPOINT=https://your-mirror.com
python train_transformer/train.py ...
```

## Docker 环境

在 Docker 容器中使用时，可以在 Dockerfile 中设置：

```dockerfile
# 设置镜像环境变量
ENV HF_ENDPOINT=https://hf-mirror.com
```

或在 docker-compose.yml 中：

```yaml
environment:
  - HF_ENDPOINT=https://hf-mirror.com
```

## 故障排除

### Q1: timm 库仍然连接 huggingface.co

**问题**: 即使设置了 `HF_ENDPOINT`，`timm` 仍然尝试连接 `huggingface.co`

**解决方案**:
1. **确保在导入 timm 之前设置环境变量**（代码已自动处理）
   ```python
   import os
   os.environ['HF_ENDPOINT'] = 'https://hf-mirror.com'
   import timm  # 必须在设置环境变量之后导入
   ```

2. **手动设置环境变量**（在运行脚本前）:
   ```bash
   export HF_ENDPOINT=https://hf-mirror.com
   python train_transformer/train.py ...
   ```

3. **检查环境变量是否生效**:
   ```python
   import os
   print(os.environ.get('HF_ENDPOINT'))  # 应该显示 https://hf-mirror.com
   ```

4. **如果仍然失败，尝试使用代理**:
   ```bash
   export HTTP_PROXY=http://proxy.example.com:8080
   export HTTPS_PROXY=http://proxy.example.com:8080
   ```

### Q2: 镜像不生效

**解决方案**:
1. 检查环境变量是否设置：`echo $HF_ENDPOINT`
2. 确保在模型加载前设置（代码已自动处理）
3. 重启 Python 进程
4. 确保在导入 `timm` 之前设置

### Q3: 下载仍然很慢

**解决方案**:
1. 尝试其他镜像源
2. 使用代理
3. 手动下载模型到缓存目录
4. 增加超时时间：`export HF_HUB_DOWNLOAD_TIMEOUT=600`

### Q4: 镜像连接失败

**解决方案**:
1. 检查网络连接
2. 尝试官方源：`export HF_ENDPOINT=https://huggingface.co`
3. 使用代理
4. 检查镜像是否可用：访问 `https://hf-mirror.com` 测试

## 技术细节

### 环境变量说明

- **HF_ENDPOINT**: HuggingFace API 端点
  - 用于通过 HuggingFace 下载的模型
  - DINOv2 可能通过此端点下载

### 设置时机

镜像环境变量在以下时机设置：
1. 模块导入时（`feature_extractor.py`）
2. 函数调用时（`utils.py`, `download_*.py`）
3. 模型加载前（所有相关函数）

### 优先级

1. 如果环境变量已设置，使用现有值
2. 如果未设置，自动设置为 `https://hf-mirror.com`
3. 可以通过 `model_utils.py` 自定义

## 总结

✅ **自动配置**: 代码会自动设置镜像，无需手动操作

✅ **灵活配置**: 支持通过环境变量或代码自定义

✅ **跨平台**: 支持 Windows、Linux、macOS

✅ **向后兼容**: 如果镜像不可用，会回退到官方源

