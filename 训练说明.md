# è®­ç»ƒè¯´æ˜ - æ˜¯å¦éœ€è¦è®­ç»ƒï¼Ÿ

## ç®€çŸ­å›ç­”

**ä¸éœ€è¦è®­ç»ƒï¼** ç³»ç»Ÿä½¿ç”¨çš„æ˜¯**é¢„è®­ç»ƒæ¨¡å‹**ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚

## è¯¦ç»†è¯´æ˜

### å½“å‰ç³»ç»Ÿä½¿ç”¨çš„æ¨¡å‹ï¼ˆå…¨éƒ¨ä¸ºé¢„è®­ç»ƒï¼‰

1. **Stable Diffusion v1.5** - é¢„è®­ç»ƒç”Ÿæˆæ¨¡å‹
   - æ¨¡å‹ID: `runwayml/stable-diffusion-v1-5`
   - çŠ¶æ€: âœ… å·²é¢„è®­ç»ƒï¼Œç›´æ¥ä½¿ç”¨

2. **ControlNet OpenPose** - é¢„è®­ç»ƒæ§åˆ¶æ¨¡å‹
   - æ¨¡å‹ID: `lllyasviel/sd-controlnet-openpose`
   - çŠ¶æ€: âœ… å·²é¢„è®­ç»ƒï¼Œç›´æ¥ä½¿ç”¨

3. **OpenPose æ£€æµ‹å™¨** - é¢„è®­ç»ƒå…³é”®ç‚¹æ£€æµ‹
   - æ¨¡å‹ID: `lllyasviel/Annotators`
   - çŠ¶æ€: âœ… å·²é¢„è®­ç»ƒï¼Œç›´æ¥ä½¿ç”¨

4. **MTCNN äººè„¸æ£€æµ‹å™¨** - é¢„è®­ç»ƒæ£€æµ‹æ¨¡å‹
   - æ¥è‡ª `facenet-pytorch`
   - çŠ¶æ€: âœ… å·²é¢„è®­ç»ƒï¼Œç›´æ¥ä½¿ç”¨

### ä¸ºä»€ä¹ˆä¸éœ€è¦è®­ç»ƒï¼Ÿ

è¿™äº›æ¨¡å‹å·²ç»åœ¨å¤§é‡æ•°æ®ä¸Šè¿›è¡Œäº†è®­ç»ƒï¼š
- **Stable Diffusion**: åœ¨æ•°åäº¿å›¾åƒä¸Šè®­ç»ƒ
- **ControlNet**: åœ¨æ•°ç™¾ä¸‡å›¾åƒ-å§¿æ€å¯¹æ•°æ®ä¸Šè®­ç»ƒ
- **OpenPose**: åœ¨äººä½“å§¿æ€æ•°æ®é›†ä¸Šè®­ç»ƒ
- **MTCNN**: åœ¨ WIDER FACE æ•°æ®é›†ä¸Šè®­ç»ƒ

**è¿™äº›é¢„è®­ç»ƒæ¨¡å‹å·²ç»è¶³å¤Ÿå¼ºå¤§ï¼Œå¯ä»¥ç›´æ¥ç”¨äºç”Ÿæˆå¤šå§¿æ€äººè„¸ï¼**

## ç›´æ¥ä½¿ç”¨æ­¥éª¤

### 1. å®‰è£…ä¾èµ–

```bash
pip install diffusers controlnet-aux>=0.0.10 accelerate
```

### 2. è¿è¡Œä»£ç 

```bash
python generate_multi_pose_faces.py --input face.jpg --output-dir output
```

### 3. å®Œæˆï¼

æ¨¡å‹ä¼šè‡ªåŠ¨ä¸‹è½½ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰ï¼Œç„¶åç›´æ¥ç”Ÿæˆå¤šå§¿æ€äººè„¸ã€‚

## ä½•æ—¶éœ€è¦è®­ç»ƒ/å¾®è°ƒï¼Ÿ

è™½ç„¶ä¸éœ€è¦è®­ç»ƒï¼Œä½†åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½æƒ³è¦è¿›è¡Œ**å¾®è°ƒï¼ˆFine-tuningï¼‰**ï¼š

### åœºæ™¯ 1: ç”Ÿæˆç‰¹å®šé£æ ¼çš„äººè„¸

å¦‚æœä½ æƒ³è¦ç”Ÿæˆç‰¹å®šé£æ ¼ï¼ˆå¦‚åŠ¨æ¼«é£æ ¼ã€å†™å®é£æ ¼ç­‰ï¼‰ï¼Œå¯ä»¥ï¼š
- ä½¿ç”¨ LoRA å¾®è°ƒ
- è®­ç»ƒè‡ªå®šä¹‰ ControlNet

### åœºæ™¯ 2: æé«˜ç”Ÿæˆè´¨é‡

å¦‚æœç”Ÿæˆçš„äººè„¸è´¨é‡ä¸å¤Ÿå¥½ï¼Œå¯ä»¥ï¼š
- ä½¿ç”¨æ›´å¤šæ¨ç†æ­¥æ•°ï¼ˆ`num_inference_steps=30-50`ï¼‰
- ä¼˜åŒ–æç¤ºè¯ï¼ˆpromptï¼‰
- è°ƒæ•´æ§åˆ¶å¼ºåº¦ï¼ˆ`controlnet_conditioning_scale`ï¼‰

### åœºæ™¯ 3: é€‚åº”ç‰¹å®šæ•°æ®é›†

å¦‚æœä½ æœ‰å¤§é‡ç‰¹å®šç±»å‹çš„äººè„¸æ•°æ®ï¼Œå¯ä»¥ï¼š
- å¾®è°ƒ Stable Diffusion
- è®­ç»ƒ LoRA é€‚é…å™¨

## å¯é€‰ï¼šLoRA å¾®è°ƒï¼ˆé«˜çº§ï¼‰

å¦‚æœä½ æƒ³è¦ç”Ÿæˆç‰¹å®šé£æ ¼æˆ–æé«˜è´¨é‡ï¼Œå¯ä»¥ä½¿ç”¨ LoRA å¾®è°ƒï¼š

### ä»€ä¹ˆæ˜¯ LoRAï¼Ÿ

**LoRA (Low-Rank Adaptation)** æ˜¯ä¸€ç§å‚æ•°é«˜æ•ˆçš„å¾®è°ƒæ–¹æ³•ï¼š
- åªè®­ç»ƒå°‘é‡å‚æ•°ï¼ˆçº¦ 1-5%ï¼‰
- è®­ç»ƒé€Ÿåº¦å¿«ï¼ˆå‡ å°æ—¶åˆ°å‡ å¤©ï¼‰
- æ˜¾å­˜å ç”¨å°ï¼ˆ8-16GBï¼‰
- å¯ä»¥ç»„åˆå¤šä¸ª LoRA

### LoRA å¾®è°ƒæ­¥éª¤ï¼ˆå¯é€‰ï¼‰

#### 1. å‡†å¤‡æ•°æ®

```python
# å‡†å¤‡è®­ç»ƒæ•°æ®ï¼ˆæ­£é¢äººè„¸å›¾åƒï¼‰
train_images = [
    "person1_front.jpg",
    "person2_front.jpg",
    ...
]
```

#### 2. å®‰è£…è®­ç»ƒä¾èµ–

```bash
pip install peft accelerate datasets
```

#### 3. è®­ç»ƒ LoRA

```python
from diffusers import StableDiffusionControlNetPipeline
from peft import LoraConfig, get_peft_model

# åŠ è½½æ¨¡å‹
pipe = StableDiffusionControlNetPipeline.from_pretrained(...)

# é…ç½® LoRA
lora_config = LoraConfig(
    r=16,  # LoRA ç§©
    lora_alpha=32,
    target_modules=["to_k", "to_q", "to_v", "to_out.0"]
)

# åº”ç”¨ LoRA
pipe.unet = get_peft_model(pipe.unet, lora_config)

# è®­ç»ƒ...
```

### ä½¿ç”¨è®­ç»ƒå¥½çš„ LoRA

```python
from diffusers import StableDiffusionControlNetPipeline

pipe = StableDiffusionControlNetPipeline.from_pretrained(...)
pipe.load_lora_weights("path/to/lora.safetensors")

# ä½¿ç”¨ LoRA ç”Ÿæˆ
generated_image = pipe(...)
```

## æ¨èæ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ç›´æ¥ä½¿ç”¨ï¼ˆæ¨èï¼‰â­

**é€‚ç”¨äº**: å¤§å¤šæ•°ç”¨æˆ·

```bash
# ç›´æ¥ä½¿ç”¨ï¼Œæ— éœ€è®­ç»ƒ
python generate_multi_pose_faces.py --input face.jpg
```

**ä¼˜ç‚¹**:
- âœ… ç®€å•å¿«é€Ÿ
- âœ… æ— éœ€è®­ç»ƒ
- âœ… æ•ˆæœå·²ç»å¾ˆå¥½

### æ–¹æ¡ˆ 2: å‚æ•°è°ƒä¼˜

**é€‚ç”¨äº**: æƒ³è¦æ›´å¥½æ•ˆæœçš„ç”¨æˆ·

```python
generator = MultiPoseFaceGenerator()

output_paths = generator.generate_multi_pose_faces(
    input_image_path="face.jpg",
    num_inference_steps=30,  # å¢åŠ æ­¥æ•°
    prompt="a high quality portrait photo of a person, detailed face, realistic, professional photography, 8k, uhd"
)
```

**ä¼˜ç‚¹**:
- âœ… æ— éœ€è®­ç»ƒ
- âœ… å¯ä»¥æå‡è´¨é‡
- âœ… åªéœ€è°ƒæ•´å‚æ•°

### æ–¹æ¡ˆ 3: LoRA å¾®è°ƒï¼ˆé«˜çº§ï¼‰

**é€‚ç”¨äº**: éœ€è¦ç‰¹å®šé£æ ¼æˆ–å¤§é‡æ•°æ®çš„ç”¨æˆ·

```python
# è®­ç»ƒ LoRAï¼ˆéœ€è¦å‡†å¤‡æ•°æ®ï¼‰
train_lora(...)

# ä½¿ç”¨ LoRA
pipe.load_lora_weights("lora.safetensors")
```

**ä¼˜ç‚¹**:
- âœ… å¯ä»¥ç”Ÿæˆç‰¹å®šé£æ ¼
- âœ… å‚æ•°é«˜æ•ˆ
- âš ï¸ éœ€è¦è®­ç»ƒæ—¶é—´

## æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | è®­ç»ƒæ—¶é—´ | æ˜¾å­˜éœ€æ±‚ | æ•ˆæœ | æ¨èåº¦ |
|------|----------|----------|------|--------|
| **ç›´æ¥ä½¿ç”¨** | 0 | 8GB | â­â­â­â­ | â­â­â­â­â­ |
| **å‚æ•°è°ƒä¼˜** | 0 | 8GB | â­â­â­â­â­ | â­â­â­â­ |
| **LoRA å¾®è°ƒ** | å‡ å°æ—¶-å‡ å¤© | 16GB | â­â­â­â­â­ | â­â­â­ |

## æ€»ç»“

### âœ… ä¸éœ€è¦è®­ç»ƒçš„æƒ…å†µ

- **å¤§å¤šæ•°ç”¨æˆ·**: ç›´æ¥ä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹å³å¯
- **å¿«é€Ÿæµ‹è¯•**: æ— éœ€è®­ç»ƒï¼Œç«‹å³å¯ç”¨
- **ä¸€èˆ¬éœ€æ±‚**: é¢„è®­ç»ƒæ¨¡å‹æ•ˆæœå·²ç»å¾ˆå¥½

### ğŸ”§ éœ€è¦å¾®è°ƒçš„æƒ…å†µ

- **ç‰¹å®šé£æ ¼**: éœ€è¦ç”Ÿæˆç‰¹å®šé£æ ¼çš„äººè„¸
- **å¤§é‡æ•°æ®**: æœ‰å¤§é‡ç‰¹å®šç±»å‹çš„äººè„¸æ•°æ®
- **æè‡´è´¨é‡**: éœ€è¦æœ€é«˜è´¨é‡çš„ç”Ÿæˆæ•ˆæœ

### ğŸ’¡ å»ºè®®

1. **å…ˆå°è¯•ç›´æ¥ä½¿ç”¨**: å¤§å¤šæ•°æƒ…å†µä¸‹æ•ˆæœå·²ç»å¾ˆå¥½
2. **å‚æ•°è°ƒä¼˜**: å¦‚æœæ•ˆæœä¸å¤Ÿå¥½ï¼Œå…ˆå°è¯•è°ƒæ•´å‚æ•°
3. **æœ€åè€ƒè™‘è®­ç»ƒ**: åªæœ‰åœ¨ç¡®å®éœ€è¦æ—¶æ‰è¿›è¡Œ LoRA å¾®è°ƒ

## å¿«é€Ÿå¼€å§‹ï¼ˆæ— éœ€è®­ç»ƒï¼‰

```bash
# 1. å®‰è£…ä¾èµ–
pip install diffusers controlnet-aux>=0.0.10 accelerate

# 2. è¿è¡Œï¼ˆé¦–æ¬¡ä¼šè‡ªåŠ¨ä¸‹è½½æ¨¡å‹ï¼‰
python generate_multi_pose_faces.py --input your_face.jpg --output-dir output

# 3. å®Œæˆï¼
```

**å°±è¿™ä¹ˆç®€å•ï¼æ— éœ€è®­ç»ƒï¼** ğŸ‰

