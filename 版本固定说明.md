# 版本固定说明

## 固定版本策略

本项目已将所有依赖版本固定，特别是 **torch 固定为 2.2.2**，其他依赖根据此版本进行控制。

## 核心版本（固定）

### PyTorch 核心库

```
torch==2.2.2
torchvision==0.17.2
```

**重要**: 这两个版本必须严格匹配，不能单独升级或降级。

### 版本对应关系

| torch | torchvision | 状态 |
|-------|------------|------|
| 2.2.2 | 0.17.2 | ✅ **固定版本** |

## 安装方法

### 方法 1: 使用 requirements.txt（推荐）

```bash
pip install -r requirements.txt
```

### 方法 2: 手动安装

#### CUDA 版本（GPU）

```bash
# CUDA 11.8
pip install torch==2.2.2 torchvision==0.17.2 --index-url https://download.pytorch.org/whl/cu118

# CUDA 12.1
pip install torch==2.2.2 torchvision==0.17.2 --index-url https://download.pytorch.org/whl/cu121
```

#### CPU 版本

```bash
pip install torch==2.2.2 torchvision==0.17.2 --index-url https://download.pytorch.org/whl/cpu
```

### 方法 3: 使用 conda

```bash
conda install pytorch==2.2.2 torchvision==0.17.2 -c pytorch
```

### 方法 4: 使用修复脚本

```bash
python fix_versions.py
```

## 其他依赖版本（基于 torch 2.2.2）

### AI 模型库

```
transformers>=4.30.0,<5.0.0
diffusers>=0.21.0,<1.0.0
controlnet-aux>=0.0.10
accelerate>=0.20.0
```

### 人脸检测和特征提取

```
facenet-pytorch>=2.5.3
insightface>=0.7.3
timm>=0.9.0
```

### 基础库

```
numpy>=1.24.0,<2.0.0
Pillow>=10.0.0
opencv-python>=4.8.0
scikit-learn>=1.3.0
onnxruntime>=1.15.0
```

## 版本兼容性检查

### 自动检查

代码会自动检查版本兼容性：

```python
# generate_multi_pose_faces.py 会自动检查
from generate_multi_pose_faces import MultiPoseFaceGenerator
# 如果版本不匹配，会显示警告
```

### 手动检查

```python
import torch
import torchvision

print(f"torch: {torch.__version__}")
print(f"torchvision: {torchvision.__version__}")

# 应该输出:
# torch: 2.2.2
# torchvision: 0.17.2
```

## 为什么固定版本？

### 1. 稳定性

- 避免版本不兼容导致的错误
- 确保所有环境运行一致
- 减少调试时间

### 2. 兼容性

- torch 2.2.2 是稳定版本
- 与 diffusers、transformers 等库兼容良好
- 支持最新的 CUDA 版本

### 3. 可重现性

- 所有开发者使用相同版本
- 生产环境与开发环境一致
- 便于问题排查

## 升级策略

### 何时升级？

1. **安全漏洞**: 发现严重安全漏洞
2. **新功能需求**: 需要新版本的功能
3. **性能优化**: 新版本有显著性能提升
4. **依赖冲突**: 其他库要求新版本

### 如何升级？

1. **测试兼容性**: 在测试环境验证
2. **更新 requirements.txt**: 修改版本号
3. **更新文档**: 更新相关说明
4. **通知团队**: 告知所有开发者

### 升级检查清单

- [ ] 测试所有功能是否正常
- [ ] 检查性能是否有变化
- [ ] 验证与其他库的兼容性
- [ ] 更新文档和脚本
- [ ] 通知团队成员

## 常见问题

### Q1: 可以只升级 torch 吗？

**不可以**。torch 和 torchvision 必须版本匹配。如果只升级 torch，会导致兼容性错误。

### Q2: 可以使用其他版本的 torch 吗？

**不推荐**。项目已固定 torch==2.2.2，使用其他版本可能导致：
- 版本不兼容错误
- 功能异常
- 性能问题

### Q3: 如何检查当前版本？

```bash
python -c "import torch; import torchvision; print(f'torch: {torch.__version__}'); print(f'torchvision: {torchvision.__version__}')"
```

### Q4: 版本不匹配怎么办？

运行修复脚本：
```bash
python fix_versions.py
```

或手动重新安装：
```bash
pip uninstall torch torchvision -y
pip install torch==2.2.2 torchvision==0.17.2
```

## 版本历史

| 日期 | torch | torchvision | 说明 |
|------|-------|------------|------|
| 2024-XX-XX | 2.2.2 | 0.17.2 | 固定版本 |

## 相关文件

- `requirements.txt` - 依赖版本定义
- `fix_versions.py` - 版本修复脚本
- `generate_multi_pose_faces.py` - 版本检查逻辑
- `修复版本兼容性问题.md` - 详细问题解决方案

## 总结

- ✅ **torch 固定为 2.2.2**
- ✅ **torchvision 固定为 0.17.2**
- ✅ **其他依赖根据兼容性控制**
- ✅ **自动版本检查**
- ✅ **提供修复工具**

遵循这些规则可以确保项目稳定运行！

