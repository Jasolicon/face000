# 姓名信息缺失问题分析

## 问题现象

在 `features/metadata.json` 中，所有记录的 `person_name` 字段都是 `null`：

```json
{
  "image_path": "C:\\AIXLAB\\DATA\\smartschool_student_face_NX\\NX_standard\\x杜禹臻.jpg",
  "person_id": null,
  "person_name": null,  // ❌ 应该包含姓名
  "feature_dim": 768,
  "index": 0
}
```

## 问题原因

### 原因1: `register_batch` 方法未传递姓名参数

查看 `main.py` 的 `register_batch` 方法（第84-105行）：

```python
def register_batch(self, image_paths, person_ids=None, person_names=None, show_progress=True):
    results = []
    total = len(image_paths)
    
    for idx, img_path in enumerate(image_paths):
        if show_progress:
            print(f"处理进度: {idx+1}/{total} - {os.path.basename(img_path)}", end='\r')
        
        success, message = self.register_image(img_path)  # ❌ 没有传递person_id和person_name
        results.append((img_path, success, message))
```

**问题**: `register_batch` 方法虽然接收了 `person_ids` 和 `person_names` 参数，但在调用 `register_image` 时**没有传递这些参数**！

### 原因2: 文件名包含姓名但未提取

从 `metadata.json` 可以看到，图像文件名本身就包含姓名：
- `x杜禹臻.jpg` → 姓名应该是 `x杜禹臻`
- `乔沐阳.jpg` → 姓名应该是 `乔沐阳`
- `于菟.jpg` → 姓名应该是 `于菟`

但注册时没有从文件名中提取姓名。

## 解决方案

### 方案1: 修复 `register_batch` 方法（推荐）

修改 `main.py` 中的 `register_batch` 方法，正确传递姓名参数：

```python
def register_batch(self, image_paths, person_ids=None, person_names=None, show_progress=True):
    results = []
    total = len(image_paths)
    
    # 处理默认值
    if person_ids is None:
        person_ids = [None] * len(image_paths)
    if person_names is None:
        # 从文件名提取姓名
        person_names = [os.path.basename(img_path).split('.')[0] for img_path in image_paths]
    
    for idx, img_path in enumerate(image_paths):
        if show_progress:
            print(f"处理进度: {idx+1}/{total} - {os.path.basename(img_path)}", end='\r')
        
        # ✅ 传递person_id和person_name
        success, message = self.register_image(
            img_path, 
            person_id=person_ids[idx] if idx < len(person_ids) else None,
            person_name=person_names[idx] if idx < len(person_names) else None
        )
        results.append((img_path, success, message))
    
    if show_progress:
        print()  # 换行
    
    return results
```

### 方案2: 在 `register_image` 中自动提取姓名

修改 `register_image` 方法，如果未提供 `person_name`，则从文件名提取：

```python
def register_image(self, image_path, person_id=None, person_name=None):
    """
    注册图像（检测人脸、提取特征并保存）
    
    Args:
        image_path: 图像路径
        person_id: 人员ID（可选）
        person_name: 人员姓名（可选），如果为None则从文件名提取
    """
    # 如果未提供person_name，从文件名提取
    if person_name is None:
        person_name = os.path.basename(image_path).split('.')[0]
    
    # ... 其余代码
```

### 方案3: 批量更新现有数据

如果已经有数据但没有姓名，可以编写脚本批量更新：

```python
from feature_manager import FeatureManager
import os

manager = FeatureManager(storage_dir='features')
features, metadata = manager.get_all_features()

# 更新每个记录的person_name
for i, meta in enumerate(metadata):
    if meta.get('person_name') is None:
        # 从image_path提取姓名
        image_path = meta['image_path']
        person_name = os.path.basename(image_path).split('.')[0]
        meta['person_name'] = person_name
        print(f"更新 {i}: {person_name}")

# 保存更新后的元数据
manager._save_to_disk()
```

## 当前代码的问题

### 问题1: `register_batch` 未传递参数

**位置**: `main.py` 第98行

**当前代码**:
```python
success, message = self.register_image(img_path)  # ❌ 缺少参数
```

**应该改为**:
```python
success, message = self.register_image(
    img_path,
    person_id=person_ids[idx] if person_ids and idx < len(person_ids) else None,
    person_name=person_names[idx] if person_names and idx < len(person_names) else None
)
```

### 问题2: 文件名提取逻辑不一致

- `batch_process.py` 第64行：使用 `img.stem` 提取姓名 ✅
- `main.py` 第178行：使用 `os.path.basename(img_path).split('.')[0]` 提取姓名 ✅
- 但 `register_batch` 没有使用这些提取的姓名 ❌

## 修复建议

1. **立即修复**: 修改 `register_batch` 方法，正确传递 `person_id` 和 `person_name`
2. **增强功能**: 在 `register_image` 中添加自动提取姓名的逻辑
3. **数据修复**: 编写脚本批量更新现有数据的姓名信息

## 验证修复

修复后，重新注册图像时，`metadata.json` 应该包含姓名：

```json
{
  "image_path": "C:\\AIXLAB\\DATA\\smartschool_student_face_NX\\NX_standard\\x杜禹臻.jpg",
  "person_id": "person_0001",
  "person_name": "x杜禹臻",  // ✅ 现在有姓名了
  "feature_dim": 768,
  "index": 0
}
```

